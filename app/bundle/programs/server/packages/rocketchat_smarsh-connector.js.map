{"version":3,"sources":["meteor://ðŸ’»app/packages/rocketchat:smarsh-connector/lib/rocketchat.js","meteor://ðŸ’»app/packages/rocketchat:smarsh-connector/server/settings.js","meteor://ðŸ’»app/packages/rocketchat:smarsh-connector/server/models/SmarshHistory.js","meteor://ðŸ’»app/packages/rocketchat:smarsh-connector/server/functions/sendEmail.js","meteor://ðŸ’»app/packages/rocketchat:smarsh-connector/server/functions/generateEml.js","meteor://ðŸ’»app/packages/rocketchat:smarsh-connector/server/startup.js"],"names":["RocketChat","smarsh","moment","module","watch","require","default","v","settings","addGroup","addSettings","add","type","i18nLabel","enableQuery","_id","value","$exists","$ne","placeholder","zoneValues","tz","names","map","_timeZonesToSettings","name","key","values","History","models","_Base","constructor","_","Mailer","sendEmail","data","attachments","each","files","fileId","file","Uploads","findOneById","store","rs","UploadFS","getStore","getReadStream","push","filename","streamSource","sendNoWrap","to","get","from","subject","html","body","start","end","opentr","closetr","open20td","open60td","closetd","_getLink","attachment","url","title_link","replace","Meteor","public","sandstorm","match","absoluteUrl","__meteor_runtime_config__","ROOT_URL_PATH_PREFIX","generateEml","defer","smarshMissingEmail","timeZone","Rooms","find","forEach","room","smarshHistory","findOne","query","rid","ts","$gt","lastRan","date","Date","rows","users","msgs","time","diff","usernames","join","Messages","message","format","sender","Users","u","indexOf","emails","address","t","messageType","MessageTypes","getType","TAPi18n","__","msg","title","attaches","_loopThroughMessageAttachments","a","image_url","length","result","upsert","lastResult","smarshJobName","_addSmarshSyncedCronJob","debounce","bindEnvironment","__addSmarshSyncedCronJobDebounced","SyncedCron","nextScheduledAtDate","remove","schedule","parser","text","job","startup"],"mappings":"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","file":"/packages/rocketchat_smarsh-connector.js","sourcesContent":["RocketChat.smarsh = {};\n","import moment from 'moment';\nimport 'moment-timezone';\n\nRocketChat.settings.addGroup('Smarsh', function addSettings() {\n\tthis.add('Smarsh_Enabled', false, {\n\t\ttype: 'boolean',\n\t\ti18nLabel: 'Smarsh_Enabled',\n\t\tenableQuery: {\n\t\t\t_id: 'From_Email',\n\t\t\tvalue: {\n\t\t\t\t$exists: 1,\n\t\t\t\t$ne: '',\n\t\t\t},\n\t\t},\n\t});\n\tthis.add('Smarsh_Email', '', {\n\t\ttype: 'string',\n\t\ti18nLabel: 'Smarsh_Email',\n\t\tplaceholder: 'email@domain.com',\n\t});\n\tthis.add('Smarsh_MissingEmail_Email', 'no-email@example.com', {\n\t\ttype: 'string',\n\t\ti18nLabel: 'Smarsh_MissingEmail_Email',\n\t\tplaceholder: 'no-email@example.com',\n\t});\n\n\tconst zoneValues = moment.tz.names().map(function _timeZonesToSettings(name) {\n\t\treturn {\n\t\t\tkey: name,\n\t\t\ti18nLabel: name,\n\t\t};\n\t});\n\tthis.add('Smarsh_Timezone', 'America/Los_Angeles', {\n\t\ttype: 'select',\n\t\tvalues: zoneValues,\n\t});\n\n\tthis.add('Smarsh_Interval', 'every_30_minutes', {\n\t\ttype: 'select',\n\t\tvalues: [{\n\t\t\tkey: 'every_30_seconds',\n\t\t\ti18nLabel: 'every_30_seconds',\n\t\t}, {\n\t\t\tkey: 'every_30_minutes',\n\t\t\ti18nLabel: 'every_30_minutes',\n\t\t}, {\n\t\t\tkey: 'every_1_hours',\n\t\t\ti18nLabel: 'every_hour',\n\t\t}, {\n\t\t\tkey: 'every_6_hours',\n\t\t\ti18nLabel: 'every_six_hours',\n\t\t}],\n\t\tenableQuery: {\n\t\t\t_id: 'From_Email',\n\t\t\tvalue: {\n\t\t\t\t$exists: 1,\n\t\t\t\t$ne: '',\n\t\t\t},\n\t\t},\n\t});\n});\n","RocketChat.smarsh.History = new class extends RocketChat.models._Base {\n\tconstructor() {\n\t\tsuper('smarsh_history');\n\t}\n};\n","/* globals UploadFS */\n// Expects the following details:\n// {\n// \tbody: '<table>',\n// \tsubject: 'Rocket.Chat, 17 Users, 24 Messages, 1 File, 799504 Minutes, in #random',\n//  files: ['i3nc9l3mn']\n// }\n\nimport _ from 'underscore';\nimport * as Mailer from 'meteor/rocketchat:mailer';\n\nRocketChat.smarsh.sendEmail = (data) => {\n\tconst attachments = [];\n\n\t_.each(data.files, (fileId) => {\n\t\tconst file = RocketChat.models.Uploads.findOneById(fileId);\n\t\tif (file.store === 'rocketchat_uploads' || file.store === 'fileSystem') {\n\t\t\tconst rs = UploadFS.getStore(file.store).getReadStream(fileId, file);\n\t\t\tattachments.push({\n\t\t\t\tfilename: file.name,\n\t\t\t\tstreamSource: rs,\n\t\t\t});\n\t\t}\n\t});\n\n\n\tMailer.sendNoWrap({\n\t\tto: RocketChat.settings.get('Smarsh_Email'),\n\t\tfrom: RocketChat.settings.get('From_Email'),\n\t\tsubject: data.subject,\n\t\thtml: data.body,\n\t\tattachments,\n\t});\n};\n","import _ from 'underscore';\nimport moment from 'moment';\nimport 'moment-timezone';\n\nconst start = '<table style=\"width: 100%; border: 1px solid; border-collapse: collapse; table-layout: fixed; margin-top: 10px; font-size: 12px; word-break: break-word;\"><tbody>';\nconst end = '</tbody></table>';\nconst opentr = '<tr style=\"border: 1px solid;\">';\nconst closetr = '</tr>';\nconst open20td = '<td style=\"border: 1px solid; text-align: center; width: 20%;\">';\nconst open60td = '<td style=\"border: 1px solid; text-align: left; width: 60%; padding: 0 5px;\">';\nconst closetd = '</td>';\n\nfunction _getLink(attachment) {\n\tconst url = attachment.title_link.replace(/ /g, '%20');\n\n\tif (Meteor.settings.public.sandstorm || url.match(/^(https?:)?\\/\\//i)) {\n\t\treturn url;\n\t} else {\n\t\treturn Meteor.absoluteUrl().replace(/\\/$/, '') + __meteor_runtime_config__.ROOT_URL_PATH_PREFIX + url;\n\t}\n}\n\nRocketChat.smarsh.generateEml = () => {\n\tMeteor.defer(() => {\n\t\tconst smarshMissingEmail = RocketChat.settings.get('Smarsh_MissingEmail_Email');\n\t\tconst timeZone = RocketChat.settings.get('Smarsh_Timezone');\n\n\t\tRocketChat.models.Rooms.find().forEach((room) => {\n\t\t\tconst smarshHistory = RocketChat.smarsh.History.findOne({ _id: room._id });\n\t\t\tconst query = { rid: room._id };\n\n\t\t\tif (smarshHistory) {\n\t\t\t\tquery.ts = { $gt: smarshHistory.lastRan };\n\t\t\t}\n\n\t\t\tconst date = new Date();\n\t\t\tconst rows = [];\n\t\t\tconst data = {\n\t\t\t\tusers: [],\n\t\t\t\tmsgs: 0,\n\t\t\t\tfiles: [],\n\t\t\t\ttime: smarshHistory ? moment(date).diff(moment(smarshHistory.lastRan), 'minutes') : moment(date).diff(moment(room.ts), 'minutes'),\n\t\t\t\troom: room.name ? `#${ room.name }` : `Direct Message Between: ${ room.usernames.join(' & ') }`,\n\t\t\t};\n\n\t\t\tRocketChat.models.Messages.find(query).forEach((message) => {\n\t\t\t\trows.push(opentr);\n\n\t\t\t\t// The timestamp\n\t\t\t\trows.push(open20td);\n\t\t\t\trows.push(moment(message.ts).tz(timeZone).format('YYYY-MM-DD HH-mm-ss z'));\n\t\t\t\trows.push(closetd);\n\n\t\t\t\t// The sender\n\t\t\t\trows.push(open20td);\n\t\t\t\tconst sender = RocketChat.models.Users.findOne({ _id: message.u._id });\n\t\t\t\tif (data.users.indexOf(sender._id) === -1) {\n\t\t\t\t\tdata.users.push(sender._id);\n\t\t\t\t}\n\n\t\t\t\t// Get the user's email, can be nothing if it is an unconfigured bot account (like rocket.cat)\n\t\t\t\tif (sender.emails && sender.emails[0] && sender.emails[0].address) {\n\t\t\t\t\trows.push(`${ sender.name } &lt;${ sender.emails[0].address }&gt;`);\n\t\t\t\t} else {\n\t\t\t\t\trows.push(`${ sender.name } &lt;${ smarshMissingEmail }&gt;`);\n\t\t\t\t}\n\t\t\t\trows.push(closetd);\n\n\t\t\t\t// The message\n\t\t\t\trows.push(open60td);\n\t\t\t\tdata.msgs++;\n\t\t\t\tif (message.t) {\n\t\t\t\t\tconst messageType = RocketChat.MessageTypes.getType(message);\n\t\t\t\t\tif (messageType) {\n\t\t\t\t\t\trows.push(TAPi18n.__(messageType.message, messageType.data ? messageType.data(message) : '', 'en'));\n\t\t\t\t\t} else {\n\t\t\t\t\t\trows.push(`${ message.msg } (${ message.t })`);\n\t\t\t\t\t}\n\t\t\t\t} else if (message.file) {\n\t\t\t\t\tdata.files.push(message.file._id);\n\t\t\t\t\trows.push(`${ message.attachments[0].title } (${ _getLink(message.attachments[0]) })`);\n\t\t\t\t} else if (message.attachments) {\n\t\t\t\t\tconst attaches = [];\n\t\t\t\t\t_.each(message.attachments, function _loopThroughMessageAttachments(a) {\n\t\t\t\t\t\tif (a.image_url) {\n\t\t\t\t\t\t\tattaches.push(a.image_url);\n\t\t\t\t\t\t}\n\t\t\t\t\t\t// TODO: Verify other type of attachments which need to be handled that aren't file uploads and image urls\n\t\t\t\t\t\t// } else {\n\t\t\t\t\t\t// \tconsole.log(a);\n\t\t\t\t\t\t// }\n\t\t\t\t\t});\n\n\t\t\t\t\trows.push(`${ message.msg } (${ attaches.join(', ') })`);\n\t\t\t\t} else {\n\t\t\t\t\trows.push(message.msg);\n\t\t\t\t}\n\t\t\t\trows.push(closetd);\n\n\t\t\t\trows.push(closetr);\n\t\t\t});\n\n\t\t\tif (rows.length !== 0) {\n\t\t\t\tconst result = start + rows.join('') + end;\n\n\t\t\t\tRocketChat.smarsh.History.upsert({ _id: room._id }, {\n\t\t\t\t\t_id: room._id,\n\t\t\t\t\tlastRan: date,\n\t\t\t\t\tlastResult: result,\n\t\t\t\t});\n\n\t\t\t\tRocketChat.smarsh.sendEmail({\n\t\t\t\t\tbody: result,\n\t\t\t\t\tsubject: `Rocket.Chat, ${ data.users.length } Users, ${ data.msgs } Messages, ${ data.files.length } Files, ${ data.time } Minutes, in ${ data.room }`,\n\t\t\t\t\tfiles: data.files,\n\t\t\t\t});\n\t\t\t}\n\t\t});\n\t});\n};\n","/* globals SyncedCron */\nimport _ from 'underscore';\n\nconst smarshJobName = 'Smarsh EML Connector';\n\nconst _addSmarshSyncedCronJob = _.debounce(Meteor.bindEnvironment(function __addSmarshSyncedCronJobDebounced() {\n\tif (SyncedCron.nextScheduledAtDate(smarshJobName)) {\n\t\tSyncedCron.remove(smarshJobName);\n\t}\n\n\tif (RocketChat.settings.get('Smarsh_Enabled') && RocketChat.settings.get('Smarsh_Email') !== '' && RocketChat.settings.get('From_Email') !== '') {\n\t\tSyncedCron.add({\n\t\t\tname: smarshJobName,\n\t\t\tschedule: (parser) => parser.text(RocketChat.settings.get('Smarsh_Interval').replace(/_/g, ' ')),\n\t\t\tjob: RocketChat.smarsh.generateEml,\n\t\t});\n\t}\n}), 500);\n\nMeteor.startup(() => {\n\tMeteor.defer(() => {\n\t\t_addSmarshSyncedCronJob();\n\n\t\tRocketChat.settings.get('Smarsh_Interval', _addSmarshSyncedCronJob);\n\t\tRocketChat.settings.get('Smarsh_Enabled', _addSmarshSyncedCronJob);\n\t\tRocketChat.settings.get('Smarsh_Email', _addSmarshSyncedCronJob);\n\t\tRocketChat.settings.get('From_Email', _addSmarshSyncedCronJob);\n\t});\n});\n"]}