{"version":3,"sources":["meteor://ðŸ’»app/packages/rocketchat:webdav/server/methods/addWebdavAccount.js","meteor://ðŸ’»app/packages/rocketchat:webdav/server/methods/removeWebdavAccount.js","meteor://ðŸ’»app/packages/rocketchat:webdav/server/methods/getWebdavFileList.js","meteor://ðŸ’»app/packages/rocketchat:webdav/server/methods/getFileFromWebdav.js","meteor://ðŸ’»app/packages/rocketchat:webdav/server/methods/uploadFileToWebdav.js","meteor://ðŸ’»app/packages/rocketchat:webdav/server/models/WebdavAccounts.js","meteor://ðŸ’»app/packages/rocketchat:webdav/server/publications/webdavAccounts.js","meteor://ðŸ’»app/packages/rocketchat:webdav/startup/settings.js"],"names":["Webdav","module","watch","require","default","v","Meteor","methods","addWebdavAccount","formData","userId","Error","method","RocketChat","settings","get","check","Match","ObjectIncluding","serverURL","String","username","pass","client","stat","error","success","message","accountData","user_id","server_url","password","name","models","WebdavAccounts","insert","code","removeWebdavAccount","accountId","removeByUserAndId","getWebdavFileList","path","account","findOne","_id","data","getDirectoryContents","getFileFromWebdav","file","fileContent","getFileContents","filename","Uint8Array","Future","stream","uploadFileToWebdav","fileData","uploadFolder","future","bufferStream","PassThrough","end","writeStream","createWriteStream","on","return","then","pipe","catch","err","status","createDirectory","wait","_Base","constructor","tryEnsureIndex","unique","findWithUserId","options","query","find","remove","removeById","publish","fields","addGroup","add","type","public"],"mappings":"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","file":"/packages/rocketchat_webdav.js","sourcesContent":["import Webdav from 'webdav';\n\nMeteor.methods({\n\tasync addWebdavAccount(formData) {\n\n\t\tconst userId = Meteor.userId();\n\n\t\tif (!userId) {\n\t\t\tthrow new Meteor.Error('error-invalid-user', 'Invalid User', { method: 'addWebdavAccount' });\n\t\t}\n\n\t\tif (!RocketChat.settings.get('Webdav_Integration_Enabled')) {\n\t\t\tthrow new Meteor.Error('error-not-allowed', 'WebDAV Integration Not Allowed', { method: 'addWebdavAccount' });\n\t\t}\n\n\t\tcheck(formData, Match.ObjectIncluding({\n\t\t\tserverURL: String,\n\t\t\tusername: String,\n\t\t\tpass: String,\n\t\t}));\n\n\t\tconst client = new Webdav(\n\t\t\tformData.serverURL,\n\t\t\tformData.username,\n\t\t\tformData.pass\n\t\t);\n\n\t\ttry {\n\t\t\tawait client.stat('/');\n\t\t} catch (error) {\n\t\t\treturn { success: false, message: 'could-not-access-webdav', error };\n\t\t}\n\n\t\tconst accountData = {\n\t\t\tuser_id: userId,\n\t\t\tserver_url: formData.serverURL,\n\t\t\tusername: formData.username,\n\t\t\tpassword: formData.pass,\n\t\t\tname: formData.name,\n\t\t};\n\t\ttry {\n\t\t\tRocketChat.models.WebdavAccounts.insert(accountData);\n\t\t\treturn { success: true, message: 'webdav-account-saved' };\n\t\t} catch (error) {\n\t\t\treturn { success: false, message: error.code === 11000 ? 'duplicated-account' : 'unknown-write-error', error };\n\t\t}\n\n\t},\n});\n","Meteor.methods({\n\tremoveWebdavAccount(accountId) {\n\t\tif (!Meteor.userId()) {\n\t\t\tthrow new Meteor.Error('error-invalid-user', 'Invalid User', { method: 'removeWebdavAccount' });\n\t\t}\n\t\t// if (!RocketChat.settings.get('Webdav_Integration_Enabled')) {\n\t\t// \tthrow new Meteor.Error('error-not-allowed', 'WebDAV Integration Not Allowed', {method: 'removeWebdavAccount'});\n\t\t// }\n\t\tcheck(accountId, String);\n\n\t\treturn RocketChat.models.WebdavAccounts.removeByUserAndId(accountId, Meteor.userId());\n\t},\n});\n","import Webdav from 'webdav';\n\nMeteor.methods({\n\tasync getWebdavFileList(accountId, path) {\n\t\tif (!Meteor.userId()) {\n\t\t\tthrow new Meteor.Error('error-invalid-user', 'Invalid User', { method: 'addNewWebdavAccount' });\n\t\t}\n\n\t\tif (!RocketChat.settings.get('Webdav_Integration_Enabled')) {\n\t\t\tthrow new Meteor.Error('error-not-allowed', 'WebDAV Integration Not Allowed', { method: 'addNewWebdavAccount' });\n\t\t}\n\n\t\tconst account = RocketChat.models.WebdavAccounts.findOne({ _id: accountId, user_id: Meteor.userId() });\n\t\tif (!account) {\n\t\t\tthrow new Meteor.Error('error-invalid-account', 'Invalid WebDAV Account', { method: 'addNewWebdavAccount' });\n\t\t}\n\n\t\tconst client = new Webdav(\n\t\t\taccount.server_url,\n\t\t\taccount.username,\n\t\t\taccount.password\n\t\t);\n\t\ttry {\n\t\t\tconst data = await client.getDirectoryContents(path);\n\t\t\treturn { success: true, data };\n\t\t} catch (error) {\n\t\t\treturn { success: false, message: 'could-not-access-webdav', error };\n\t\t}\n\t},\n});\n","import Webdav from 'webdav';\n\nMeteor.methods({\n\tasync getFileFromWebdav(accountId, file) {\n\t\tif (!Meteor.userId()) {\n\t\t\tthrow new Meteor.Error('error-invalid-user', 'Invalid User', { method: 'addNewWebdavAccount' });\n\t\t}\n\t\tif (!RocketChat.settings.get('Webdav_Integration_Enabled')) {\n\t\t\tthrow new Meteor.Error('error-not-allowed', 'WebDAV Integration Not Allowed', { method: 'addNewWebdavAccount' });\n\t\t}\n\n\t\tconst account = RocketChat.models.WebdavAccounts.findOne({ _id: accountId, user_id: Meteor.userId() });\n\t\tif (!account) {\n\t\t\tthrow new Meteor.Error('error-invalid-account', 'Invalid WebDAV Account', { method: 'addNewWebdavAccount' });\n\t\t}\n\t\tconst client = new Webdav(\n\t\t\taccount.server_url,\n\t\t\taccount.username,\n\t\t\taccount.password\n\t\t);\n\t\ttry {\n\t\t\tconst fileContent = await client.getFileContents(file.filename);\n\t\t\tconst data = new Uint8Array(fileContent);\n\t\t\treturn { success: true, data };\n\t\t} catch (error) {\n\t\t\treturn { success: false, data: error };\n\t\t}\n\t},\n});\n","import Future from 'fibers/future';\nimport Webdav from 'webdav';\nimport stream from 'stream';\n\nMeteor.methods({\n\tasync uploadFileToWebdav(accountId, fileData, name) {\n\t\tconst uploadFolder = 'Rocket.Chat Uploads/';\n\t\tif (!Meteor.userId()) {\n\t\t\tthrow new Meteor.Error('error-invalid-user', 'Invalid User', { method: 'uploadFileToWebdav' });\n\t\t}\n\t\tif (!RocketChat.settings.get('Webdav_Integration_Enabled')) {\n\t\t\tthrow new Meteor.Error('error-not-allowed', 'WebDAV Integration Not Allowed', { method: 'uploadFileToWebdav' });\n\t\t}\n\n\t\tconst account = RocketChat.models.WebdavAccounts.findOne({ _id: accountId });\n\t\tif (!account) {\n\t\t\tthrow new Meteor.Error('error-invalid-account', 'Invalid WebDAV Account', { method: 'uploadFileToWebdav' });\n\t\t}\n\t\tconst client = new Webdav(\n\t\t\taccount.server_url,\n\t\t\taccount.username,\n\t\t\taccount.password\n\t\t);\n\t\tconst future = new Future();\n\n\t\t// create buffer stream from file data\n\t\tlet bufferStream = new stream.PassThrough();\n\t\tif (fileData) {\n\t\t\tbufferStream.end(fileData);\n\t\t} else {\n\t\t\tbufferStream = null;\n\t\t}\n\n\t\t// create a write stream on remote webdav server\n\t\tconst writeStream = client.createWriteStream(`${ uploadFolder }/${ name }`);\n\t\twriteStream.on('end', function() {\n\t\t\tfuture.return({ success: true });\n\t\t});\n\t\twriteStream.on('error', function() {\n\t\t\tfuture.return({ success: false, message: 'FileUpload_Error' });\n\t\t});\n\n\t\tawait client.stat(uploadFolder).then(function() {\n\t\t\tbufferStream.pipe(writeStream);\n\t\t}).catch(function(err) {\n\t\t\tif (err.status === 404) {\n\t\t\t\tclient.createDirectory(uploadFolder).then(function() {\n\t\t\t\t\tbufferStream.pipe(writeStream);\n\t\t\t\t}).catch(function() {\n\t\t\t\t\tif (err.status === 404) {\n\t\t\t\t\t\tfuture.return({ success: false, message: 'webdav-server-not-found' });\n\t\t\t\t\t} else {\n\t\t\t\t\t\tfuture.return({ success: false, message: 'FileUpload_Error' });\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t} else if (err.status === 401) {\n\t\t\t\tfuture.return({ success: false, message: 'error-invalid-account' });\n\t\t\t} else {\n\t\t\t\tfuture.return({ success: false, message: 'FileUpload_Error' });\n\t\t\t}\n\t\t});\n\t\treturn future.wait();\n\t},\n});\n","/**\n * Webdav Accounts model\n */\nclass WebdavAccounts extends RocketChat.models._Base {\n\tconstructor() {\n\t\tsuper('webdav_accounts');\n\n\t\tthis.tryEnsureIndex({ user_id: 1, server_url: 1, username: 1, name: 1 }, { unique: 1 });\n\t}\n\n\tfindWithUserId(user_id, options) {\n\t\tconst query = { user_id };\n\t\treturn this.find(query, options);\n\t}\n\n\tremoveByUserAndId(_id, user_id) {\n\t\treturn this.remove({ _id, user_id });\n\t}\n\n\tremoveById(_id) {\n\t\treturn this.remove({ _id });\n\t}\n\n}\n\nRocketChat.models.WebdavAccounts = new WebdavAccounts();\n","Meteor.publish('webdavAccounts', function() {\n\tif (!this.userId) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'webdavAccounts' }));\n\t}\n\n\treturn RocketChat.models.WebdavAccounts.findWithUserId(this.userId, {\n\t\tfields: {\n\t\t\t_id:1,\n\t\t\tusername: 1,\n\t\t\tserver_url: 1,\n\t\t\tname: 1,\n\t\t},\n\t});\n});\n","RocketChat.settings.addGroup('Webdav Integration', function() {\n\tthis.add('Webdav_Integration_Enabled', false, {\n\t\ttype: 'boolean',\n\t\tpublic: true,\n\t});\n});\n"]}