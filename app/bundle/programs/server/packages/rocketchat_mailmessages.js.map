{"version":3,"sources":["meteor://ðŸ’»app/packages/rocketchat:mailmessages/lib/Mailer.js","meteor://ðŸ’»app/packages/rocketchat:mailmessages/server/startup.js","meteor://ðŸ’»app/packages/rocketchat:mailmessages/server/models/Users.js","meteor://ðŸ’»app/packages/rocketchat:mailmessages/server/functions/sendMail.js","meteor://ðŸ’»app/packages/rocketchat:mailmessages/server/functions/unsubscribe.js","meteor://ðŸ’»app/packages/rocketchat:mailmessages/server/methods/sendMail.js","meteor://ðŸ’»app/packages/rocketchat:mailmessages/server/methods/unsubscribe.js"],"names":["Mailer","Meteor","startup","RocketChat","models","Permissions","upsert","$setOnInsert","_id","roles","Users","rocketMailUnsubscribe","createdAt","query","Date","parseInt","update","$set","affectedRows","console","log","s","module","watch","require","default","v","sendMail","from","subject","body","dryrun","checkAddressFormatAndThrow","indexOf","Error","function","userQuery","$exists","$and","EJSON","parse","users","find","forEach","user","email","name","emails","address","html","placeholders","replace","unsubscribe","absoluteUrl","FlowRouter","path","getTime","send","to","escapeHTML","methods","userId","method","authz","hasRole","DDPRateLimiter","addRule","type","connectionId"],"mappings":"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","file":"/packages/rocketchat_mailmessages.js","sourcesContent":["Mailer = {};//eslint-disable-line\n","Meteor.startup(function() {\n\treturn RocketChat.models.Permissions.upsert('access-mailer', {\n\t\t$setOnInsert: {\n\t\t\t_id: 'access-mailer',\n\t\t\troles: ['admin'],\n\t\t},\n\t});\n});\n","RocketChat.models.Users.rocketMailUnsubscribe = function(_id, createdAt) {\n\tconst query = {\n\t\t_id,\n\t\tcreatedAt: new Date(parseInt(createdAt)),\n\t};\n\tconst update = {\n\t\t$set: {\n\t\t\t'mailer.unsubscribed': true,\n\t\t},\n\t};\n\tconst affectedRows = this.update(query, update);\n\tconsole.log('[Mailer:Unsubscribe]', _id, createdAt, new Date(parseInt(createdAt)), affectedRows);\n\treturn affectedRows;\n};\n","/* globals */\nimport s from 'underscore.string';\nimport * as Mailer from 'meteor/rocketchat:mailer';\n\nMailer.sendMail = function(from, subject, body, dryrun, query) {\n\tMailer.checkAddressFormatAndThrow(from, 'Mailer.sendMail');\n\tif (body.indexOf('[unsubscribe]') === -1) {\n\t\tthrow new Meteor.Error('error-missing-unsubscribe-link', 'You must provide the [unsubscribe] link.', {\n\t\t\tfunction: 'Mailer.sendMail',\n\t\t});\n\t}\n\n\tlet userQuery = { 'mailer.unsubscribed': { $exists: 0 } };\n\tif (query) {\n\t\tuserQuery = { $and: [userQuery, EJSON.parse(query)] };\n\t}\n\n\tif (dryrun) {\n\t\treturn Meteor.users.find({\n\t\t\t'emails.address': from,\n\t\t}).forEach((user) => {\n\t\t\tconst email = `${ user.name } <${ user.emails[0].address }>`;\n\t\t\tconst html = RocketChat.placeholders.replace(body, {\n\t\t\t\tunsubscribe: Meteor.absoluteUrl(FlowRouter.path('mailer/unsubscribe/:_id/:createdAt', {\n\t\t\t\t\t_id: user._id,\n\t\t\t\t\tcreatedAt: user.createdAt.getTime(),\n\t\t\t\t})),\n\t\t\t\tname: user.name,\n\t\t\t\temail,\n\t\t\t});\n\n\t\t\tconsole.log(`Sending email to ${ email }`);\n\t\t\treturn Mailer.send({\n\t\t\t\tto: email,\n\t\t\t\tfrom,\n\t\t\t\tsubject,\n\t\t\t\thtml,\n\t\t\t});\n\t\t});\n\t}\n\n\treturn Meteor.users.find(userQuery).forEach(function(user) {\n\t\tconst email = `${ user.name } <${ user.emails[0].address }>`;\n\n\t\tconst html = RocketChat.placeholders.replace(body, {\n\t\t\tunsubscribe: Meteor.absoluteUrl(FlowRouter.path('mailer/unsubscribe/:_id/:createdAt', {\n\t\t\t\t_id: user._id,\n\t\t\t\tcreatedAt: user.createdAt.getTime(),\n\t\t\t})),\n\t\t\tname: s.escapeHTML(user.name),\n\t\t\temail: s.escapeHTML(email),\n\t\t});\n\t\tconsole.log(`Sending email to ${ email }`);\n\t\treturn Mailer.send({\n\t\t\tto: email,\n\t\t\tfrom,\n\t\t\tsubject,\n\t\t\thtml,\n\t\t});\n\t});\n};\n","/* globals Mailer */\nMailer.unsubscribe = function(_id, createdAt) {\n\tif (_id && createdAt) {\n\t\treturn RocketChat.models.Users.rocketMailUnsubscribe(_id, createdAt) === 1;\n\t}\n\treturn false;\n};\n","/* globals Mailer */\nMeteor.methods({\n\t'Mailer.sendMail'(from, subject, body, dryrun, query) {\n\t\tconst userId = Meteor.userId();\n\t\tif (!userId) {\n\t\t\tthrow new Meteor.Error('error-invalid-user', 'Invalid user', {\n\t\t\t\tmethod: 'Mailer.sendMail',\n\t\t\t});\n\t\t}\n\t\tif (RocketChat.authz.hasRole(userId, 'admin') !== true) {\n\t\t\tthrow new Meteor.Error('error-not-allowed', 'Not allowed', {\n\t\t\t\tmethod: 'Mailer.sendMail',\n\t\t\t});\n\t\t}\n\t\treturn Mailer.sendMail(from, subject, body, dryrun, query);\n\t},\n});\n\n\n// Limit setting username once per minute\n// DDPRateLimiter.addRule\n//\ttype: 'method'\n//\tname: 'Mailer.sendMail'\n//\tconnectionId: -> return true\n//\t, 1, 60000\n","/* globals Mailer */\nMeteor.methods({\n\t'Mailer:unsubscribe'(_id, createdAt) {\n\t\treturn Mailer.unsubscribe(_id, createdAt);\n\t},\n});\n\nDDPRateLimiter.addRule({\n\ttype: 'method',\n\tname: 'Mailer:unsubscribe',\n\tconnectionId() {\n\t\treturn true;\n\t},\n}, 1, 60000);\n"]}