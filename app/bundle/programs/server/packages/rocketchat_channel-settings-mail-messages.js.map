{"version":3,"sources":["meteor://ðŸ’»app/packages/rocketchat:channel-settings-mail-messages/server/lib/startup.js","meteor://ðŸ’»app/packages/rocketchat:channel-settings-mail-messages/server/methods/mailMessages.js"],"names":["Meteor","startup","permission","_id","roles","RocketChat","models","Permissions","upsert","$setOnInsert","_","module","watch","require","default","v","moment","Mailer","methods","data","userId","Error","method","check","Match","ObjectIncluding","rid","String","to_users","to_emails","subject","messages","language","room","call","authz","hasPermission","action","emails","compact","trim","split","missing","length","each","username","user","Users","findOneByUsername","address","push","email","checkAddressFormat","shift","toLowerCase","localeFn","Function","locale","html","Messages","findByRoomIdAndMessageIds","sort","ts","map","message","dateTime","format","u","Message","parse","join","send","to","from","settings","get","replyTo","success"],"mappings":"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","file":"/packages/rocketchat_channel-settings-mail-messages.js","sourcesContent":["Meteor.startup(function() {\n\tconst permission = {\n\t\t_id: 'mail-messages',\n\t\troles: ['admin'],\n\t};\n\treturn RocketChat.models.Permissions.upsert(permission._id, {\n\t\t$setOnInsert: permission,\n\t});\n});\n","import _ from 'underscore';\nimport moment from 'moment';\nimport * as Mailer from 'meteor/rocketchat:mailer';\n\nMeteor.methods({\n\t'mailMessages'(data) {\n\t\tconst userId = Meteor.userId();\n\t\tif (!userId) {\n\t\t\tthrow new Meteor.Error('error-invalid-user', 'Invalid user', {\n\t\t\t\tmethod: 'mailMessages',\n\t\t\t});\n\t\t}\n\t\tcheck(data, Match.ObjectIncluding({\n\t\t\trid: String,\n\t\t\tto_users: [String],\n\t\t\tto_emails: String,\n\t\t\tsubject: String,\n\t\t\tmessages: [String],\n\t\t\tlanguage: String,\n\t\t}));\n\t\tconst room = Meteor.call('canAccessRoom', data.rid, userId);\n\t\tif (!room) {\n\t\t\tthrow new Meteor.Error('error-invalid-room', 'Invalid room', {\n\t\t\t\tmethod: 'mailMessages',\n\t\t\t});\n\t\t}\n\t\tif (!RocketChat.authz.hasPermission(userId, 'mail-messages')) {\n\t\t\tthrow new Meteor.Error('error-action-not-allowed', 'Mailing is not allowed', {\n\t\t\t\tmethod: 'mailMessages',\n\t\t\t\taction: 'Mailing',\n\t\t\t});\n\t\t}\n\n\t\tconst emails = _.compact(data.to_emails.trim().split(','));\n\t\tconst missing = [];\n\t\tif (data.to_users.length > 0) {\n\t\t\t_.each(data.to_users, (username) => {\n\t\t\t\tconst user = RocketChat.models.Users.findOneByUsername(username);\n\t\t\t\tif (user && user.emails && user.emails[0] && user.emails[0].address) {\n\t\t\t\t\temails.push(user.emails[0].address);\n\t\t\t\t} else {\n\t\t\t\t\tmissing.push(username);\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\t\t_.each(emails, (email) => {\n\t\t\tif (!Mailer.checkAddressFormat(email.trim())) {\n\t\t\t\tthrow new Meteor.Error('error-invalid-email', `Invalid email ${ email }`, {\n\t\t\t\t\tmethod: 'mailMessages',\n\t\t\t\t\temail,\n\t\t\t\t});\n\t\t\t}\n\t\t});\n\t\tconst user = Meteor.user();\n\t\tconst email = user.emails && user.emails[0] && user.emails[0].address;\n\t\tdata.language = data.language.split('-').shift().toLowerCase();\n\t\tif (data.language !== 'en') {\n\t\t\tconst localeFn = Meteor.call('loadLocale', data.language);\n\t\t\tif (localeFn) {\n\t\t\t\tFunction(localeFn).call({ moment });\n\t\t\t\tmoment.locale(data.language);\n\t\t\t}\n\t\t}\n\n\t\tconst html = RocketChat.models.Messages.findByRoomIdAndMessageIds(data.rid, data.messages, {\n\t\t\tsort: {\tts: 1 },\n\t\t}).map(function(message) {\n\t\t\tconst dateTime = moment(message.ts).locale(data.language).format('L LT');\n\t\t\treturn `<p style='margin-bottom: 5px'><b>${ message.u.username }</b> <span style='color: #aaa; font-size: 12px'>${ dateTime }</span><br/>${ RocketChat.Message.parse(message, data.language) }</p>`;\n\t\t}).join('');\n\n\t\tMailer.send({\n\t\t\tto: emails,\n\t\t\tfrom: RocketChat.settings.get('From_Email'),\n\t\t\treplyTo: email,\n\t\t\tsubject: data.subject,\n\t\t\thtml,\n\t\t});\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tmissing,\n\t\t};\n\t},\n});\n"]}