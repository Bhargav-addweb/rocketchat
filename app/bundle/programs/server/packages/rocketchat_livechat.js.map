{"version":3,"sources":["meteor://ðŸ’»app/packages/rocketchat:livechat/livechat.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/startup.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/visitorStatus.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/roomType.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/hooks/externalMessage.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/hooks/leadCapture.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/hooks/markRoomResponded.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/hooks/offlineMessage.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/hooks/RDStation.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/hooks/saveAnalyticsData.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/hooks/sendToCRM.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/hooks/sendToFacebook.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/addAgent.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/addManager.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/changeLivechatStatus.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/closeByVisitor.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/closeRoom.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/facebook.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/getCustomFields.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/getAgentData.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/getAgentOverviewData.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/getAnalyticsChartData.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/getAnalyticsOverviewData.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/getInitialData.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/getNextAgent.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/loadHistory.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/loginByToken.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/pageVisited.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/registerGuest.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/removeAgent.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/removeCustomField.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/removeDepartment.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/removeManager.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/removeTrigger.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/removeRoom.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/saveAppearance.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/saveCustomField.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/saveDepartment.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/saveInfo.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/saveIntegration.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/saveSurveyFeedback.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/saveTrigger.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/searchAgent.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/sendMessageLivechat.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/sendFileLivechatMessage.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/sendOfflineMessage.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/setCustomField.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/setDepartmentForVisitor.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/startVideoCall.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/startFileUploadRoom.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/transfer.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/webhookTest.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/takeInquiry.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/returnAsInquiry.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/saveOfficeHours.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/sendTranscript.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/models/Users.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/models/Rooms.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/models/Messages.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/models/LivechatExternalMessage.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/models/LivechatCustomField.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/models/LivechatDepartment.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/models/LivechatDepartmentAgents.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/models/LivechatPageVisited.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/models/LivechatTrigger.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/models/indexes.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/models/LivechatInquiry.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/models/LivechatOfficeHour.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/models/LivechatVisitors.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/lib/Analytics.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/lib/Livechat.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/lib/QueueMethods.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/lib/OfficeClock.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/lib/OmniChannel.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/sendMessageBySMS.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/unclosedLivechats.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/publications/customFields.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/publications/departmentAgents.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/publications/externalMessages.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/publications/livechatAgents.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/publications/livechatAppearance.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/publications/livechatDepartments.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/publications/livechatIntegration.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/publications/livechatManagers.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/publications/livechatMonitoring.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/publications/livechatRooms.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/publications/livechatQueue.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/publications/livechatTriggers.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/publications/livechatVisitors.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/publications/visitorHistory.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/publications/visitorInfo.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/publications/visitorPageVisited.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/publications/livechatInquiries.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/publications/livechatOfficeHours.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/api.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/api/rest.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/api/lib/livechat.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/api/v1/agent.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/api/v1/config.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/api/v1/customField.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/api/v1/message.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/api/v1/offlineMessage.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/api/v1/pageVisited.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/api/v1/room.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/api/v1/transcript.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/api/v1/videoCall.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/api/v1/visitor.js","meteor://ðŸ’»app/packages/rocketchat:livechat/permissions.js","meteor://ðŸ’»app/packages/rocketchat:livechat/messageTypes.js","meteor://ðŸ’»app/packages/rocketchat:livechat/config.js","meteor://ðŸ’»app/packages/rocketchat:livechat/imports/LivechatRoomType.js","meteor://ðŸ’»app/packages/rocketchat:livechat/imports/server/rest/departments.js","meteor://ðŸ’»app/packages/rocketchat:livechat/imports/server/rest/facebook.js","meteor://ðŸ’»app/packages/rocketchat:livechat/imports/server/rest/sms.js","meteor://ðŸ’»app/packages/rocketchat:livechat/imports/server/rest/upload.js","meteor://ðŸ’»app/packages/rocketchat:livechat/imports/server/rest/users.js"],"names":["_","module","watch","require","default","v","url","WebApp","Package","webapp","Autoupdate","autoupdate","connectHandlers","use","Meteor","bindEnvironment","req","res","next","reqUrl","parse","pathname","setHeader","domainWhiteList","RocketChat","settings","get","headers","referer","isEmpty","trim","map","split","domain","contains","host","protocol","head","Assets","getText","baseUrl","__meteor_runtime_config__","ROOT_URL_PATH_PREFIX","test","html","autoupdateVersion","JSON","stringify","write","end","startup","roomTypes","setRoomFind","_id","models","Rooms","findLivechatById","fetch","authz","addRoomAccessValidator","room","user","t","hasPermission","extraData","rid","findOneById","visitorToken","token","callbacks","add","Error","TAPi18n","__","lng","language","priority","LOW","UserPresenceEvents","on","session","status","metadata","visitor","LivechatInquiry","updateVisitorStatus","LivechatRoomType","LivechatVisitors","LivechatRoomTypeServer","getMsgSender","senderId","getNotificationDetails","notificationMessage","title","roomName","text","canAccessUploadedFile","rc_token","rc_rid","findOneOpenByRoomIdAndVisitorToken","knowledgeEnabled","apiaiKey","apiaiLanguage","key","value","message","editedAt","defer","response","HTTP","post","data","query","msg","lang","sessionId","Authorization","code","result","fulfillment","speech","LivechatExternalMessage","insert","orig","ts","Date","e","SystemLogger","error","validateMessage","phoneRegexp","RegExp","msgPhones","match","emailRegexp","msgEmails","saveGuestEmailPhoneById","run","waitingResponse","setResponseByRoomId","u","username","postData","type","sentAt","name","email","Livechat","sendRequest","MEDIUM","sendToRDStation","livechatData","getLivechatRoomGuestInfo","Array","isArray","address","options","token_rdstation","identificador","client_id","nome","phone","telefone","tags","Object","keys","customFields","forEach","field","call","console","now","analyticsData","visitorLastQuery","metrics","lq","agentLastReply","servedBy","lr","agentJoinTime","isResponseTt","tt","isResponseTotal","total","firstResponseDate","firstResponseTime","getTime","responseTime","avgResponseTime","firstReactionDate","firstReactionTime","reactionTime","saveAnalyticsDataByRoomId","msgNavType","crmEnabled","secretToken","webhookUrl","undefined","sendMessageType","msgType","sendNavHistory","sendToCRM","includeMessages","messages","Messages","findVisibleByRoomId","sort","agentId","navigation","push","saveCRMDataByRoomId","open","OmniChannel","facebook","reply","page","id","methods","userId","method","addAgent","addManager","newStatus","statusLivechat","Users","setLivechatStatus","roomId","getVisitorByToken","closeRoom","comment","subscription","Subscriptions","findOneByRoomIdAndUserId","action","enabled","hasToken","enable","success","updateById","disable","listPages","subscribe","unsubscribe","LivechatCustomField","find","check","String","getAgentInfo","chartOptions","log","Analytics","getAgentOverviewData","getAnalyticsChartData","analyticsOptions","getAnalyticsOverviewData","departmentId","info","color","registrationForm","triggers","departments","allowSwitchingDepartments","online","offlineColor","offlineMessage","offlineSuccessMessage","offlineUnavailableMessage","displayOfflineForm","videoCall","fileUpload","conversationFinishedMessage","nameFieldRegistrationForm","emailFieldRegistrationForm","fields","cl","usernames","findOpenByVisitorTokenAndDepartmentId","findOpenByVisitorToken","length","visitorEmails","department","initSettings","getInitSettings","Livechat_title","Livechat_title_color","Livechat_enabled","Livechat_registration_form","offlineTitle","Livechat_offline_title","Livechat_offline_title_color","Livechat_offline_message","Livechat_offline_success_message","Livechat_offline_form_unavailable","Livechat_display_offline_form","Language","Livechat_videocall_enabled","Jitsi_Enabled","Livechat_fileupload_enabled","FileUpload_Enabled","transcript","Livechat_enable_transcript","transcriptMessage","Livechat_transcript_message","Livechat_conversation_finished_message","Livechat_name_field_registration_form","Livechat_email_field_registration_form","agentData","LivechatTrigger","findEnabled","trigger","pick","LivechatDepartment","findEnabledWithAgents","Livechat_allow_switching_departments","findOnlineAgents","count","requireDeparment","getRequiredDepartment","agent","getNextAgent","limit","ls","loadMessageHistory","pageInfo","savePageHistory","registerGuest","keepHistoryForToken","cursor","saveRoomInfo","customField","scope","overwrite","updateLivechatDataByToken","removeAgent","removeById","removeDepartment","removeManager","triggerId","removeByRoomId","validSettings","valid","every","setting","indexOf","customFieldData","Match","ObjectIncluding","label","visibility","createOrUpdateCustomField","departmentData","departmentAgents","saveDepartment","guestData","roomData","Optional","topic","ret","saveGuest","s","values","Livechat_webhookUrl","Livechat_secret_token","Livechat_webhook_on_close","Livechat_webhook_on_offline_msg","Livechat_webhook_on_visitor_message","Livechat_webhook_on_agent_message","visitorRoom","formData","updateData","item","updateSurveyFeedbackById","Maybe","description","Boolean","runOnce","conditions","actions","isString","findOneByUsername","sendMessageLivechat","attachments","guest","sendMessage","file","msgData","avatar","emoji","alias","groupable","fileUrl","encodeURI","attachment","title_link","title_link_download","image_url","image_type","image_size","size","identify","image_dimensions","image_preview","FileUpload","resizeImagePreview","audio_url","audio_type","audio_size","video_url","video_type","video_size","assign","Random","sendOfflineMessage","DDPRateLimiter","addRule","connectionId","transferData","transfer","getRoom","jitsiTimeout","createWithTypeRoomIdMessageAndUser","actionLinks","icon","i18nLabel","method_id","params","jitsiRoom","hasRole","postCatchError","wrapAsync","resolve","err","unblock","sampleData","createdAt","lastMessageAt","productId","ip","browser","os","customerId","statusCode","inquiryId","inquiry","subscriptionData","alert","unread","userMentions","groupMentions","desktopNotifications","mobilePushNotifications","emailNotifications","incUsersCountById","changeAgentByRoomId","takeInquiry","createCommandWithRoomIdAndUser","stream","emit","returnRoomAsInquiry","day","start","finish","LivechatOfficeHour","updateHours","sendTranscript","setOperator","operator","update","$set","$exists","$ne","roles","findOneOnlineAgentByUsername","findOne","findAgents","findOnlineUserFromList","userList","$in","concat","collectionObj","model","rawCollection","findAndModify","livechatCount","$inc","closeOffice","self","openOffice","emails","surveyFeedback","findLivechat","filter","offset","extend","findLivechatByIdAndVisitorToken","findLivechatByVisitorToken","updateLivechatRoomCount","settingsRaw","Settings","findByVisitorToken","findByVisitorId","visitorId","responseBy","$unset","getTotalConversationsBetweenDate","date","$gte","gte","$lt","lt","getAnalyticsMetricsBetweenDate","msgs","closeByRoomId","closeInfo","closer","closedBy","closedAt","chatDuration","findOpenByAgent","newAgent","changeDepartmentIdByRoomId","crmData","removeAgentByRoomId","expireAt","multi","setRoomIdByToken","_Base","constructor","isClient","_initModel","findByRoomId","record","remove","tryEnsureIndex","numAgents","findByDepartmentId","createOrUpdateDepartment","showOnRegistration","agents","savedAgents","pluck","LivechatDepartmentAgents","agentsToSave","difference","removeByDepartmentIdAndAgentId","saveAgent","parseInt","order","$gt","upsert","getNextAgentForDepartment","onlineUsers","onlineUsernames","getOnlineForDepartment","depAgents","findUsersInQueue","usersList","replaceUsernameOfAgentByUserId","LivechatPageVisited","sparse","expireAfterSeconds","saveByToken","keepHistoryMiliseconds","findByToken","removeAll","findById","openInquiry","openInquiryWithAgents","agentIds","getStatus","moment","newStart","newFinish","newOpen","isNowWithinHours","currentTime","utc","format","todaysOfficeHours","isBefore","isBetween","isOpeningTime","isSame","isClosingTime","findVisitorByToken","findOneVisitorByPhone","getVisitorsBetweenDate","_updatedAt","getNextVisitorUsername","saveGuestById","setData","unsetData","phoneNumber","findOneGuestByEmailAddress","emailAddress","escapeRegExp","phones","$addToSet","saveEmail","$each","savePhone","replace","exportDefault","export","secondsToHHMMSS","sec","parseFloat","hours","Math","floor","minutes","seconds","round","from","daterange","to","isValid","AgentOverviewData","ChartData","chartLabel","dataLabels","dataPoints","diff","m","hour","OverviewData","Total_conversations","Avg_chat_duration","avgCD","Total_messages","Avg_first_response_time","frt","ft","avgFrt","Best_first_response_time","maxFrt","min","Avg_response_time","art","avg","avgArt","Avg_reaction_time","arnt","reaction","avgArnt","getKeyHavingMaxValue","def","maxValue","maxKey","Conversations","totalConversations","openConversations","totalMessages","totalMessagesOnWeekday","Map","totalMessagesInHour","days","summarize","weekday","set","has","busiestDay","h","dayHour","busiestHour","toFixed","Productivity","avgReactionTime","updateMap","sortByValue","inv","a","b","agentConversations","percentage","agentChatDurations","obj","agentMessages","agentAvgRespTime","agentFirstRespTime","agentAvgReactionTime","dns","UAParser","Mailer","historyMonitorType","logger","Logger","sections","webhook","i","queryString","Accept","getAgents","getOnlineAgents","onlineRequired","dept","onlineAgents","roomInfo","newRoom","routingMethod","QueueMethods","showConnecting","updateMessage","originalMessage","editAllowed","editOwn","deleteMessage","deleteAllowed","updateUser","existingUser","userData","connection","userAgent","httpHeaders","clientAddress","number","setDepartmentForGuest","closeData","hideByRoomIdAndUserId","setCustomFields","findNotHiddenPublic","setTopicAndTagsById","setFnameById","updateDisplayNameByRoomId","closeOpenChats","forwardOpenChats","change","pageTitle","pageUrl","location","href","_hidden","createNavigationHistoryWithRoomIdMessageAndUser","removeByRoomIdAndUserId","createUserLeaveWithRoomIdAndUser","createUserJoinWithRoomIdAndUser","openInq","callback","trying","warn","setTimeout","ua","setUA","fname","lm","getOS","version","getBrowser","addUserRoles","removeUserFromRoles","sendEmail","replyTo","subject","send","userLanguage","findVisibleByRoomIdNotContainingTypes","author","datetime","locale","singleMessage","fromEmail","emailDomain","substr","lastIndexOf","resolveMx","substring","Streamer","allowRead","sendNotification","usersCount","sender","hasMentionToAll","hasMentionToHere","mentionIds","setInterval","gatewayURL","authorization","pageId","SMS","sms","SMSService","getService","agentsHandler","monitorAgents","actionTimeout","users","queue","clearTimeout","exists","runAgentLeaveAction","observeChanges","added","changed","removed","stop","UserPresenceMonitor","onSetUserStatus","publish","handle","getUsersInRole","ready","onStop","findByIds","setDate","getDate","setSeconds","getSeconds","$lte","handleDepts","findByRoomIdAndType","findTriggers","findDepartments","findGuest","findRoom","findAgent","Livechat_history_monitor_type","theme","survey","items","API","v1","addRoute","urlParams","failure","queryParams","config","bodyParams","Key","put","delete","toISOString","authRequired","unauthorized","rooms","sentMessages","sentMessage","includes","provider","timeout","Roles","createOrUpdate","Permissions","MessageTypes","registerType","system","history","register","instance","tabBar","isServer","Notifications","notifyRoom","setHiddenById","addGroup","group","public","editor","allowedTypes","section","i18nDescription","enableQuery","RoomSettingsEnum","RoomTypeConfig","RoomTypeRouteConfig","UiTextContext","LivechatRoomRoute","path","openRoom","link","sub","identifier","route","notSubscribedTpl","template","ChatRoom","condition","hasAllPermission","canSendMessage","getUserStatus","Session","allowRoomSettingChange","JOIN_CODE","getUiText","context","HIDE_WARNING","LEAVE_WARNING","crypto","request","signature","createHmac","body","digest","mid","first_name","last_name","sucess","service","media","curr","message_link","contentType","extra","fromCountry","fromState","fromCity","Busboy","filesize","maxFileSize","packageValue","busboy","files","fieldname","filename","encoding","mimetype","fileDate","fileBuffer","Buffer","pipe","fileUploadIsValidContentType","reason","sizeAllowed","fileStore","getStore","details","uploadedFile","bind","role"],"mappings":"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","file":"/packages/rocketchat_livechat.js","sourcesContent":["/* globals WebApp:true */\nimport _ from 'underscore';\nimport url from 'url';\n\nconst { WebApp } = Package.webapp;\nconst { Autoupdate } = Package.autoupdate;\n\nWebApp.connectHandlers.use('/livechat', Meteor.bindEnvironment((req, res, next) => {\n\tconst reqUrl = url.parse(req.url);\n\tif (reqUrl.pathname !== '/') {\n\t\treturn next();\n\t}\n\tres.setHeader('content-type', 'text/html; charset=utf-8');\n\n\tlet domainWhiteList = RocketChat.settings.get('Livechat_AllowedDomainsList');\n\tif (req.headers.referer && !_.isEmpty(domainWhiteList.trim())) {\n\t\tdomainWhiteList = _.map(domainWhiteList.split(','), function(domain) {\n\t\t\treturn domain.trim();\n\t\t});\n\n\t\tconst referer = url.parse(req.headers.referer);\n\t\tif (!_.contains(domainWhiteList, referer.host)) {\n\t\t\tres.setHeader('X-FRAME-OPTIONS', 'DENY');\n\t\t\treturn next();\n\t\t}\n\n\t\tres.setHeader('X-FRAME-OPTIONS', `ALLOW-FROM ${ referer.protocol }//${ referer.host }`);\n\t}\n\n\tconst head = Assets.getText('public/head.html');\n\n\tlet baseUrl;\n\tif (__meteor_runtime_config__.ROOT_URL_PATH_PREFIX && __meteor_runtime_config__.ROOT_URL_PATH_PREFIX.trim() !== '') {\n\t\tbaseUrl = __meteor_runtime_config__.ROOT_URL_PATH_PREFIX;\n\t} else {\n\t\tbaseUrl = '/';\n\t}\n\tif (/\\/$/.test(baseUrl) === false) {\n\t\tbaseUrl += '/';\n\t}\n\n\tconst html = `<html>\n\t\t<head>\n\t\t\t<link rel=\"stylesheet\" type=\"text/css\" class=\"__meteor-css__\" href=\"${ baseUrl }livechat/livechat.css?_dc=${ Autoupdate.autoupdateVersion }\">\n\t\t\t<script type=\"text/javascript\">\n\t\t\t\t__meteor_runtime_config__ = ${ JSON.stringify(__meteor_runtime_config__) };\n\t\t\t</script>\n\n\t\t\t<base href=\"${ baseUrl }\">\n\n\t\t\t${ head }\n\t\t</head>\n\t\t<body>\n\t\t\t<script type=\"text/javascript\" src=\"${ baseUrl }livechat/livechat.js?_dc=${ Autoupdate.autoupdateVersion }\"></script>\n\t\t</body>\n\t</html>`;\n\n\tres.write(html);\n\tres.end();\n}));\n","Meteor.startup(() => {\n\tRocketChat.roomTypes.setRoomFind('l', (_id) => RocketChat.models.Rooms.findLivechatById(_id).fetch());\n\n\tRocketChat.authz.addRoomAccessValidator(function(room, user) {\n\t\treturn room && room.t === 'l' && user && RocketChat.authz.hasPermission(user._id, 'view-livechat-rooms');\n\t});\n\n\tRocketChat.authz.addRoomAccessValidator(function(room, user, extraData) {\n\t\tif (!room && extraData && extraData.rid) {\n\t\t\troom = RocketChat.models.Rooms.findOneById(extraData.rid);\n\t\t}\n\t\treturn room && room.t === 'l' && extraData && extraData.visitorToken && room.v && room.v.token === extraData.visitorToken;\n\t});\n\n\tRocketChat.callbacks.add('beforeLeaveRoom', function(user, room) {\n\t\tif (room.t !== 'l') {\n\t\t\treturn user;\n\t\t}\n\t\tthrow new Meteor.Error(TAPi18n.__('You_cant_leave_a_livechat_room_Please_use_the_close_button', {\n\t\t\tlng: user.language || RocketChat.settings.get('language') || 'en',\n\t\t}));\n\t}, RocketChat.callbacks.priority.LOW, 'cant-leave-room');\n});\n","/* globals UserPresenceEvents */\nMeteor.startup(() => {\n\tUserPresenceEvents.on('setStatus', (session, status, metadata) => {\n\t\tif (metadata && metadata.visitor) {\n\t\t\tRocketChat.models.LivechatInquiry.updateVisitorStatus(metadata.visitor, status);\n\t\t\tRocketChat.models.Rooms.updateVisitorStatus(metadata.visitor, status);\n\t\t}\n\t});\n});\n","import LivechatRoomType from '../imports/LivechatRoomType';\nimport LivechatVisitors from './models/LivechatVisitors';\n\nclass LivechatRoomTypeServer extends LivechatRoomType {\n\tgetMsgSender(senderId) {\n\t\treturn LivechatVisitors.findOneById(senderId);\n\t}\n\n\t/**\n\t * Returns details to use on notifications\n\t *\n\t * @param {object} room\n\t * @param {object} user\n\t * @param {string} notificationMessage\n\t * @return {object} Notification details\n\t */\n\tgetNotificationDetails(room, user, notificationMessage) {\n\t\tconst title = `[livechat] ${ this.roomName(room) }`;\n\t\tconst text = notificationMessage;\n\n\t\treturn { title, text };\n\t}\n\n\tcanAccessUploadedFile({ rc_token, rc_rid } = {}) {\n\t\treturn rc_token && rc_rid && RocketChat.models.Rooms.findOneOpenByRoomIdAndVisitorToken(rc_rid, rc_token);\n\t}\n}\n\nRocketChat.roomTypes.add(new LivechatRoomTypeServer());\n","/* globals HTTP, SystemLogger */\nimport _ from 'underscore';\n\nlet knowledgeEnabled = false;\nlet apiaiKey = '';\nlet apiaiLanguage = 'en';\nRocketChat.settings.get('Livechat_Knowledge_Enabled', function(key, value) {\n\tknowledgeEnabled = value;\n});\nRocketChat.settings.get('Livechat_Knowledge_Apiai_Key', function(key, value) {\n\tapiaiKey = value;\n});\nRocketChat.settings.get('Livechat_Knowledge_Apiai_Language', function(key, value) {\n\tapiaiLanguage = value;\n});\n\nRocketChat.callbacks.add('afterSaveMessage', function(message, room) {\n\t// skips this callback if the message was edited\n\tif (!message || message.editedAt) {\n\t\treturn message;\n\t}\n\n\tif (!knowledgeEnabled) {\n\t\treturn message;\n\t}\n\n\tif (!(typeof room.t !== 'undefined' && room.t === 'l' && room.v && room.v.token)) {\n\t\treturn message;\n\t}\n\n\t// if the message hasn't a token, it was not sent by the visitor, so ignore it\n\tif (!message.token) {\n\t\treturn message;\n\t}\n\n\tMeteor.defer(() => {\n\t\ttry {\n\t\t\tconst response = HTTP.post('https://api.api.ai/api/query?v=20150910', {\n\t\t\t\tdata: {\n\t\t\t\t\tquery: message.msg,\n\t\t\t\t\tlang: apiaiLanguage,\n\t\t\t\t\tsessionId: room._id,\n\t\t\t\t},\n\t\t\t\theaders: {\n\t\t\t\t\t'Content-Type': 'application/json; charset=utf-8',\n\t\t\t\t\tAuthorization: `Bearer ${ apiaiKey }`,\n\t\t\t\t},\n\t\t\t});\n\n\t\t\tif (response.data && response.data.status.code === 200 && !_.isEmpty(response.data.result.fulfillment.speech)) {\n\t\t\t\tRocketChat.models.LivechatExternalMessage.insert({\n\t\t\t\t\trid: message.rid,\n\t\t\t\t\tmsg: response.data.result.fulfillment.speech,\n\t\t\t\t\torig: message._id,\n\t\t\t\t\tts: new Date(),\n\t\t\t\t});\n\t\t\t}\n\t\t} catch (e) {\n\t\t\tSystemLogger.error('Error using Api.ai ->', e);\n\t\t}\n\t});\n\n\treturn message;\n}, RocketChat.callbacks.priority.LOW, 'externalWebHook');\n","import LivechatVisitors from '../../server/models/LivechatVisitors';\n\nfunction validateMessage(message, room) {\n\t// skips this callback if the message was edited\n\tif (message.editedAt) {\n\t\treturn false;\n\t}\n\n\t// message valid only if it is a livechat room\n\tif (!(typeof room.t !== 'undefined' && room.t === 'l' && room.v && room.v.token)) {\n\t\treturn false;\n\t}\n\n\t// if the message hasn't a token, it was NOT sent from the visitor, so ignore it\n\tif (!message.token) {\n\t\treturn false;\n\t}\n\n\t// if the message has a type means it is a special message (like the closing comment), so skips\n\tif (message.t) {\n\t\treturn false;\n\t}\n\n\treturn true;\n}\n\nRocketChat.callbacks.add('afterSaveMessage', function(message, room) {\n\tif (!validateMessage(message, room)) {\n\t\treturn message;\n\t}\n\n\tconst phoneRegexp = new RegExp(RocketChat.settings.get('Livechat_lead_phone_regex'), 'g');\n\tconst msgPhones = message.msg.match(phoneRegexp);\n\n\tconst emailRegexp = new RegExp(RocketChat.settings.get('Livechat_lead_email_regex'), 'gi');\n\tconst msgEmails = message.msg.match(emailRegexp);\n\n\tif (msgEmails || msgPhones) {\n\t\tLivechatVisitors.saveGuestEmailPhoneById(room.v._id, msgEmails, msgPhones);\n\n\t\tRocketChat.callbacks.run('livechat.leadCapture', room);\n\t}\n\n\treturn message;\n}, RocketChat.callbacks.priority.LOW, 'leadCapture');\n","RocketChat.callbacks.add('afterSaveMessage', function(message, room) {\n\t// skips this callback if the message was edited\n\tif (!message || message.editedAt) {\n\t\treturn message;\n\t}\n\n\t// check if room is yet awaiting for response\n\tif (!(typeof room.t !== 'undefined' && room.t === 'l' && room.waitingResponse)) {\n\t\treturn message;\n\t}\n\n\t// if the message has a token, it was sent by the visitor, so ignore it\n\tif (message.token) {\n\t\treturn message;\n\t}\n\n\tMeteor.defer(() => {\n\t\tRocketChat.models.Rooms.setResponseByRoomId(room._id, {\n\t\t\tuser: {\n\t\t\t\t_id: message.u._id,\n\t\t\t\tusername: message.u.username,\n\t\t\t},\n\t\t});\n\t});\n\n\treturn message;\n}, RocketChat.callbacks.priority.LOW, 'markRoomResponded');\n","RocketChat.callbacks.add('livechat.offlineMessage', (data) => {\n\tif (!RocketChat.settings.get('Livechat_webhook_on_offline_msg')) {\n\t\treturn data;\n\t}\n\n\tconst postData = {\n\t\ttype: 'LivechatOfflineMessage',\n\t\tsentAt: new Date(),\n\t\tvisitor: {\n\t\t\tname: data.name,\n\t\t\temail: data.email,\n\t\t},\n\t\tmessage: data.message,\n\t};\n\n\tRocketChat.Livechat.sendRequest(postData);\n}, RocketChat.callbacks.priority.MEDIUM, 'livechat-send-email-offline-message');\n","function sendToRDStation(room) {\n\tif (!RocketChat.settings.get('Livechat_RDStation_Token')) {\n\t\treturn room;\n\t}\n\n\tconst livechatData = RocketChat.Livechat.getLivechatRoomGuestInfo(room);\n\n\tif (!livechatData.visitor.email) {\n\t\treturn room;\n\t}\n\n\tconst email = Array.isArray(livechatData.visitor.email) ? livechatData.visitor.email[0].address : livechatData.visitor.email;\n\n\tconst options = {\n\t\theaders: {\n\t\t\t'Content-Type': 'application/json',\n\t\t},\n\t\tdata: {\n\t\t\ttoken_rdstation: RocketChat.settings.get('Livechat_RDStation_Token'),\n\t\t\tidentificador: 'rocketchat-livechat',\n\t\t\tclient_id: livechatData.visitor._id,\n\t\t\temail,\n\t\t},\n\t};\n\n\toptions.data.nome = livechatData.visitor.name || livechatData.visitor.username;\n\n\tif (livechatData.visitor.phone) {\n\t\toptions.data.telefone = livechatData.visitor.phone;\n\t}\n\n\tif (livechatData.tags) {\n\t\toptions.data.tags = livechatData.tags;\n\t}\n\n\tObject.keys(livechatData.customFields || {}).forEach((field) => {\n\t\toptions.data[field] = livechatData.customFields[field];\n\t});\n\n\tObject.keys(livechatData.visitor.customFields || {}).forEach((field) => {\n\t\toptions.data[field] = livechatData.visitor.customFields[field];\n\t});\n\n\ttry {\n\t\tHTTP.call('POST', 'https://www.rdstation.com.br/api/1.3/conversions', options);\n\t} catch (e) {\n\t\tconsole.error('Error sending lead to RD Station ->', e);\n\t}\n\n\treturn room;\n}\n\nRocketChat.callbacks.add('livechat.closeRoom', sendToRDStation, RocketChat.callbacks.priority.MEDIUM, 'livechat-rd-station-close-room');\n\nRocketChat.callbacks.add('livechat.saveInfo', sendToRDStation, RocketChat.callbacks.priority.MEDIUM, 'livechat-rd-station-save-info');\n","RocketChat.callbacks.add('afterSaveMessage', function(message, room) {\n\t// skips this callback if the message was edited\n\tif (!message || message.editedAt) {\n\t\treturn message;\n\t}\n\n\t// check if room is livechat\n\tif (room.t !== 'l') {\n\t\treturn message;\n\t}\n\n\tMeteor.defer(() => {\n\t\tconst now = new Date();\n\t\tlet analyticsData;\n\n\t\t// if the message has a token, it was sent by the visitor\n\t\tif (!message.token) {\n\t\t\tconst visitorLastQuery = (room.metrics && room.metrics.v) ? room.metrics.v.lq : room.ts;\n\t\t\tconst agentLastReply = (room.metrics && room.metrics.servedBy) ? room.metrics.servedBy.lr : room.ts;\n\t\t\tconst agentJoinTime = (room.servedBy && room.servedBy.ts) ? room.servedBy.ts : room.ts;\n\n\t\t\tconst isResponseTt = room.metrics && room.metrics.response && room.metrics.response.tt;\n\t\t\tconst isResponseTotal = room.metrics && room.metrics.response && room.metrics.response.total;\n\n\t\t\tif (agentLastReply === room.ts) {\t\t// first response\n\t\t\t\tconst firstResponseDate = now;\n\t\t\t\tconst firstResponseTime = (now.getTime() - visitorLastQuery) / 1000;\n\t\t\t\tconst responseTime = (now.getTime() - visitorLastQuery) / 1000;\n\t\t\t\tconst avgResponseTime = (((isResponseTt) ? room.metrics.response.tt : 0) + responseTime) / (((isResponseTotal) ? room.metrics.response.total : 0) + 1);\n\n\t\t\t\tconst firstReactionDate = now;\n\t\t\t\tconst firstReactionTime = (now.getTime() - agentJoinTime) / 1000;\n\t\t\t\tconst reactionTime = (now.getTime() - agentJoinTime) / 1000;\n\n\t\t\t\tanalyticsData = {\n\t\t\t\t\tfirstResponseDate,\n\t\t\t\t\tfirstResponseTime,\n\t\t\t\t\tresponseTime,\n\t\t\t\t\tavgResponseTime,\n\t\t\t\t\tfirstReactionDate,\n\t\t\t\t\tfirstReactionTime,\n\t\t\t\t\treactionTime,\n\t\t\t\t};\n\t\t\t} else if (visitorLastQuery > agentLastReply) {\t\t// response, not first\n\t\t\t\tconst responseTime = (now.getTime() - visitorLastQuery) / 1000;\n\t\t\t\tconst avgResponseTime = (((isResponseTt) ? room.metrics.response.tt : 0) + responseTime) / (((isResponseTotal) ? room.metrics.response.total : 0) + 1);\n\n\t\t\t\tconst reactionTime = (now.getTime() - visitorLastQuery) / 1000;\n\n\t\t\t\tanalyticsData = {\n\t\t\t\t\tresponseTime,\n\t\t\t\t\tavgResponseTime,\n\t\t\t\t\treactionTime,\n\t\t\t\t};\n\t\t\t}\t// ignore, its continuing response\n\t\t}\n\n\t\tRocketChat.models.Rooms.saveAnalyticsDataByRoomId(room, message, analyticsData);\n\t});\n\n\treturn message;\n}, RocketChat.callbacks.priority.LOW, 'saveAnalyticsData');\n","const msgNavType = 'livechat_navigation_history';\n\nconst crmEnabled = () => {\n\tconst secretToken = RocketChat.settings.get('Livechat_secret_token');\n\tconst webhookUrl = RocketChat.settings.get('Livechat_webhookUrl');\n\treturn secretToken !== '' && secretToken !== undefined && webhookUrl !== '' && webhookUrl !== undefined;\n};\n\nconst sendMessageType = (msgType) => {\n\tconst sendNavHistory = RocketChat.settings.get('Livechat_Visitor_navigation_as_a_message') && RocketChat.settings.get('Send_visitor_navigation_history_livechat_webhook_request');\n\n\treturn sendNavHistory && msgType === msgNavType;\n};\n\nfunction sendToCRM(type, room, includeMessages = true) {\n\tif (crmEnabled() === false) {\n\t\treturn room;\n\t}\n\n\tconst postData = RocketChat.Livechat.getLivechatRoomGuestInfo(room);\n\n\tpostData.type = type;\n\n\tpostData.messages = [];\n\n\tlet messages;\n\tif (typeof includeMessages === 'boolean' && includeMessages) {\n\t\tmessages = RocketChat.models.Messages.findVisibleByRoomId(room._id, { sort: { ts: 1 } });\n\t} else if (includeMessages instanceof Array) {\n\t\tmessages = includeMessages;\n\t}\n\n\tif (messages) {\n\t\tmessages.forEach((message) => {\n\t\t\tif (message.t && !sendMessageType(message.t)) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tconst msg = {\n\t\t\t\t_id: message._id,\n\t\t\t\tusername: message.u.username,\n\t\t\t\tmsg: message.msg,\n\t\t\t\tts: message.ts,\n\t\t\t\teditedAt: message.editedAt,\n\t\t\t};\n\n\t\t\tif (message.u.username !== postData.visitor.username) {\n\t\t\t\tmsg.agentId = message.u._id;\n\t\t\t}\n\n\t\t\tif (message.t === msgNavType) {\n\t\t\t\tmsg.navigation = message.navigation;\n\t\t\t}\n\n\t\t\tpostData.messages.push(msg);\n\t\t});\n\t}\n\n\tconst response = RocketChat.Livechat.sendRequest(postData);\n\n\tif (response && response.data && response.data.data) {\n\t\tRocketChat.models.Rooms.saveCRMDataByRoomId(room._id, response.data.data);\n\t}\n\n\treturn room;\n}\n\nRocketChat.callbacks.add('livechat.closeRoom', (room) => {\n\tif (!RocketChat.settings.get('Livechat_webhook_on_close')) {\n\t\treturn room;\n\t}\n\n\treturn sendToCRM('LivechatSession', room);\n}, RocketChat.callbacks.priority.MEDIUM, 'livechat-send-crm-close-room');\n\nRocketChat.callbacks.add('livechat.saveInfo', (room) => {\n\t// Do not send to CRM if the chat is still open\n\tif (room.open) {\n\t\treturn room;\n\t}\n\n\treturn sendToCRM('LivechatEdit', room);\n}, RocketChat.callbacks.priority.MEDIUM, 'livechat-send-crm-save-info');\n\nRocketChat.callbacks.add('afterSaveMessage', function(message, room) {\n\t// only call webhook if it is a livechat room\n\tif (room.t !== 'l' || room.v == null || room.v.token == null) {\n\t\treturn message;\n\t}\n\n\t// if the message has a token, it was sent from the visitor\n\t// if not, it was sent from the agent\n\tif (message.token) {\n\t\tif (!RocketChat.settings.get('Livechat_webhook_on_visitor_message')) {\n\t\t\treturn message;\n\t\t}\n\t} else if (!RocketChat.settings.get('Livechat_webhook_on_agent_message')) {\n\t\treturn message;\n\t}\n\t// if the message has a type means it is a special message (like the closing comment), so skips\n\t// unless the settings that handle with visitor navigation history are enabled\n\tif (message.t && !sendMessageType(message.t)) {\n\t\treturn message;\n\t}\n\n\tsendToCRM('Message', room, [message]);\n\treturn message;\n}, RocketChat.callbacks.priority.MEDIUM, 'livechat-send-crm-message');\n\nRocketChat.callbacks.add('livechat.leadCapture', (room) => {\n\tif (!RocketChat.settings.get('Livechat_webhook_on_capture')) {\n\t\treturn room;\n\t}\n\treturn sendToCRM('LeadCapture', room, false);\n}, RocketChat.callbacks.priority.MEDIUM, 'livechat-send-crm-lead-capture');\n","import OmniChannel from '../lib/OmniChannel';\n\nRocketChat.callbacks.add('afterSaveMessage', function(message, room) {\n\t// skips this callback if the message was edited\n\tif (message.editedAt) {\n\t\treturn message;\n\t}\n\n\tif (!RocketChat.settings.get('Livechat_Facebook_Enabled') || !RocketChat.settings.get('Livechat_Facebook_API_Key')) {\n\t\treturn message;\n\t}\n\n\t// only send the sms by SMS if it is a livechat room with SMS set to true\n\tif (!(typeof room.t !== 'undefined' && room.t === 'l' && room.facebook && room.v && room.v.token)) {\n\t\treturn message;\n\t}\n\n\t// if the message has a token, it was sent from the visitor, so ignore it\n\tif (message.token) {\n\t\treturn message;\n\t}\n\n\t// if the message has a type means it is a special message (like the closing comment), so skips\n\tif (message.t) {\n\t\treturn message;\n\t}\n\n\tOmniChannel.reply({\n\t\tpage: room.facebook.page.id,\n\t\ttoken: room.v.token,\n\t\ttext: message.msg,\n\t});\n\n\treturn message;\n\n}, RocketChat.callbacks.priority.LOW, 'sendMessageToFacebook');\n","Meteor.methods({\n\t'livechat:addAgent'(username) {\n\t\tif (!Meteor.userId() || !RocketChat.authz.hasPermission(Meteor.userId(), 'view-livechat-manager')) {\n\t\t\tthrow new Meteor.Error('error-not-allowed', 'Not allowed', { method: 'livechat:addAgent' });\n\t\t}\n\n\t\treturn RocketChat.Livechat.addAgent(username);\n\t},\n});\n","Meteor.methods({\n\t'livechat:addManager'(username) {\n\t\tif (!Meteor.userId() || !RocketChat.authz.hasPermission(Meteor.userId(), 'view-livechat-manager')) {\n\t\t\tthrow new Meteor.Error('error-not-allowed', 'Not allowed', { method: 'livechat:addManager' });\n\t\t}\n\n\t\treturn RocketChat.Livechat.addManager(username);\n\t},\n});\n","Meteor.methods({\n\t'livechat:changeLivechatStatus'() {\n\t\tif (!Meteor.userId()) {\n\t\t\tthrow new Meteor.Error('error-not-allowed', 'Not allowed', { method: 'livechat:changeLivechatStatus' });\n\t\t}\n\n\t\tconst user = Meteor.user();\n\n\t\tconst newStatus = user.statusLivechat === 'available' ? 'not-available' : 'available';\n\n\t\treturn RocketChat.models.Users.setLivechatStatus(user._id, newStatus);\n\t},\n});\n","import LivechatVisitors from '../models/LivechatVisitors';\n\nMeteor.methods({\n\t'livechat:closeByVisitor'({ roomId, token }) {\n\t\tconst room = RocketChat.models.Rooms.findOneOpenByRoomIdAndVisitorToken(roomId, token);\n\n\t\tif (!room || !room.open) {\n\t\t\treturn false;\n\t\t}\n\n\t\tconst visitor = LivechatVisitors.getVisitorByToken(token);\n\n\t\tconst language = (visitor && visitor.language) || RocketChat.settings.get('language') || 'en';\n\n\t\treturn RocketChat.Livechat.closeRoom({\n\t\t\tvisitor,\n\t\t\troom,\n\t\t\tcomment: TAPi18n.__('Closed_by_visitor', { lng: language }),\n\t\t});\n\t},\n});\n","Meteor.methods({\n\t'livechat:closeRoom'(roomId, comment) {\n\t\tconst userId = Meteor.userId();\n\t\tif (!userId || !RocketChat.authz.hasPermission(userId, 'close-livechat-room')) {\n\t\t\tthrow new Meteor.Error('error-not-authorized', 'Not authorized', { method: 'livechat:closeRoom' });\n\t\t}\n\n\t\tconst room = RocketChat.models.Rooms.findOneById(roomId);\n\n\t\tif (!room || room.t !== 'l') {\n\t\t\tthrow new Meteor.Error('room-not-found', 'Room not found', { method: 'livechat:closeRoom' });\n\t\t}\n\n\t\tconst user = Meteor.user();\n\n\t\tconst subscription = RocketChat.models.Subscriptions.findOneByRoomIdAndUserId(roomId, user._id, { _id: 1 });\n\t\tif (!subscription && !RocketChat.authz.hasPermission(userId, 'close-others-livechat-room')) {\n\t\t\tthrow new Meteor.Error('error-not-authorized', 'Not authorized', { method: 'livechat:closeRoom' });\n\t\t}\n\n\t\treturn RocketChat.Livechat.closeRoom({\n\t\t\tuser,\n\t\t\troom,\n\t\t\tcomment,\n\t\t});\n\t},\n});\n","import OmniChannel from '../lib/OmniChannel';\n\nMeteor.methods({\n\t'livechat:facebook'(options) {\n\t\tif (!Meteor.userId() || !RocketChat.authz.hasPermission(Meteor.userId(), 'view-livechat-manager')) {\n\t\t\tthrow new Meteor.Error('error-not-allowed', 'Not allowed', { method: 'livechat:addAgent' });\n\t\t}\n\n\t\ttry {\n\t\t\tswitch (options.action) {\n\t\t\t\tcase 'initialState': {\n\t\t\t\t\treturn {\n\t\t\t\t\t\tenabled: RocketChat.settings.get('Livechat_Facebook_Enabled'),\n\t\t\t\t\t\thasToken: !!RocketChat.settings.get('Livechat_Facebook_API_Key'),\n\t\t\t\t\t};\n\t\t\t\t}\n\n\t\t\t\tcase 'enable': {\n\t\t\t\t\tconst result = OmniChannel.enable();\n\n\t\t\t\t\tif (!result.success) {\n\t\t\t\t\t\treturn result;\n\t\t\t\t\t}\n\n\t\t\t\t\treturn RocketChat.settings.updateById('Livechat_Facebook_Enabled', true);\n\t\t\t\t}\n\n\t\t\t\tcase 'disable': {\n\t\t\t\t\tOmniChannel.disable();\n\n\t\t\t\t\treturn RocketChat.settings.updateById('Livechat_Facebook_Enabled', false);\n\t\t\t\t}\n\n\t\t\t\tcase 'list-pages': {\n\t\t\t\t\treturn OmniChannel.listPages();\n\t\t\t\t}\n\n\t\t\t\tcase 'subscribe': {\n\t\t\t\t\treturn OmniChannel.subscribe(options.page);\n\t\t\t\t}\n\n\t\t\t\tcase 'unsubscribe': {\n\t\t\t\t\treturn OmniChannel.unsubscribe(options.page);\n\t\t\t\t}\n\t\t\t}\n\t\t} catch (e) {\n\t\t\tif (e.response && e.response.data && e.response.data.error) {\n\t\t\t\tif (e.response.data.error.error) {\n\t\t\t\t\tthrow new Meteor.Error(e.response.data.error.error, e.response.data.error.message);\n\t\t\t\t}\n\t\t\t\tif (e.response.data.error.response) {\n\t\t\t\t\tthrow new Meteor.Error('integration-error', e.response.data.error.response.error.message);\n\t\t\t\t}\n\t\t\t\tif (e.response.data.error.message) {\n\t\t\t\t\tthrow new Meteor.Error('integration-error', e.response.data.error.message);\n\t\t\t\t}\n\t\t\t}\n\t\t\tconsole.error('Error contacting omni.rocket.chat:', e);\n\t\t\tthrow new Meteor.Error('integration-error', e.error);\n\t\t}\n\t},\n});\n","Meteor.methods({\n\t'livechat:getCustomFields'() {\n\t\treturn RocketChat.models.LivechatCustomField.find().fetch();\n\t},\n});\n","import LivechatVisitors from '../models/LivechatVisitors';\n\nMeteor.methods({\n\t'livechat:getAgentData'({ roomId, token }) {\n\t\tcheck(roomId, String);\n\t\tcheck(token, String);\n\n\t\tconst room = RocketChat.models.Rooms.findOneById(roomId);\n\t\tconst visitor = LivechatVisitors.getVisitorByToken(token);\n\n\t\tif (!room || room.t !== 'l' || !room.v || room.v.token !== visitor.token) {\n\t\t\tthrow new Meteor.Error('error-invalid-room', 'Invalid room');\n\t\t}\n\n\t\tif (!room.servedBy) {\n\t\t\treturn;\n\t\t}\n\n\t\treturn RocketChat.models.Users.getAgentInfo(room.servedBy._id);\n\t},\n});\n","Meteor.methods({\n\t'livechat:getAgentOverviewData'(options) {\n\t\tif (!Meteor.userId() || !RocketChat.authz.hasPermission(Meteor.userId(), 'view-livechat-manager')) {\n\t\t\tthrow new Meteor.Error('error-not-allowed', 'Not allowed', {\n\t\t\t\tmethod: 'livechat:getAgentOverviewData',\n\t\t\t});\n\t\t}\n\n\t\tif (!(options.chartOptions && options.chartOptions.name)) {\n\t\t\tconsole.log('Incorrect analytics options');\n\t\t\treturn;\n\t\t}\n\n\t\treturn RocketChat.Livechat.Analytics.getAgentOverviewData(options);\n\t},\n});\n","Meteor.methods({\n\t'livechat:getAnalyticsChartData'(options) {\n\t\tif (!Meteor.userId() || !RocketChat.authz.hasPermission(Meteor.userId(), 'view-livechat-manager')) {\n\t\t\tthrow new Meteor.Error('error-not-allowed', 'Not allowed', {\n\t\t\t\tmethod: 'livechat:getAnalyticsChartData',\n\t\t\t});\n\t\t}\n\n\t\tif (!(options.chartOptions && options.chartOptions.name)) {\n\t\t\tconsole.log('Incorrect chart options');\n\t\t\treturn;\n\t\t}\n\n\t\treturn RocketChat.Livechat.Analytics.getAnalyticsChartData(options);\n\t},\n});\n","Meteor.methods({\n\t'livechat:getAnalyticsOverviewData'(options) {\n\t\tif (!Meteor.userId() || !RocketChat.authz.hasPermission(Meteor.userId(), 'view-livechat-manager')) {\n\t\t\tthrow new Meteor.Error('error-not-allowed', 'Not allowed', {\n\t\t\t\tmethod: 'livechat:getAnalyticsOverviewData',\n\t\t\t});\n\t\t}\n\n\t\tif (!(options.analyticsOptions && options.analyticsOptions.name)) {\n\t\t\tconsole.log('Incorrect analytics options');\n\t\t\treturn;\n\t\t}\n\n\t\treturn RocketChat.Livechat.Analytics.getAnalyticsOverviewData(options);\n\t},\n});\n","import _ from 'underscore';\n\nimport LivechatVisitors from '../models/LivechatVisitors';\n\nMeteor.methods({\n\t'livechat:getInitialData'(visitorToken, departmentId) {\n\t\tconst info = {\n\t\t\tenabled: null,\n\t\t\ttitle: null,\n\t\t\tcolor: null,\n\t\t\tregistrationForm: null,\n\t\t\troom: null,\n\t\t\tvisitor: null,\n\t\t\ttriggers: [],\n\t\t\tdepartments: [],\n\t\t\tallowSwitchingDepartments: null,\n\t\t\tonline: true,\n\t\t\tofflineColor: null,\n\t\t\tofflineMessage: null,\n\t\t\tofflineSuccessMessage: null,\n\t\t\tofflineUnavailableMessage: null,\n\t\t\tdisplayOfflineForm: null,\n\t\t\tvideoCall: null,\n\t\t\tfileUpload: null,\n\t\t\tconversationFinishedMessage: null,\n\t\t\tnameFieldRegistrationForm: null,\n\t\t\temailFieldRegistrationForm: null,\n\t\t};\n\n\t\tconst options = {\n\t\t\tfields: {\n\t\t\t\tname: 1,\n\t\t\t\tt: 1,\n\t\t\t\tcl: 1,\n\t\t\t\tu: 1,\n\t\t\t\tusernames: 1,\n\t\t\t\tv: 1,\n\t\t\t\tservedBy: 1,\n\t\t\t\tdepartmentId: 1,\n\t\t\t},\n\t\t};\n\t\tconst room = (departmentId) ? RocketChat.models.Rooms.findOpenByVisitorTokenAndDepartmentId(visitorToken, departmentId, options).fetch() : RocketChat.models.Rooms.findOpenByVisitorToken(visitorToken, options).fetch();\n\t\tif (room && room.length > 0) {\n\t\t\tinfo.room = room[0];\n\t\t}\n\n\t\tconst visitor = LivechatVisitors.getVisitorByToken(visitorToken, {\n\t\t\tfields: {\n\t\t\t\tname: 1,\n\t\t\t\tusername: 1,\n\t\t\t\tvisitorEmails: 1,\n\t\t\t\tdepartment: 1,\n\t\t\t},\n\t\t});\n\n\t\tif (room) {\n\t\t\tinfo.visitor = visitor;\n\t\t}\n\n\t\tconst initSettings = RocketChat.Livechat.getInitSettings();\n\n\t\tinfo.title = initSettings.Livechat_title;\n\t\tinfo.color = initSettings.Livechat_title_color;\n\t\tinfo.enabled = initSettings.Livechat_enabled;\n\t\tinfo.registrationForm = initSettings.Livechat_registration_form;\n\t\tinfo.offlineTitle = initSettings.Livechat_offline_title;\n\t\tinfo.offlineColor = initSettings.Livechat_offline_title_color;\n\t\tinfo.offlineMessage = initSettings.Livechat_offline_message;\n\t\tinfo.offlineSuccessMessage = initSettings.Livechat_offline_success_message;\n\t\tinfo.offlineUnavailableMessage = initSettings.Livechat_offline_form_unavailable;\n\t\tinfo.displayOfflineForm = initSettings.Livechat_display_offline_form;\n\t\tinfo.language = initSettings.Language;\n\t\tinfo.videoCall = initSettings.Livechat_videocall_enabled === true && initSettings.Jitsi_Enabled === true;\n\t\tinfo.fileUpload = initSettings.Livechat_fileupload_enabled && initSettings.FileUpload_Enabled;\n\t\tinfo.transcript = initSettings.Livechat_enable_transcript;\n\t\tinfo.transcriptMessage = initSettings.Livechat_transcript_message;\n\t\tinfo.conversationFinishedMessage = initSettings.Livechat_conversation_finished_message;\n\t\tinfo.nameFieldRegistrationForm = initSettings.Livechat_name_field_registration_form;\n\t\tinfo.emailFieldRegistrationForm = initSettings.Livechat_email_field_registration_form;\n\n\t\tinfo.agentData = room && room[0] && room[0].servedBy && RocketChat.models.Users.getAgentInfo(room[0].servedBy._id);\n\n\t\tRocketChat.models.LivechatTrigger.findEnabled().forEach((trigger) => {\n\t\t\tinfo.triggers.push(_.pick(trigger, '_id', 'actions', 'conditions', 'runOnce'));\n\t\t});\n\n\t\tRocketChat.models.LivechatDepartment.findEnabledWithAgents().forEach((department) => {\n\t\t\tinfo.departments.push(department);\n\t\t});\n\t\tinfo.allowSwitchingDepartments = initSettings.Livechat_allow_switching_departments;\n\n\t\tinfo.online = RocketChat.models.Users.findOnlineAgents().count() > 0;\n\t\treturn info;\n\t},\n});\n","Meteor.methods({\n\t'livechat:getNextAgent'({ token, department }) {\n\t\tcheck(token, String);\n\n\t\tconst room = RocketChat.models.Rooms.findOpenByVisitorToken(token).fetch();\n\n\t\tif (room && room.length > 0) {\n\t\t\treturn;\n\t\t}\n\n\t\tif (!department) {\n\t\t\tconst requireDeparment = RocketChat.Livechat.getRequiredDepartment();\n\t\t\tif (requireDeparment) {\n\t\t\t\tdepartment = requireDeparment._id;\n\t\t\t}\n\t\t}\n\n\t\tconst agent = RocketChat.Livechat.getNextAgent(department);\n\t\tif (!agent) {\n\t\t\treturn;\n\t\t}\n\n\t\treturn RocketChat.models.Users.getAgentInfo(agent.agentId);\n\t},\n});\n","import LivechatVisitors from '../models/LivechatVisitors';\n\nMeteor.methods({\n\t'livechat:loadHistory'({ token, rid, end, limit = 20, ls }) {\n\t\tconst visitor = LivechatVisitors.getVisitorByToken(token, { fields: { _id: 1 } });\n\n\t\tif (!visitor) {\n\t\t\treturn;\n\t\t}\n\n\t\treturn RocketChat.loadMessageHistory({ userId: visitor._id, rid, end, limit, ls });\n\t},\n});\n","import LivechatVisitors from '../models/LivechatVisitors';\n\nMeteor.methods({\n\t'livechat:loginByToken'(token) {\n\t\tconst visitor = LivechatVisitors.getVisitorByToken(token, { fields: { _id: 1 } });\n\n\t\tif (!visitor) {\n\t\t\treturn;\n\t\t}\n\n\t\treturn {\n\t\t\t_id: visitor._id,\n\t\t};\n\t},\n});\n","Meteor.methods({\n\t'livechat:pageVisited'(token, room, pageInfo) {\n\t\tRocketChat.Livechat.savePageHistory(token, room, pageInfo);\n\t},\n});\n","import LivechatVisitors from '../models/LivechatVisitors';\n\nMeteor.methods({\n\t'livechat:registerGuest'({ token, name, email, department, customFields } = {}) {\n\t\tconst userId = RocketChat.Livechat.registerGuest.call(this, {\n\t\t\ttoken,\n\t\t\tname,\n\t\t\temail,\n\t\t\tdepartment,\n\t\t});\n\n\t\t// update visited page history to not expire\n\t\tRocketChat.models.Messages.keepHistoryForToken(token);\n\n\t\tconst visitor = LivechatVisitors.getVisitorByToken(token, {\n\t\t\tfields: {\n\t\t\t\ttoken: 1,\n\t\t\t\tname: 1,\n\t\t\t\tusername: 1,\n\t\t\t\tvisitorEmails: 1,\n\t\t\t\tdepartment: 1,\n\t\t\t},\n\t\t});\n\n\t\t// If it's updating an existing visitor, it must also update the roomInfo\n\t\tconst cursor = RocketChat.models.Rooms.findOpenByVisitorToken(token);\n\t\tcursor.forEach((room) => {\n\t\t\tRocketChat.Livechat.saveRoomInfo(room, visitor);\n\t\t});\n\n\t\tif (customFields && customFields instanceof Array) {\n\t\t\tcustomFields.forEach((customField) => {\n\t\t\t\tif (typeof customField !== 'object') {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tif (!customField.scope || customField.scope !== 'room') {\n\t\t\t\t\tconst { key, value, overwrite } = customField;\n\t\t\t\t\tLivechatVisitors.updateLivechatDataByToken(token, key, value, overwrite);\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\n\t\treturn {\n\t\t\tuserId,\n\t\t\tvisitor,\n\t\t};\n\t},\n});\n","Meteor.methods({\n\t'livechat:removeAgent'(username) {\n\t\tif (!Meteor.userId() || !RocketChat.authz.hasPermission(Meteor.userId(), 'view-livechat-manager')) {\n\t\t\tthrow new Meteor.Error('error-not-allowed', 'Not allowed', { method: 'livechat:removeAgent' });\n\t\t}\n\n\t\treturn RocketChat.Livechat.removeAgent(username);\n\t},\n});\n","Meteor.methods({\n\t'livechat:removeCustomField'(_id) {\n\t\tif (!Meteor.userId() || !RocketChat.authz.hasPermission(Meteor.userId(), 'view-livechat-manager')) {\n\t\t\tthrow new Meteor.Error('error-not-allowed', 'Not allowed', { method: 'livechat:removeCustomField' });\n\t\t}\n\n\t\tcheck(_id, String);\n\n\t\tconst customField = RocketChat.models.LivechatCustomField.findOneById(_id, { fields: { _id: 1 } });\n\n\t\tif (!customField) {\n\t\t\tthrow new Meteor.Error('error-invalid-custom-field', 'Custom field not found', { method: 'livechat:removeCustomField' });\n\t\t}\n\n\t\treturn RocketChat.models.LivechatCustomField.removeById(_id);\n\t},\n});\n","Meteor.methods({\n\t'livechat:removeDepartment'(_id) {\n\t\tif (!Meteor.userId() || !RocketChat.authz.hasPermission(Meteor.userId(), 'view-livechat-manager')) {\n\t\t\tthrow new Meteor.Error('error-not-allowed', 'Not allowed', { method: 'livechat:removeDepartment' });\n\t\t}\n\n\t\treturn RocketChat.Livechat.removeDepartment(_id);\n\t},\n});\n","Meteor.methods({\n\t'livechat:removeManager'(username) {\n\t\tif (!Meteor.userId() || !RocketChat.authz.hasPermission(Meteor.userId(), 'view-livechat-manager')) {\n\t\t\tthrow new Meteor.Error('error-not-allowed', 'Not allowed', { method: 'livechat:removeManager' });\n\t\t}\n\n\t\treturn RocketChat.Livechat.removeManager(username);\n\t},\n});\n","Meteor.methods({\n\t'livechat:removeTrigger'(triggerId) {\n\t\tif (!Meteor.userId() || !RocketChat.authz.hasPermission(Meteor.userId(), 'view-livechat-manager')) {\n\t\t\tthrow new Meteor.Error('error-not-allowed', 'Not allowed', { method: 'livechat:removeTrigger' });\n\t\t}\n\n\t\tcheck(triggerId, String);\n\n\t\treturn RocketChat.models.LivechatTrigger.removeById(triggerId);\n\t},\n});\n","Meteor.methods({\n\t'livechat:removeRoom'(rid) {\n\t\tif (!Meteor.userId() || !RocketChat.authz.hasPermission(Meteor.userId(), 'remove-closed-livechat-rooms')) {\n\t\t\tthrow new Meteor.Error('error-not-allowed', 'Not allowed', { method: 'livechat:removeRoom' });\n\t\t}\n\n\t\tconst room = RocketChat.models.Rooms.findOneById(rid);\n\n\t\tif (!room) {\n\t\t\tthrow new Meteor.Error('error-invalid-room', 'Invalid room', {\n\t\t\t\tmethod: 'livechat:removeRoom',\n\t\t\t});\n\t\t}\n\n\t\tif (room.t !== 'l') {\n\t\t\tthrow new Meteor.Error('error-this-is-not-a-livechat-room', 'This is not a Livechat room', {\n\t\t\t\tmethod: 'livechat:removeRoom',\n\t\t\t});\n\t\t}\n\n\t\tif (room.open) {\n\t\t\tthrow new Meteor.Error('error-room-is-not-closed', 'Room is not closed', {\n\t\t\t\tmethod: 'livechat:removeRoom',\n\t\t\t});\n\t\t}\n\n\t\tRocketChat.models.Messages.removeByRoomId(rid);\n\t\tRocketChat.models.Subscriptions.removeByRoomId(rid);\n\t\treturn RocketChat.models.Rooms.removeById(rid);\n\t},\n});\n","Meteor.methods({\n\t'livechat:saveAppearance'(settings) {\n\t\tif (!Meteor.userId() || !RocketChat.authz.hasPermission(Meteor.userId(), 'view-livechat-manager')) {\n\t\t\tthrow new Meteor.Error('error-not-allowed', 'Not allowed', { method: 'livechat:saveAppearance' });\n\t\t}\n\n\t\tconst validSettings = [\n\t\t\t'Livechat_title',\n\t\t\t'Livechat_title_color',\n\t\t\t'Livechat_show_agent_email',\n\t\t\t'Livechat_display_offline_form',\n\t\t\t'Livechat_offline_form_unavailable',\n\t\t\t'Livechat_offline_message',\n\t\t\t'Livechat_offline_success_message',\n\t\t\t'Livechat_offline_title',\n\t\t\t'Livechat_offline_title_color',\n\t\t\t'Livechat_offline_email',\n\t\t\t'Livechat_conversation_finished_message',\n\t\t\t'Livechat_registration_form',\n\t\t\t'Livechat_name_field_registration_form',\n\t\t\t'Livechat_email_field_registration_form',\n\t\t];\n\n\t\tconst valid = settings.every((setting) => validSettings.indexOf(setting._id) !== -1);\n\n\t\tif (!valid) {\n\t\t\tthrow new Meteor.Error('invalid-setting');\n\t\t}\n\n\t\tsettings.forEach((setting) => {\n\t\t\tRocketChat.settings.updateById(setting._id, setting.value);\n\t\t});\n\n\t\treturn;\n\t},\n});\n","/* eslint new-cap: [2, {\"capIsNewExceptions\": [\"Match.ObjectIncluding\", \"Match.Optional\"]}] */\n\nMeteor.methods({\n\t'livechat:saveCustomField'(_id, customFieldData) {\n\t\tif (!Meteor.userId() || !RocketChat.authz.hasPermission(Meteor.userId(), 'view-livechat-manager')) {\n\t\t\tthrow new Meteor.Error('error-not-allowed', 'Not allowed', { method: 'livechat:saveCustomField' });\n\t\t}\n\n\t\tif (_id) {\n\t\t\tcheck(_id, String);\n\t\t}\n\n\t\tcheck(customFieldData, Match.ObjectIncluding({ field: String, label: String, scope: String, visibility: String }));\n\n\t\tif (!/^[0-9a-zA-Z-_]+$/.test(customFieldData.field)) {\n\t\t\tthrow new Meteor.Error('error-invalid-custom-field-nmae', 'Invalid custom field name. Use only letters, numbers, hyphens and underscores.', { method: 'livechat:saveCustomField' });\n\t\t}\n\n\t\tif (_id) {\n\t\t\tconst customField = RocketChat.models.LivechatCustomField.findOneById(_id);\n\t\t\tif (!customField) {\n\t\t\t\tthrow new Meteor.Error('error-invalid-custom-field', 'Custom Field Not found', { method: 'livechat:saveCustomField' });\n\t\t\t}\n\t\t}\n\n\t\treturn RocketChat.models.LivechatCustomField.createOrUpdateCustomField(_id, customFieldData.field, customFieldData.label, customFieldData.scope, customFieldData.visibility);\n\t},\n});\n","Meteor.methods({\n\t'livechat:saveDepartment'(_id, departmentData, departmentAgents) {\n\t\tif (!Meteor.userId() || !RocketChat.authz.hasPermission(Meteor.userId(), 'view-livechat-manager')) {\n\t\t\tthrow new Meteor.Error('error-not-allowed', 'Not allowed', { method: 'livechat:saveDepartment' });\n\t\t}\n\n\t\treturn RocketChat.Livechat.saveDepartment(_id, departmentData, departmentAgents);\n\t},\n});\n","/* eslint new-cap: [2, {\"capIsNewExceptions\": [\"Match.ObjectIncluding\", \"Match.Optional\"]}] */\n\nMeteor.methods({\n\t'livechat:saveInfo'(guestData, roomData) {\n\t\tif (!Meteor.userId() || !RocketChat.authz.hasPermission(Meteor.userId(), 'view-l-room')) {\n\t\t\tthrow new Meteor.Error('error-not-allowed', 'Not allowed', { method: 'livechat:saveInfo' });\n\t\t}\n\n\t\tcheck(guestData, Match.ObjectIncluding({\n\t\t\t_id: String,\n\t\t\tname: Match.Optional(String),\n\t\t\temail: Match.Optional(String),\n\t\t\tphone: Match.Optional(String),\n\t\t}));\n\n\t\tcheck(roomData, Match.ObjectIncluding({\n\t\t\t_id: String,\n\t\t\ttopic: Match.Optional(String),\n\t\t\ttags: Match.Optional(String),\n\t\t}));\n\n\t\tconst room = RocketChat.models.Rooms.findOneById(roomData._id, { fields: { t: 1, servedBy: 1 } });\n\n\t\tif (room == null || room.t !== 'l') {\n\t\t\tthrow new Meteor.Error('error-invalid-room', 'Invalid room', { method: 'livechat:saveInfo' });\n\t\t}\n\n\t\tif ((!room.servedBy || room.servedBy._id !== Meteor.userId()) && !RocketChat.authz.hasPermission(Meteor.userId(), 'save-others-livechat-room-info')) {\n\t\t\tthrow new Meteor.Error('error-not-allowed', 'Not allowed', { method: 'livechat:saveInfo' });\n\t\t}\n\n\t\tconst ret = RocketChat.Livechat.saveGuest(guestData) && RocketChat.Livechat.saveRoomInfo(roomData, guestData);\n\n\t\tMeteor.defer(() => {\n\t\t\tRocketChat.callbacks.run('livechat.saveInfo', RocketChat.models.Rooms.findOneById(roomData._id));\n\t\t});\n\n\t\treturn ret;\n\t},\n});\n","import s from 'underscore.string';\n\nMeteor.methods({\n\t'livechat:saveIntegration'(values) {\n\t\tif (!Meteor.userId() || !RocketChat.authz.hasPermission(Meteor.userId(), 'view-livechat-manager')) {\n\t\t\tthrow new Meteor.Error('error-not-allowed', 'Not allowed', { method: 'livechat:saveIntegration' });\n\t\t}\n\n\t\tif (typeof values.Livechat_webhookUrl !== 'undefined') {\n\t\t\tRocketChat.settings.updateById('Livechat_webhookUrl', s.trim(values.Livechat_webhookUrl));\n\t\t}\n\n\t\tif (typeof values.Livechat_secret_token !== 'undefined') {\n\t\t\tRocketChat.settings.updateById('Livechat_secret_token', s.trim(values.Livechat_secret_token));\n\t\t}\n\n\t\tif (typeof values.Livechat_webhook_on_close !== 'undefined') {\n\t\t\tRocketChat.settings.updateById('Livechat_webhook_on_close', !!values.Livechat_webhook_on_close);\n\t\t}\n\n\t\tif (typeof values.Livechat_webhook_on_offline_msg !== 'undefined') {\n\t\t\tRocketChat.settings.updateById('Livechat_webhook_on_offline_msg', !!values.Livechat_webhook_on_offline_msg);\n\t\t}\n\n\t\tif (typeof values.Livechat_webhook_on_visitor_message !== 'undefined') {\n\t\t\tRocketChat.settings.updateById('Livechat_webhook_on_visitor_message', !!values.Livechat_webhook_on_visitor_message);\n\t\t}\n\n\t\tif (typeof values.Livechat_webhook_on_agent_message !== 'undefined') {\n\t\t\tRocketChat.settings.updateById('Livechat_webhook_on_agent_message', !!values.Livechat_webhook_on_agent_message);\n\t\t}\n\n\t\treturn;\n\t},\n});\n","/* eslint new-cap: [2, {\"capIsNewExceptions\": [\"Match.ObjectIncluding\"]}] */\nimport LivechatVisitors from '../models/LivechatVisitors';\nimport _ from 'underscore';\n\nMeteor.methods({\n\t'livechat:saveSurveyFeedback'(visitorToken, visitorRoom, formData) {\n\t\tcheck(visitorToken, String);\n\t\tcheck(visitorRoom, String);\n\t\tcheck(formData, [Match.ObjectIncluding({ name: String, value: String })]);\n\n\t\tconst visitor = LivechatVisitors.getVisitorByToken(visitorToken);\n\t\tconst room = RocketChat.models.Rooms.findOneById(visitorRoom);\n\n\t\tif (visitor !== undefined && room !== undefined && room.v !== undefined && room.v.token === visitor.token) {\n\t\t\tconst updateData = {};\n\t\t\tfor (const item of formData) {\n\t\t\t\tif (_.contains(['satisfaction', 'agentKnowledge', 'agentResposiveness', 'agentFriendliness'], item.name) && _.contains(['1', '2', '3', '4', '5'], item.value)) {\n\t\t\t\t\tupdateData[item.name] = item.value;\n\t\t\t\t} else if (item.name === 'additionalFeedback') {\n\t\t\t\t\tupdateData[item.name] = item.value;\n\t\t\t\t}\n\t\t\t}\n\t\t\tif (!_.isEmpty(updateData)) {\n\t\t\t\treturn RocketChat.models.Rooms.updateSurveyFeedbackById(room._id, updateData);\n\t\t\t}\n\t\t}\n\t},\n});\n","Meteor.methods({\n\t'livechat:saveTrigger'(trigger) {\n\t\tif (!Meteor.userId() || !RocketChat.authz.hasPermission(Meteor.userId(), 'view-livechat-manager')) {\n\t\t\tthrow new Meteor.Error('error-not-allowed', 'Not allowed', { method: 'livechat:saveTrigger' });\n\t\t}\n\n\t\tcheck(trigger, {\n\t\t\t_id: Match.Maybe(String),\n\t\t\tname: String,\n\t\t\tdescription: String,\n\t\t\tenabled: Boolean,\n\t\t\trunOnce: Boolean,\n\t\t\tconditions: Array,\n\t\t\tactions: Array,\n\t\t});\n\n\t\tif (trigger._id) {\n\t\t\treturn RocketChat.models.LivechatTrigger.updateById(trigger._id, trigger);\n\t\t} else {\n\t\t\treturn RocketChat.models.LivechatTrigger.insert(trigger);\n\t\t}\n\t},\n});\n","import _ from 'underscore';\n\nMeteor.methods({\n\t'livechat:searchAgent'(username) {\n\t\tif (!Meteor.userId() || !RocketChat.authz.hasPermission(Meteor.userId(), 'view-livechat-manager')) {\n\t\t\tthrow new Meteor.Error('error-not-allowed', 'Not allowed', { method: 'livechat:searchAgent' });\n\t\t}\n\n\t\tif (!username || !_.isString(username)) {\n\t\t\tthrow new Meteor.Error('error-invalid-arguments', 'Invalid arguments', { method: 'livechat:searchAgent' });\n\t\t}\n\n\t\tconst user = RocketChat.models.Users.findOneByUsername(username, { fields: { _id: 1, username: 1 } });\n\n\t\tif (!user) {\n\t\t\tthrow new Meteor.Error('error-invalid-user', 'Invalid user', { method: 'livechat:searchAgent' });\n\t\t}\n\n\t\treturn user;\n\t},\n});\n","import LivechatVisitors from '../models/LivechatVisitors';\n\nMeteor.methods({\n\tsendMessageLivechat({ token, _id, rid, msg, attachments }, agent) {\n\t\tcheck(token, String);\n\t\tcheck(_id, String);\n\t\tcheck(rid, String);\n\t\tcheck(msg, String);\n\n\t\tcheck(agent, Match.Maybe({\n\t\t\tagentId: String,\n\t\t\tusername: String,\n\t\t}));\n\n\t\tconst guest = LivechatVisitors.getVisitorByToken(token, {\n\t\t\tfields: {\n\t\t\t\tname: 1,\n\t\t\t\tusername: 1,\n\t\t\t\tdepartment: 1,\n\t\t\t\ttoken: 1,\n\t\t\t},\n\t\t});\n\n\t\tif (!guest) {\n\t\t\tthrow new Meteor.Error('invalid-token');\n\t\t}\n\n\t\treturn RocketChat.Livechat.sendMessage({\n\t\t\tguest,\n\t\t\tmessage: {\n\t\t\t\t_id,\n\t\t\t\trid,\n\t\t\t\tmsg,\n\t\t\t\ttoken,\n\t\t\t\tattachments,\n\t\t\t},\n\t\t\tagent,\n\t\t});\n\t},\n});\n","import LivechatVisitors from '../models/LivechatVisitors';\n\nMeteor.methods({\n\tasync 'sendFileLivechatMessage'(roomId, visitorToken, file, msgData = {}) {\n\t\tconst visitor = LivechatVisitors.getVisitorByToken(visitorToken);\n\n\t\tif (!visitor) {\n\t\t\treturn false;\n\t\t}\n\n\t\tconst room = RocketChat.models.Rooms.findOneOpenByRoomIdAndVisitorToken(roomId, visitorToken);\n\n\t\tif (!room) {\n\t\t\treturn false;\n\t\t}\n\n\t\tcheck(msgData, {\n\t\t\tavatar: Match.Optional(String),\n\t\t\temoji: Match.Optional(String),\n\t\t\talias: Match.Optional(String),\n\t\t\tgroupable: Match.Optional(Boolean),\n\t\t\tmsg: Match.Optional(String),\n\t\t});\n\n\t\tconst fileUrl = `/file-upload/${ file._id }/${ encodeURI(file.name) }`;\n\n\t\tconst attachment = {\n\t\t\ttitle: file.name,\n\t\t\ttype: 'file',\n\t\t\tdescription: file.description,\n\t\t\ttitle_link: fileUrl,\n\t\t\ttitle_link_download: true,\n\t\t};\n\n\t\tif (/^image\\/.+/.test(file.type)) {\n\t\t\tattachment.image_url = fileUrl;\n\t\t\tattachment.image_type = file.type;\n\t\t\tattachment.image_size = file.size;\n\t\t\tif (file.identify && file.identify.size) {\n\t\t\t\tattachment.image_dimensions = file.identify.size;\n\t\t\t}\n\t\t\tattachment.image_preview = await FileUpload.resizeImagePreview(file);\n\t\t} else if (/^audio\\/.+/.test(file.type)) {\n\t\t\tattachment.audio_url = fileUrl;\n\t\t\tattachment.audio_type = file.type;\n\t\t\tattachment.audio_size = file.size;\n\t\t} else if (/^video\\/.+/.test(file.type)) {\n\t\t\tattachment.video_url = fileUrl;\n\t\t\tattachment.video_type = file.type;\n\t\t\tattachment.video_size = file.size;\n\t\t}\n\n\t\tconst msg = Object.assign({\n\t\t\t_id: Random.id(),\n\t\t\trid: roomId,\n\t\t\tts: new Date(),\n\t\t\tmsg: '',\n\t\t\tfile: {\n\t\t\t\t_id: file._id,\n\t\t\t\tname: file.name,\n\t\t\t\ttype: file.type,\n\t\t\t},\n\t\t\tgroupable: false,\n\t\t\tattachments: [attachment],\n\t\t\ttoken: visitorToken,\n\t\t}, msgData);\n\n\t\treturn Meteor.call('sendMessageLivechat', msg);\n\t},\n});\n","/* globals DDPRateLimiter */\n\nMeteor.methods({\n\t'livechat:sendOfflineMessage'(data) {\n\t\tcheck(data, {\n\t\t\tname: String,\n\t\t\temail: String,\n\t\t\tmessage: String,\n\t\t});\n\n\t\treturn RocketChat.Livechat.sendOfflineMessage(data);\n\t},\n});\n\nDDPRateLimiter.addRule({\n\ttype: 'method',\n\tname: 'livechat:sendOfflineMessage',\n\tconnectionId() {\n\t\treturn true;\n\t},\n}, 1, 5000);\n","import LivechatVisitors from '../models/LivechatVisitors';\n\nMeteor.methods({\n\t'livechat:setCustomField'(token, key, value, overwrite = true) {\n\t\tconst customField = RocketChat.models.LivechatCustomField.findOneById(key);\n\t\tif (customField) {\n\t\t\tif (customField.scope === 'room') {\n\t\t\t\treturn RocketChat.models.Rooms.updateLivechatDataByToken(token, key, value, overwrite);\n\t\t\t} else {\n\t\t\t\t// Save in user\n\t\t\t\treturn LivechatVisitors.updateLivechatDataByToken(token, key, value, overwrite);\n\t\t\t}\n\t\t}\n\n\t\treturn true;\n\t},\n});\n","import LivechatVisitors from '../models/LivechatVisitors';\n\nMeteor.methods({\n\t'livechat:setDepartmentForVisitor'({ roomId, visitorToken, departmentId } = {}) {\n\t\tcheck(roomId, String);\n\t\tcheck(visitorToken, String);\n\t\tcheck(departmentId, String);\n\n\t\tconst room = RocketChat.models.Rooms.findOneById(roomId);\n\t\tconst visitor = LivechatVisitors.getVisitorByToken(visitorToken);\n\n\t\tif (!room || room.t !== 'l' || !room.v || room.v.token !== visitor.token) {\n\t\t\tthrow new Meteor.Error('error-invalid-room', 'Invalid room');\n\t\t}\n\n\t\t// update visited page history to not expire\n\t\tRocketChat.models.Messages.keepHistoryForToken(visitorToken);\n\n\t\tconst transferData = {\n\t\t\troomId,\n\t\t\tdepartmentId,\n\t\t};\n\n\t\treturn RocketChat.Livechat.transfer(room, visitor, transferData);\n\t},\n});\n","/* eslint new-cap: [2, {\"capIsNewExceptions\": [\"MD5\"]}] */\nMeteor.methods({\n\t'livechat:startVideoCall'(roomId) {\n\t\tif (!Meteor.userId()) {\n\t\t\tthrow new Meteor.Error('error-not-authorized', 'Not authorized', { method: 'livechat:closeByVisitor' });\n\t\t}\n\n\t\tconst guest = Meteor.user();\n\n\t\tconst message = {\n\t\t\t_id: Random.id(),\n\t\t\trid: roomId || Random.id(),\n\t\t\tmsg: '',\n\t\t\tts: new Date(),\n\t\t};\n\n\t\tconst { room } = RocketChat.Livechat.getRoom(guest, message, { jitsiTimeout: new Date(Date.now() + 3600 * 1000) });\n\t\tmessage.rid = room._id;\n\n\t\tRocketChat.models.Messages.createWithTypeRoomIdMessageAndUser('livechat_video_call', room._id, '', guest, {\n\t\t\tactionLinks: [\n\t\t\t\t{ icon: 'icon-videocam', i18nLabel: 'Accept', method_id: 'createLivechatCall', params: '' },\n\t\t\t\t{ icon: 'icon-cancel', i18nLabel: 'Decline', method_id: 'denyLivechatCall', params: '' },\n\t\t\t],\n\t\t});\n\n\t\treturn {\n\t\t\troomId: room._id,\n\t\t\tdomain: RocketChat.settings.get('Jitsi_Domain'),\n\t\t\tjitsiRoom: RocketChat.settings.get('Jitsi_URL_Room_Prefix') + RocketChat.settings.get('uniqueID') + roomId,\n\t\t};\n\t},\n});\n\n","import LivechatVisitors from '../models/LivechatVisitors';\n\nMeteor.methods({\n\t'livechat:startFileUploadRoom'(roomId, token) {\n\t\tconst guest = LivechatVisitors.getVisitorByToken(token);\n\n\t\tconst message = {\n\t\t\t_id: Random.id(),\n\t\t\trid: roomId || Random.id(),\n\t\t\tmsg: '',\n\t\t\tts: new Date(),\n\t\t\ttoken: guest.token,\n\t\t};\n\n\t\treturn RocketChat.Livechat.getRoom(guest, message);\n\t},\n});\n","/* eslint new-cap: [2, {\"capIsNewExceptions\": [\"Match.Optional\"]}] */\n\nimport LivechatVisitors from '../models/LivechatVisitors';\n\nMeteor.methods({\n\t'livechat:transfer'(transferData) {\n\t\tif (!Meteor.userId() || !RocketChat.authz.hasPermission(Meteor.userId(), 'view-l-room')) {\n\t\t\tthrow new Meteor.Error('error-not-allowed', 'Not allowed', { method: 'livechat:transfer' });\n\t\t}\n\n\t\tcheck(transferData, {\n\t\t\troomId: String,\n\t\t\tuserId: Match.Optional(String),\n\t\t\tdepartmentId: Match.Optional(String),\n\t\t});\n\n\t\tconst room = RocketChat.models.Rooms.findOneById(transferData.roomId);\n\n\t\tconst guest = LivechatVisitors.findOneById(room.v._id);\n\n\t\tconst subscription = RocketChat.models.Subscriptions.findOneByRoomIdAndUserId(room._id, Meteor.userId(), { fields: { _id: 1 } });\n\t\tif (!subscription && !RocketChat.authz.hasRole(Meteor.userId(), 'livechat-manager')) {\n\t\t\tthrow new Meteor.Error('error-not-authorized', 'Not authorized', { method: 'livechat:transfer' });\n\t\t}\n\n\t\treturn RocketChat.Livechat.transfer(room, guest, transferData);\n\t},\n});\n","/* globals HTTP */\nconst postCatchError = Meteor.wrapAsync(function(url, options, resolve) {\n\tHTTP.post(url, options, function(err, res) {\n\t\tif (err) {\n\t\t\tresolve(null, err.response);\n\t\t} else {\n\t\t\tresolve(null, res);\n\t\t}\n\t});\n});\n\nMeteor.methods({\n\t'livechat:webhookTest'() {\n\t\tthis.unblock();\n\n\t\tconst sampleData = {\n\t\t\ttype: 'LivechatSession',\n\t\t\t_id: 'fasd6f5a4sd6f8a4sdf',\n\t\t\tlabel: 'title',\n\t\t\ttopic: 'asiodojf',\n\t\t\tcreatedAt: new Date(),\n\t\t\tlastMessageAt: new Date(),\n\t\t\ttags: [\n\t\t\t\t'tag1',\n\t\t\t\t'tag2',\n\t\t\t\t'tag3',\n\t\t\t],\n\t\t\tcustomFields: {\n\t\t\t\tproductId: '123456',\n\t\t\t},\n\t\t\tvisitor: {\n\t\t\t\t_id: '',\n\t\t\t\tname: 'visitor name',\n\t\t\t\tusername: 'visitor-username',\n\t\t\t\tdepartment: 'department',\n\t\t\t\temail: 'email@address.com',\n\t\t\t\tphone: '192873192873',\n\t\t\t\tip: '123.456.7.89',\n\t\t\t\tbrowser: 'Chrome',\n\t\t\t\tos: 'Linux',\n\t\t\t\tcustomFields: {\n\t\t\t\t\tcustomerId: '123456',\n\t\t\t\t},\n\t\t\t},\n\t\t\tagent: {\n\t\t\t\t_id: 'asdf89as6df8',\n\t\t\t\tusername: 'agent.username',\n\t\t\t\tname: 'Agent Name',\n\t\t\t\temail: 'agent@email.com',\n\t\t\t},\n\t\t\tmessages: [{\n\t\t\t\tusername: 'visitor-username',\n\t\t\t\tmsg: 'message content',\n\t\t\t\tts: new Date(),\n\t\t\t}, {\n\t\t\t\tusername: 'agent.username',\n\t\t\t\tagentId: 'asdf89as6df8',\n\t\t\t\tmsg: 'message content from agent',\n\t\t\t\tts: new Date(),\n\t\t\t}],\n\t\t};\n\n\t\tconst options = {\n\t\t\theaders: {\n\t\t\t\t'X-RocketChat-Livechat-Token': RocketChat.settings.get('Livechat_secret_token'),\n\t\t\t},\n\t\t\tdata: sampleData,\n\t\t};\n\n\t\tconst response = postCatchError(RocketChat.settings.get('Livechat_webhookUrl'), options);\n\n\t\tconsole.log('response ->', response);\n\n\t\tif (response && response.statusCode && response.statusCode === 200) {\n\t\t\treturn true;\n\t\t} else {\n\t\t\tthrow new Meteor.Error('error-invalid-webhook-response');\n\t\t}\n\t},\n});\n\n","Meteor.methods({\n\t'livechat:takeInquiry'(inquiryId) {\n\t\tif (!Meteor.userId() || !RocketChat.authz.hasPermission(Meteor.userId(), 'view-l-room')) {\n\t\t\tthrow new Meteor.Error('error-not-allowed', 'Not allowed', { method: 'livechat:takeInquiry' });\n\t\t}\n\n\t\tconst inquiry = RocketChat.models.LivechatInquiry.findOneById(inquiryId);\n\n\t\tif (!inquiry || inquiry.status === 'taken') {\n\t\t\tthrow new Meteor.Error('error-not-allowed', 'Inquiry already taken', { method: 'livechat:takeInquiry' });\n\t\t}\n\n\t\tconst user = RocketChat.models.Users.findOneById(Meteor.userId());\n\n\t\tconst agent = {\n\t\t\tagentId: user._id,\n\t\t\tusername: user.username,\n\t\t\tts: new Date(),\n\t\t};\n\n\t\t// add subscription\n\t\tconst subscriptionData = {\n\t\t\trid: inquiry.rid,\n\t\t\tname: inquiry.name,\n\t\t\talert: true,\n\t\t\topen: true,\n\t\t\tunread: 1,\n\t\t\tuserMentions: 1,\n\t\t\tgroupMentions: 0,\n\t\t\tu: {\n\t\t\t\t_id: agent.agentId,\n\t\t\t\tusername: agent.username,\n\t\t\t},\n\t\t\tt: 'l',\n\t\t\tdesktopNotifications: 'all',\n\t\t\tmobilePushNotifications: 'all',\n\t\t\temailNotifications: 'all',\n\t\t};\n\n\t\tRocketChat.models.Subscriptions.insert(subscriptionData);\n\t\tRocketChat.models.Rooms.incUsersCountById(inquiry.rid);\n\n\t\t// update room\n\t\tconst room = RocketChat.models.Rooms.findOneById(inquiry.rid);\n\n\t\tRocketChat.models.Rooms.changeAgentByRoomId(inquiry.rid, agent);\n\n\t\troom.servedBy = {\n\t\t\t_id: agent.agentId,\n\t\t\tusername: agent.username,\n\t\t\tts: agent.ts,\n\t\t};\n\n\t\t// mark inquiry as taken\n\t\tRocketChat.models.LivechatInquiry.takeInquiry(inquiry._id);\n\n\t\t// remove sending message from guest widget\n\t\t// dont check if setting is true, because if settingwas switched off inbetween  guest entered pool,\n\t\t// and inquiry being taken, message would not be switched off.\n\t\tRocketChat.models.Messages.createCommandWithRoomIdAndUser('connected', room._id, user);\n\n\t\tRocketChat.Livechat.stream.emit(room._id, {\n\t\t\ttype: 'agentData',\n\t\t\tdata: RocketChat.models.Users.getAgentInfo(agent.agentId),\n\t\t});\n\n\t\t// return inquiry (for redirecting agent to the room route)\n\t\treturn inquiry;\n\t},\n});\n","Meteor.methods({\n\t'livechat:returnAsInquiry'(rid, departmentId) {\n\t\tif (!Meteor.userId() || !RocketChat.authz.hasPermission(Meteor.userId(), 'view-l-room')) {\n\t\t\tthrow new Meteor.Error('error-not-allowed', 'Not allowed', { method: 'livechat:saveDepartment' });\n\t\t}\n\n\t\treturn RocketChat.Livechat.returnRoomAsInquiry(rid, departmentId);\n\t},\n});\n","Meteor.methods({\n\t'livechat:saveOfficeHours'(day, start, finish, open) {\n\t\tRocketChat.models.LivechatOfficeHour.updateHours(day, start, finish, open);\n\t},\n});\n","/* globals DDPRateLimiter */\n\nMeteor.methods({\n\t'livechat:sendTranscript'(token, rid, email) {\n\t\tcheck(rid, String);\n\t\tcheck(email, String);\n\n\t\treturn RocketChat.Livechat.sendTranscript({ token, rid, email });\n\t},\n});\n\nDDPRateLimiter.addRule({\n\ttype: 'method',\n\tname: 'livechat:sendTranscript',\n\tconnectionId() {\n\t\treturn true;\n\t},\n}, 1, 5000);\n","/**\n * Sets an user as (non)operator\n * @param {string} _id - User's _id\n * @param {boolean} operator - Flag to set as operator or not\n */\nRocketChat.models.Users.setOperator = function(_id, operator) {\n\tconst update = {\n\t\t$set: {\n\t\t\toperator,\n\t\t},\n\t};\n\n\treturn this.update(_id, update);\n};\n\n/**\n * Gets all online agents\n * @return\n */\nRocketChat.models.Users.findOnlineAgents = function() {\n\tconst query = {\n\t\tstatus: {\n\t\t\t$exists: true,\n\t\t\t$ne: 'offline',\n\t\t},\n\t\tstatusLivechat: 'available',\n\t\troles: 'livechat-agent',\n\t};\n\n\treturn this.find(query);\n};\n\n/**\n * Find an online agent by his username\n * @return\n */\nRocketChat.models.Users.findOneOnlineAgentByUsername = function(username) {\n\tconst query = {\n\t\tusername,\n\t\tstatus: {\n\t\t\t$exists: true,\n\t\t\t$ne: 'offline',\n\t\t},\n\t\tstatusLivechat: 'available',\n\t\troles: 'livechat-agent',\n\t};\n\n\treturn this.findOne(query);\n};\n\n/**\n * Gets all agents\n * @return\n */\nRocketChat.models.Users.findAgents = function() {\n\tconst query = {\n\t\troles: 'livechat-agent',\n\t};\n\n\treturn this.find(query);\n};\n\n/**\n * Find online users from a list\n * @param {array} userList - array of usernames\n * @return\n */\nRocketChat.models.Users.findOnlineUserFromList = function(userList) {\n\tconst query = {\n\t\tstatus: {\n\t\t\t$exists: true,\n\t\t\t$ne: 'offline',\n\t\t},\n\t\tstatusLivechat: 'available',\n\t\troles: 'livechat-agent',\n\t\tusername: {\n\t\t\t$in: [].concat(userList),\n\t\t},\n\t};\n\n\treturn this.find(query);\n};\n\n/**\n * Get next user agent in order\n * @return {object} User from db\n */\nRocketChat.models.Users.getNextAgent = function() {\n\tconst query = {\n\t\tstatus: {\n\t\t\t$exists: true,\n\t\t\t$ne: 'offline',\n\t\t},\n\t\tstatusLivechat: 'available',\n\t\troles: 'livechat-agent',\n\t};\n\n\tconst collectionObj = this.model.rawCollection();\n\tconst findAndModify = Meteor.wrapAsync(collectionObj.findAndModify, collectionObj);\n\n\tconst sort = {\n\t\tlivechatCount: 1,\n\t\tusername: 1,\n\t};\n\n\tconst update = {\n\t\t$inc: {\n\t\t\tlivechatCount: 1,\n\t\t},\n\t};\n\n\tconst user = findAndModify(query, sort, update);\n\tif (user && user.value) {\n\t\treturn {\n\t\t\tagentId: user.value._id,\n\t\t\tusername: user.value.username,\n\t\t};\n\t} else {\n\t\treturn null;\n\t}\n};\n\n/**\n * Change user's livechat status\n * @param {string} token - Visitor token\n */\nRocketChat.models.Users.setLivechatStatus = function(userId, status) {\n\tconst query = {\n\t\t_id: userId,\n\t};\n\n\tconst update = {\n\t\t$set: {\n\t\t\tstatusLivechat: status,\n\t\t},\n\t};\n\n\treturn this.update(query, update);\n};\n\n/**\n * change all livechat agents livechat status to \"not-available\"\n */\nRocketChat.models.Users.closeOffice = function() {\n\tself = this;\n\tself.findAgents().forEach(function(agent) {\n\t\tself.setLivechatStatus(agent._id, 'not-available');\n\t});\n};\n\n/**\n * change all livechat agents livechat status to \"available\"\n */\nRocketChat.models.Users.openOffice = function() {\n\tself = this;\n\tself.findAgents().forEach(function(agent) {\n\t\tself.setLivechatStatus(agent._id, 'available');\n\t});\n};\n\nRocketChat.models.Users.getAgentInfo = function(agentId) {\n\tconst query = {\n\t\t_id: agentId,\n\t};\n\n\tconst options = {\n\t\tfields: {\n\t\t\tname: 1,\n\t\t\tusername: 1,\n\t\t\tphone: 1,\n\t\t\tcustomFields: 1,\n\t\t},\n\t};\n\n\tif (RocketChat.settings.get('Livechat_show_agent_email')) {\n\t\toptions.fields.emails = 1;\n\t}\n\n\treturn this.findOne(query, options);\n};\n","import _ from 'underscore';\n\n/**\n * Gets visitor by token\n * @param {string} token - Visitor token\n */\nRocketChat.models.Rooms.updateSurveyFeedbackById = function(_id, surveyFeedback) {\n\tconst query = {\n\t\t_id,\n\t};\n\n\tconst update = {\n\t\t$set: {\n\t\t\tsurveyFeedback,\n\t\t},\n\t};\n\n\treturn this.update(query, update);\n};\n\nRocketChat.models.Rooms.updateLivechatDataByToken = function(token, key, value, overwrite = true) {\n\tconst query = {\n\t\t'v.token': token,\n\t\topen: true,\n\t};\n\n\tif (!overwrite) {\n\t\tconst room = this.findOne(query, { fields: { livechatData: 1 } });\n\t\tif (room.livechatData && typeof room.livechatData[key] !== 'undefined') {\n\t\t\treturn true;\n\t\t}\n\t}\n\n\tconst update = {\n\t\t$set: {\n\t\t\t[`livechatData.${ key }`]: value,\n\t\t},\n\t};\n\n\treturn this.update(query, update);\n};\n\nRocketChat.models.Rooms.findLivechat = function(filter = {}, offset = 0, limit = 20) {\n\tconst query = _.extend(filter, {\n\t\tt: 'l',\n\t});\n\n\treturn this.find(query, { sort: { ts: - 1 }, offset, limit });\n};\n\nRocketChat.models.Rooms.findLivechatById = function(_id, fields) {\n\tconst options = {};\n\n\tif (fields) {\n\t\toptions.fields = fields;\n\t}\n\n\tconst query = {\n\t\tt: 'l',\n\t\t_id,\n\t};\n\n\treturn this.find(query, options);\n};\n\nRocketChat.models.Rooms.findLivechatByIdAndVisitorToken = function(_id, visitorToken, fields) {\n\tconst options = {};\n\n\tif (fields) {\n\t\toptions.fields = fields;\n\t}\n\n\tconst query = {\n\t\tt: 'l',\n\t\t_id,\n\t\t'v.token': visitorToken,\n\t};\n\n\treturn this.findOne(query, options);\n};\n\nRocketChat.models.Rooms.findLivechatByVisitorToken = function(visitorToken, fields) {\n\tconst options = {};\n\n\tif (fields) {\n\t\toptions.fields = fields;\n\t}\n\n\tconst query = {\n\t\tt: 'l',\n\t\t'v.token': visitorToken,\n\t};\n\n\treturn this.findOne(query, options);\n};\n\n/**\n * Get the next visitor name\n * @return {string} The next visitor name\n */\nRocketChat.models.Rooms.updateLivechatRoomCount = function() {\n\tconst settingsRaw = RocketChat.models.Settings.model.rawCollection();\n\tconst findAndModify = Meteor.wrapAsync(settingsRaw.findAndModify, settingsRaw);\n\n\tconst query = {\n\t\t_id: 'Livechat_Room_Count',\n\t};\n\n\tconst update = {\n\t\t$inc: {\n\t\t\tvalue: 1,\n\t\t},\n\t};\n\n\tconst livechatCount = findAndModify(query, null, update);\n\n\treturn livechatCount.value.value;\n};\n\nRocketChat.models.Rooms.findOpenByVisitorToken = function(visitorToken, options) {\n\tconst query = {\n\t\topen: true,\n\t\t'v.token': visitorToken,\n\t};\n\n\treturn this.find(query, options);\n};\n\nRocketChat.models.Rooms.findOpenByVisitorTokenAndDepartmentId = function(visitorToken, departmentId, options) {\n\tconst query = {\n\t\topen: true,\n\t\t'v.token': visitorToken,\n\t\tdepartmentId,\n\t};\n\n\treturn this.find(query, options);\n};\n\nRocketChat.models.Rooms.findByVisitorToken = function(visitorToken) {\n\tconst query = {\n\t\t'v.token': visitorToken,\n\t};\n\n\treturn this.find(query);\n};\n\nRocketChat.models.Rooms.findByVisitorId = function(visitorId) {\n\tconst query = {\n\t\t'v._id': visitorId,\n\t};\n\n\treturn this.find(query);\n};\n\nRocketChat.models.Rooms.findOneOpenByRoomIdAndVisitorToken = function(roomId, visitorToken, options) {\n\tconst query = {\n\t\t_id: roomId,\n\t\topen: true,\n\t\t'v.token': visitorToken,\n\t};\n\n\treturn this.findOne(query, options);\n};\n\nRocketChat.models.Rooms.setResponseByRoomId = function(roomId, response) {\n\treturn this.update({\n\t\t_id: roomId,\n\t}, {\n\t\t$set: {\n\t\t\tresponseBy: {\n\t\t\t\t_id: response.user._id,\n\t\t\t\tusername: response.user.username,\n\t\t\t},\n\t\t},\n\t\t$unset: {\n\t\t\twaitingResponse: 1,\n\t\t},\n\t});\n};\n\nRocketChat.models.Rooms.saveAnalyticsDataByRoomId = function(room, message, analyticsData) {\n\tconst update = {\n\t\t$set: {},\n\t};\n\n\tif (analyticsData) {\n\t\tupdate.$set['metrics.response.avg'] = analyticsData.avgResponseTime;\n\n\t\tupdate.$inc = {};\n\t\tupdate.$inc['metrics.response.total'] = 1;\n\t\tupdate.$inc['metrics.response.tt'] = analyticsData.responseTime;\n\t\tupdate.$inc['metrics.reaction.tt'] = analyticsData.reactionTime;\n\t}\n\n\tif (analyticsData && analyticsData.firstResponseTime) {\n\t\tupdate.$set['metrics.response.fd'] = analyticsData.firstResponseDate;\n\t\tupdate.$set['metrics.response.ft'] = analyticsData.firstResponseTime;\n\t\tupdate.$set['metrics.reaction.fd'] = analyticsData.firstReactionDate;\n\t\tupdate.$set['metrics.reaction.ft'] = analyticsData.firstReactionTime;\n\t}\n\n\t// livechat analytics : update last message timestamps\n\tconst visitorLastQuery = (room.metrics && room.metrics.v) ? room.metrics.v.lq : room.ts;\n\tconst agentLastReply = (room.metrics && room.metrics.servedBy) ? room.metrics.servedBy.lr : room.ts;\n\n\tif (message.token) {\t// update visitor timestamp, only if its new inquiry and not continuing message\n\t\tif (agentLastReply >= visitorLastQuery) {\t\t// if first query, not continuing query from visitor\n\t\t\tupdate.$set['metrics.v.lq'] = message.ts;\n\t\t}\n\t} else if (visitorLastQuery > agentLastReply) {\t\t// update agent timestamp, if first response, not continuing\n\t\tupdate.$set['metrics.servedBy.lr'] = message.ts;\n\t}\n\n\treturn this.update({\n\t\t_id: room._id,\n\t}, update);\n};\n\n/**\n * total no of conversations between date.\n * @param {string, {ISODate, ISODate}} t - string, room type. date.gte - ISODate (ts >= date.gte), date.lt- ISODate (ts < date.lt)\n * @return {int}\n */\n\nRocketChat.models.Rooms.getTotalConversationsBetweenDate = function(t, date) {\n\tconst query = {\n\t\tt,\n\t\tts: {\n\t\t\t$gte: new Date(date.gte),\t// ISO Date, ts >= date.gte\n\t\t\t$lt: new Date(date.lt),\t// ISODate, ts < date.lt\n\t\t},\n\t};\n\n\treturn this.find(query).count();\n};\n\nRocketChat.models.Rooms.getAnalyticsMetricsBetweenDate = function(t, date) {\n\tconst query = {\n\t\tt,\n\t\tts: {\n\t\t\t$gte: new Date(date.gte),\t// ISO Date, ts >= date.gte\n\t\t\t$lt: new Date(date.lt),\t// ISODate, ts < date.lt\n\t\t},\n\t};\n\n\treturn this.find(query, { fields: { ts: 1, departmentId: 1, open: 1, servedBy: 1, metrics: 1, msgs: 1 } });\n};\n\nRocketChat.models.Rooms.closeByRoomId = function(roomId, closeInfo) {\n\treturn this.update({\n\t\t_id: roomId,\n\t}, {\n\t\t$set: {\n\t\t\tcloser: closeInfo.closer,\n\t\t\tclosedBy: closeInfo.closedBy,\n\t\t\tclosedAt: closeInfo.closedAt,\n\t\t\t'metrics.chatDuration': closeInfo.chatDuration,\n\t\t\t'v.status': 'offline',\n\t\t},\n\t\t$unset: {\n\t\t\topen: 1,\n\t\t},\n\t});\n};\n\nRocketChat.models.Rooms.findOpenByAgent = function(userId) {\n\tconst query = {\n\t\topen: true,\n\t\t'servedBy._id': userId,\n\t};\n\n\treturn this.find(query);\n};\n\nRocketChat.models.Rooms.changeAgentByRoomId = function(roomId, newAgent) {\n\tconst query = {\n\t\t_id: roomId,\n\t};\n\tconst update = {\n\t\t$set: {\n\t\t\tservedBy: {\n\t\t\t\t_id: newAgent.agentId,\n\t\t\t\tusername: newAgent.username,\n\t\t\t\tts: new Date(),\n\t\t\t},\n\t\t},\n\t};\n\n\tif (newAgent.ts) {\n\t\tupdate.$set.servedBy.ts = newAgent.ts;\n\t}\n\n\tthis.update(query, update);\n};\n\nRocketChat.models.Rooms.changeDepartmentIdByRoomId = function(roomId, departmentId) {\n\tconst query = {\n\t\t_id: roomId,\n\t};\n\tconst update = {\n\t\t$set: {\n\t\t\tdepartmentId,\n\t\t},\n\t};\n\n\tthis.update(query, update);\n};\n\nRocketChat.models.Rooms.saveCRMDataByRoomId = function(roomId, crmData) {\n\tconst query = {\n\t\t_id: roomId,\n\t};\n\tconst update = {\n\t\t$set: {\n\t\t\tcrmData,\n\t\t},\n\t};\n\n\treturn this.update(query, update);\n};\n\nRocketChat.models.Rooms.updateVisitorStatus = function(token, status) {\n\tconst query = {\n\t\t'v.token': token,\n\t\topen: true,\n\t};\n\n\tconst update = {\n\t\t$set: {\n\t\t\t'v.status': status,\n\t\t},\n\t};\n\n\treturn this.update(query, update);\n};\n\nRocketChat.models.Rooms.removeAgentByRoomId = function(roomId) {\n\tconst query = {\n\t\t_id: roomId,\n\t};\n\tconst update = {\n\t\t$unset: {\n\t\t\tservedBy: 1,\n\t\t},\n\t};\n\n\tthis.update(query, update);\n};\n","RocketChat.models.Messages.keepHistoryForToken = function(token) {\n\treturn this.update({\n\t\t'navigation.token': token,\n\t\texpireAt: {\n\t\t\t$exists: true,\n\t\t},\n\t}, {\n\t\t$unset: {\n\t\t\texpireAt: 1,\n\t\t},\n\t}, {\n\t\tmulti: true,\n\t});\n};\n\nRocketChat.models.Messages.setRoomIdByToken = function(token, rid) {\n\treturn this.update({\n\t\t'navigation.token': token,\n\t\trid: null,\n\t}, {\n\t\t$set: {\n\t\t\trid,\n\t\t},\n\t}, {\n\t\tmulti: true,\n\t});\n};\n","class LivechatExternalMessage extends RocketChat.models._Base {\n\tconstructor() {\n\t\tsuper('livechat_external_message');\n\n\t\tif (Meteor.isClient) {\n\t\t\tthis._initModel('livechat_external_message');\n\t\t}\n\t}\n\n\t// FIND\n\tfindByRoomId(roomId, sort = { ts: -1 }) {\n\t\tconst query = { rid: roomId };\n\n\t\treturn this.find(query, { sort });\n\t}\n}\n\nRocketChat.models.LivechatExternalMessage = new LivechatExternalMessage();\n","import _ from 'underscore';\n\n/**\n * Livechat Custom Fields model\n */\nclass LivechatCustomField extends RocketChat.models._Base {\n\tconstructor() {\n\t\tsuper('livechat_custom_field');\n\t}\n\n\t// FIND\n\tfindOneById(_id, options) {\n\t\tconst query = { _id };\n\n\t\treturn this.findOne(query, options);\n\t}\n\n\tcreateOrUpdateCustomField(_id, field, label, scope, visibility, extraData) {\n\t\tconst record = {\n\t\t\tlabel,\n\t\t\tscope,\n\t\t\tvisibility,\n\t\t};\n\n\t\t_.extend(record, extraData);\n\n\t\tif (_id) {\n\t\t\tthis.update({ _id }, { $set: record });\n\t\t} else {\n\t\t\trecord._id = field;\n\t\t\t_id = this.insert(record);\n\t\t}\n\n\t\treturn record;\n\t}\n\n\t// REMOVE\n\tremoveById(_id) {\n\t\tconst query = { _id };\n\n\t\treturn this.remove(query);\n\t}\n}\n\nRocketChat.models.LivechatCustomField = new LivechatCustomField();\n","import _ from 'underscore';\n\n/**\n * Livechat Department model\n */\nclass LivechatDepartment extends RocketChat.models._Base {\n\tconstructor() {\n\t\tsuper('livechat_department');\n\n\t\tthis.tryEnsureIndex({\n\t\t\tnumAgents: 1,\n\t\t\tenabled: 1,\n\t\t});\n\t}\n\n\t// FIND\n\tfindOneById(_id, options) {\n\t\tconst query = { _id };\n\n\t\treturn this.findOne(query, options);\n\t}\n\n\tfindByDepartmentId(_id, options) {\n\t\tconst query = { _id };\n\n\t\treturn this.find(query, options);\n\t}\n\n\tcreateOrUpdateDepartment(_id, { enabled, name, description, showOnRegistration }, agents) {\n\t\tagents = [].concat(agents);\n\n\t\tconst record = {\n\t\t\tenabled,\n\t\t\tname,\n\t\t\tdescription,\n\t\t\tnumAgents: agents.length,\n\t\t\tshowOnRegistration,\n\t\t};\n\n\t\tif (_id) {\n\t\t\tthis.update({ _id }, { $set: record });\n\t\t} else {\n\t\t\t_id = this.insert(record);\n\t\t}\n\n\t\tconst savedAgents = _.pluck(RocketChat.models.LivechatDepartmentAgents.findByDepartmentId(_id).fetch(), 'agentId');\n\t\tconst agentsToSave = _.pluck(agents, 'agentId');\n\n\t\t// remove other agents\n\t\t_.difference(savedAgents, agentsToSave).forEach((agentId) => {\n\t\t\tRocketChat.models.LivechatDepartmentAgents.removeByDepartmentIdAndAgentId(_id, agentId);\n\t\t});\n\n\t\tagents.forEach((agent) => {\n\t\t\tRocketChat.models.LivechatDepartmentAgents.saveAgent({\n\t\t\t\tagentId: agent.agentId,\n\t\t\t\tdepartmentId: _id,\n\t\t\t\tusername: agent.username,\n\t\t\t\tcount: agent.count ? parseInt(agent.count) : 0,\n\t\t\t\torder: agent.order ? parseInt(agent.order) : 0,\n\t\t\t});\n\t\t});\n\n\t\treturn _.extend(record, { _id });\n\t}\n\n\t// REMOVE\n\tremoveById(_id) {\n\t\tconst query = { _id };\n\n\t\treturn this.remove(query);\n\t}\n\n\tfindEnabledWithAgents() {\n\t\tconst query = {\n\t\t\tnumAgents: { $gt: 0 },\n\t\t\tenabled: true,\n\t\t};\n\t\treturn this.find(query);\n\t}\n}\n\nRocketChat.models.LivechatDepartment = new LivechatDepartment();\n","import _ from 'underscore';\n/**\n * Livechat Department model\n */\nclass LivechatDepartmentAgents extends RocketChat.models._Base {\n\tconstructor() {\n\t\tsuper('livechat_department_agents');\n\t}\n\n\tfindByDepartmentId(departmentId) {\n\t\treturn this.find({ departmentId });\n\t}\n\n\tsaveAgent(agent) {\n\t\treturn this.upsert({\n\t\t\tagentId: agent.agentId,\n\t\t\tdepartmentId: agent.departmentId,\n\t\t}, {\n\t\t\t$set: {\n\t\t\t\tusername: agent.username,\n\t\t\t\tcount: parseInt(agent.count),\n\t\t\t\torder: parseInt(agent.order),\n\t\t\t},\n\t\t});\n\t}\n\n\tremoveByDepartmentIdAndAgentId(departmentId, agentId) {\n\t\tthis.remove({ departmentId, agentId });\n\t}\n\n\tgetNextAgentForDepartment(departmentId) {\n\t\tconst agents = this.findByDepartmentId(departmentId).fetch();\n\n\t\tif (agents.length === 0) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst onlineUsers = RocketChat.models.Users.findOnlineUserFromList(_.pluck(agents, 'username'));\n\n\t\tconst onlineUsernames = _.pluck(onlineUsers.fetch(), 'username');\n\n\t\tconst query = {\n\t\t\tdepartmentId,\n\t\t\tusername: {\n\t\t\t\t$in: onlineUsernames,\n\t\t\t},\n\t\t};\n\n\t\tconst sort = {\n\t\t\tcount: 1,\n\t\t\torder: 1,\n\t\t\tusername: 1,\n\t\t};\n\t\tconst update = {\n\t\t\t$inc: {\n\t\t\t\tcount: 1,\n\t\t\t},\n\t\t};\n\n\t\tconst collectionObj = this.model.rawCollection();\n\t\tconst findAndModify = Meteor.wrapAsync(collectionObj.findAndModify, collectionObj);\n\n\t\tconst agent = findAndModify(query, sort, update);\n\t\tif (agent && agent.value) {\n\t\t\treturn {\n\t\t\t\tagentId: agent.value.agentId,\n\t\t\t\tusername: agent.value.username,\n\t\t\t};\n\t\t} else {\n\t\t\treturn null;\n\t\t}\n\t}\n\n\tgetOnlineForDepartment(departmentId) {\n\t\tconst agents = this.findByDepartmentId(departmentId).fetch();\n\n\t\tif (agents.length === 0) {\n\t\t\treturn [];\n\t\t}\n\n\t\tconst onlineUsers = RocketChat.models.Users.findOnlineUserFromList(_.pluck(agents, 'username'));\n\n\t\tconst onlineUsernames = _.pluck(onlineUsers.fetch(), 'username');\n\n\t\tconst query = {\n\t\t\tdepartmentId,\n\t\t\tusername: {\n\t\t\t\t$in: onlineUsernames,\n\t\t\t},\n\t\t};\n\n\t\tconst depAgents = this.find(query);\n\n\t\tif (depAgents) {\n\t\t\treturn depAgents;\n\t\t} else {\n\t\t\treturn [];\n\t\t}\n\t}\n\n\tfindUsersInQueue(usersList) {\n\t\tconst query = {};\n\n\t\tif (!_.isEmpty(usersList)) {\n\t\t\tquery.username = {\n\t\t\t\t$in: usersList,\n\t\t\t};\n\t\t}\n\n\t\tconst options = {\n\t\t\tsort: {\n\t\t\t\tdepartmentId: 1,\n\t\t\t\tcount: 1,\n\t\t\t\torder: 1,\n\t\t\t\tusername: 1,\n\t\t\t},\n\t\t};\n\n\t\treturn this.find(query, options);\n\t}\n\n\treplaceUsernameOfAgentByUserId(userId, username) {\n\t\tconst query = { agentId: userId };\n\n\t\tconst update = {\n\t\t\t$set: {\n\t\t\t\tusername,\n\t\t\t},\n\t\t};\n\n\t\treturn this.update(query, update, { multi: true });\n\t}\n}\n\nRocketChat.models.LivechatDepartmentAgents = new LivechatDepartmentAgents();\n","/**\n * Livechat Page Visited model\n */\nclass LivechatPageVisited extends RocketChat.models._Base {\n\tconstructor() {\n\t\tsuper('livechat_page_visited');\n\n\t\tthis.tryEnsureIndex({ token: 1 });\n\t\tthis.tryEnsureIndex({ ts: 1 });\n\n\t\t// keep history for 1 month if the visitor does not register\n\t\tthis.tryEnsureIndex({ expireAt: 1 }, { sparse: 1, expireAfterSeconds: 0 });\n\t}\n\n\tsaveByToken(token, pageInfo) {\n\t\t// keep history of unregistered visitors for 1 month\n\t\tconst keepHistoryMiliseconds = 2592000000;\n\n\t\treturn this.insert({\n\t\t\ttoken,\n\t\t\tpage: pageInfo,\n\t\t\tts: new Date(),\n\t\t\texpireAt: new Date().getTime() + keepHistoryMiliseconds,\n\t\t});\n\t}\n\n\tfindByToken(token) {\n\t\treturn this.find({ token }, { sort : { ts: -1 }, limit: 20 });\n\t}\n\n\tkeepHistoryForToken(token) {\n\t\treturn this.update({\n\t\t\ttoken,\n\t\t\texpireAt: {\n\t\t\t\t$exists: true,\n\t\t\t},\n\t\t}, {\n\t\t\t$unset: {\n\t\t\t\texpireAt: 1,\n\t\t\t},\n\t\t}, {\n\t\t\tmulti: true,\n\t\t});\n\t}\n}\n\nRocketChat.models.LivechatPageVisited = new LivechatPageVisited();\n","/**\n * Livechat Trigger model\n */\nclass LivechatTrigger extends RocketChat.models._Base {\n\tconstructor() {\n\t\tsuper('livechat_trigger');\n\t}\n\n\tupdateById(_id, data) {\n\t\treturn this.update({ _id }, { $set: data });\n\t}\n\n\tremoveAll() {\n\t\treturn this.remove({});\n\t}\n\n\tfindById(_id) {\n\t\treturn this.find({ _id });\n\t}\n\n\tremoveById(_id) {\n\t\treturn this.remove({ _id });\n\t}\n\n\tfindEnabled() {\n\t\treturn this.find({ enabled: true });\n\t}\n}\n\nRocketChat.models.LivechatTrigger = new LivechatTrigger();\n","Meteor.startup(function() {\n\tRocketChat.models.Rooms.tryEnsureIndex({ open: 1 }, { sparse: 1 });\n\tRocketChat.models.Rooms.tryEnsureIndex({ departmentId: 1 }, { sparse: 1 });\n\tRocketChat.models.Users.tryEnsureIndex({ 'visitorEmails.address': 1 });\n});\n","class LivechatInquiry extends RocketChat.models._Base {\n\tconstructor() {\n\t\tsuper('livechat_inquiry');\n\n\t\tthis.tryEnsureIndex({ rid: 1 }); // room id corresponding to this inquiry\n\t\tthis.tryEnsureIndex({ name: 1 }); // name of the inquiry (client name for now)\n\t\tthis.tryEnsureIndex({ message: 1 }); // message sent by the client\n\t\tthis.tryEnsureIndex({ ts: 1 }); // timestamp\n\t\tthis.tryEnsureIndex({ agents: 1 }); // Id's of the agents who can see the inquiry (handle departments)\n\t\tthis.tryEnsureIndex({ status: 1 }); // 'open', 'taken'\n\t}\n\n\tfindOneById(inquiryId) {\n\t\treturn this.findOne({ _id: inquiryId });\n\t}\n\n\t/*\n\t * mark the inquiry as taken\n\t */\n\ttakeInquiry(inquiryId) {\n\t\tthis.update({\n\t\t\t_id: inquiryId,\n\t\t}, {\n\t\t\t$set: { status: 'taken' },\n\t\t});\n\t}\n\n\t/*\n\t * mark the inquiry as closed\n\t */\n\tcloseByRoomId(roomId, closeInfo) {\n\t\treturn this.update({\n\t\t\trid: roomId,\n\t\t}, {\n\t\t\t$set: {\n\t\t\t\tstatus: 'closed',\n\t\t\t\tcloser: closeInfo.closer,\n\t\t\t\tclosedBy: closeInfo.closedBy,\n\t\t\t\tclosedAt: closeInfo.closedAt,\n\t\t\t\t'metrics.chatDuration': closeInfo.chatDuration,\n\t\t\t},\n\t\t});\n\t}\n\n\t/*\n\t * mark inquiry as open\n\t */\n\topenInquiry(inquiryId) {\n\t\treturn this.update({\n\t\t\t_id: inquiryId,\n\t\t}, {\n\t\t\t$set: { status: 'open' },\n\t\t});\n\t}\n\n\t/*\n\t * mark inquiry as open and set agents\n\t */\n\topenInquiryWithAgents(inquiryId, agentIds) {\n\t\treturn this.update({\n\t\t\t_id: inquiryId,\n\t\t}, {\n\t\t\t$set: {\n\t\t\t\tstatus: 'open',\n\t\t\t\tagents: agentIds,\n\t\t\t},\n\t\t});\n\t}\n\n\t/*\n\t * return the status of the inquiry (open or taken)\n\t */\n\tgetStatus(inquiryId) {\n\t\treturn this.findOne({ _id: inquiryId }).status;\n\t}\n\n\tupdateVisitorStatus(token, status) {\n\t\tconst query = {\n\t\t\t'v.token': token,\n\t\t\tstatus: 'open',\n\t\t};\n\n\t\tconst update = {\n\t\t\t$set: {\n\t\t\t\t'v.status': status,\n\t\t\t},\n\t\t};\n\n\t\treturn this.update(query, update);\n\t}\n}\n\nRocketChat.models.LivechatInquiry = new LivechatInquiry();\n","import moment from 'moment';\n\nclass LivechatOfficeHour extends RocketChat.models._Base {\n\tconstructor() {\n\t\tsuper('livechat_office_hour');\n\n\t\tthis.tryEnsureIndex({ day: 1 }); // the day of the week monday - sunday\n\t\tthis.tryEnsureIndex({ start: 1 }); // the opening hours of the office\n\t\tthis.tryEnsureIndex({ finish: 1 }); // the closing hours of the office\n\t\tthis.tryEnsureIndex({ open: 1 }); // whether or not the offices are open on this day\n\n\t\t// if there is nothing in the collection, add defaults\n\t\tif (this.find().count() === 0) {\n\t\t\tthis.insert({ day : 'Monday', start : '08:00', finish : '20:00', code : 1, open : true });\n\t\t\tthis.insert({ day : 'Tuesday', start : '08:00', finish : '20:00', code : 2, open : true });\n\t\t\tthis.insert({ day : 'Wednesday', start : '08:00', finish : '20:00', code : 3, open : true });\n\t\t\tthis.insert({ day : 'Thursday', start : '08:00', finish : '20:00', code : 4, open : true });\n\t\t\tthis.insert({ day : 'Friday', start : '08:00', finish : '20:00', code : 5, open : true });\n\t\t\tthis.insert({ day : 'Saturday', start : '08:00', finish : '20:00', code : 6, open : false });\n\t\t\tthis.insert({ day : 'Sunday', start : '08:00', finish : '20:00', code : 0, open : false });\n\t\t}\n\t}\n\n\t/*\n\t * update the given days start and finish times and whether the office is open on that day\n\t */\n\tupdateHours(day, newStart, newFinish, newOpen) {\n\t\tthis.update({\n\t\t\tday,\n\t\t}, {\n\t\t\t$set: {\n\t\t\t\tstart: newStart,\n\t\t\t\tfinish: newFinish,\n\t\t\t\topen: newOpen,\n\t\t\t},\n\t\t});\n\t}\n\n\t/*\n\t * Check if the current server time (utc) is within the office hours of that day\n\t * returns true or false\n\t */\n\tisNowWithinHours() {\n\t\t// get current time on server in utc\n\t\t// var ct = moment().utc();\n\t\tconst currentTime = moment.utc(moment().utc().format('dddd:HH:mm'), 'dddd:HH:mm');\n\n\t\t// get todays office hours from db\n\t\tconst todaysOfficeHours = this.findOne({ day: currentTime.format('dddd') });\n\t\tif (!todaysOfficeHours) {\n\t\t\treturn false;\n\t\t}\n\n\t\t// check if offices are open today\n\t\tif (todaysOfficeHours.open === false) {\n\t\t\treturn false;\n\t\t}\n\n\t\tconst start = moment.utc(`${ todaysOfficeHours.day }:${ todaysOfficeHours.start }`, 'dddd:HH:mm');\n\t\tconst finish = moment.utc(`${ todaysOfficeHours.day }:${ todaysOfficeHours.finish }`, 'dddd:HH:mm');\n\n\t\t// console.log(finish.isBefore(start));\n\t\tif (finish.isBefore(start)) {\n\t\t\t// finish.day(finish.day()+1);\n\t\t\tfinish.add(1, 'days');\n\t\t}\n\n\t\tconst result = currentTime.isBetween(start, finish);\n\n\t\t// inBetween  check\n\t\treturn result;\n\t}\n\n\tisOpeningTime() {\n\t\t// get current time on server in utc\n\t\tconst currentTime = moment.utc(moment().utc().format('dddd:HH:mm'), 'dddd:HH:mm');\n\n\t\t// get todays office hours from db\n\t\tconst todaysOfficeHours = this.findOne({ day: currentTime.format('dddd') });\n\t\tif (!todaysOfficeHours) {\n\t\t\treturn false;\n\t\t}\n\n\t\t// check if offices are open today\n\t\tif (todaysOfficeHours.open === false) {\n\t\t\treturn false;\n\t\t}\n\n\t\tconst start = moment.utc(`${ todaysOfficeHours.day }:${ todaysOfficeHours.start }`, 'dddd:HH:mm');\n\n\t\treturn start.isSame(currentTime, 'minute');\n\t}\n\n\tisClosingTime() {\n\t\t// get current time on server in utc\n\t\tconst currentTime = moment.utc(moment().utc().format('dddd:HH:mm'), 'dddd:HH:mm');\n\n\t\t// get todays office hours from db\n\t\tconst todaysOfficeHours = this.findOne({ day: currentTime.format('dddd') });\n\t\tif (!todaysOfficeHours) {\n\t\t\treturn false;\n\t\t}\n\n\t\tconst finish = moment.utc(`${ todaysOfficeHours.day }:${ todaysOfficeHours.finish }`, 'dddd:HH:mm');\n\n\t\treturn finish.isSame(currentTime, 'minute');\n\t}\n}\n\nRocketChat.models.LivechatOfficeHour = new LivechatOfficeHour();\n","import _ from 'underscore';\nimport s from 'underscore.string';\n\nclass LivechatVisitors extends RocketChat.models._Base {\n\tconstructor() {\n\t\tsuper('livechat_visitor');\n\t}\n\n\t/**\n\t * Gets visitor by token\n\t * @param {string} token - Visitor token\n\t */\n\tgetVisitorByToken(token, options) {\n\t\tconst query = {\n\t\t\ttoken,\n\t\t};\n\n\t\treturn this.findOne(query, options);\n\t}\n\n\t/**\n\t * Find visitors by _id\n\t * @param {string} token - Visitor token\n\t */\n\tfindById(_id, options) {\n\t\tconst query = {\n\t\t\t_id,\n\t\t};\n\n\t\treturn this.find(query, options);\n\t}\n\n\t/**\n\t * Gets visitor by token\n\t * @param {string} token - Visitor token\n\t */\n\tfindVisitorByToken(token) {\n\t\tconst query = {\n\t\t\ttoken,\n\t\t};\n\n\t\treturn this.find(query);\n\t}\n\n\tupdateLivechatDataByToken(token, key, value, overwrite = true) {\n\t\tconst query = {\n\t\t\ttoken,\n\t\t};\n\n\t\tif (!overwrite) {\n\t\t\tconst user = this.findOne(query, { fields: { livechatData: 1 } });\n\t\t\tif (user.livechatData && typeof user.livechatData[key] !== 'undefined') {\n\t\t\t\treturn true;\n\t\t\t}\n\t\t}\n\n\t\tconst update = {\n\t\t\t$set: {\n\t\t\t\t[`livechatData.${ key }`]: value,\n\t\t\t},\n\t\t};\n\n\t\treturn this.update(query, update);\n\t}\n\n\t/**\n\t * Find a visitor by their phone number\n\t * @return {object} User from db\n\t */\n\tfindOneVisitorByPhone(phone) {\n\t\tconst query = {\n\t\t\t'phone.phoneNumber': phone,\n\t\t};\n\n\t\treturn this.findOne(query);\n\t}\n\n\tgetVisitorsBetweenDate(date) {\n\t\tconst query = {\n\t\t\t_updatedAt: {\n\t\t\t\t$gte: date.gte,\t// ISO Date, ts >= date.gte\n\t\t\t\t$lt: date.lt,\t// ISODate, ts < date.lt\n\t\t\t},\n\t\t};\n\n\t\treturn this.find(query, { fields: { _id: 1 } });\n\t}\n\n\t/**\n\t * Get the next visitor name\n\t * @return {string} The next visitor name\n\t */\n\tgetNextVisitorUsername() {\n\t\tconst settingsRaw = RocketChat.models.Settings.model.rawCollection();\n\t\tconst findAndModify = Meteor.wrapAsync(settingsRaw.findAndModify, settingsRaw);\n\n\t\tconst query = {\n\t\t\t_id: 'Livechat_guest_count',\n\t\t};\n\n\t\tconst update = {\n\t\t\t$inc: {\n\t\t\t\tvalue: 1,\n\t\t\t},\n\t\t};\n\n\t\tconst livechatCount = findAndModify(query, null, update);\n\n\t\treturn `guest-${ livechatCount.value.value + 1 }`;\n\t}\n\n\tupdateById(_id, update) {\n\t\treturn this.update({ _id }, update);\n\t}\n\n\tsaveGuestById(_id, data) {\n\t\tconst setData = {};\n\t\tconst unsetData = {};\n\n\t\tif (data.name) {\n\t\t\tif (!_.isEmpty(s.trim(data.name))) {\n\t\t\t\tsetData.name = s.trim(data.name);\n\t\t\t} else {\n\t\t\t\tunsetData.name = 1;\n\t\t\t}\n\t\t}\n\n\t\tif (data.email) {\n\t\t\tif (!_.isEmpty(s.trim(data.email))) {\n\t\t\t\tsetData.visitorEmails = [\n\t\t\t\t\t{ address: s.trim(data.email) },\n\t\t\t\t];\n\t\t\t} else {\n\t\t\t\tunsetData.visitorEmails = 1;\n\t\t\t}\n\t\t}\n\n\t\tif (data.phone) {\n\t\t\tif (!_.isEmpty(s.trim(data.phone))) {\n\t\t\t\tsetData.phone = [\n\t\t\t\t\t{ phoneNumber: s.trim(data.phone) },\n\t\t\t\t];\n\t\t\t} else {\n\t\t\t\tunsetData.phone = 1;\n\t\t\t}\n\t\t}\n\n\t\tconst update = {};\n\n\t\tif (!_.isEmpty(setData)) {\n\t\t\tupdate.$set = setData;\n\t\t}\n\n\t\tif (!_.isEmpty(unsetData)) {\n\t\t\tupdate.$unset = unsetData;\n\t\t}\n\n\t\tif (_.isEmpty(update)) {\n\t\t\treturn true;\n\t\t}\n\n\t\treturn this.update({ _id }, update);\n\t}\n\n\tfindOneGuestByEmailAddress(emailAddress) {\n\t\tconst query = {\n\t\t\t'visitorEmails.address': new RegExp(`^${ s.escapeRegExp(emailAddress) }$`, 'i'),\n\t\t};\n\n\t\treturn this.findOne(query);\n\t}\n\n\tsaveGuestEmailPhoneById(_id, emails, phones) {\n\t\tconst update = {\n\t\t\t$addToSet: {},\n\t\t};\n\n\t\tconst saveEmail = [].concat(emails)\n\t\t\t.filter((email) => email && email.trim())\n\t\t\t.map((email) => ({ address: email }));\n\n\t\tif (saveEmail.length > 0) {\n\t\t\tupdate.$addToSet.visitorEmails = { $each: saveEmail };\n\t\t}\n\n\t\tconst savePhone = [].concat(phones)\n\t\t\t.filter((phone) => phone && phone.trim().replace(/[^\\d]/g, ''))\n\t\t\t.map((phone) => ({ phoneNumber: phone }));\n\n\t\tif (savePhone.length > 0) {\n\t\t\tupdate.$addToSet.phone = { $each: savePhone };\n\t\t}\n\n\t\tif (!update.$addToSet.visitorEmails && !update.$addToSet.phone) {\n\t\t\treturn;\n\t\t}\n\n\t\treturn this.update({ _id }, update);\n\t}\n}\n\nexport default new LivechatVisitors();\n","import moment from 'moment';\n\n/**\n * return readable time format from seconds\n * @param  {Double} sec seconds\n * @return {String}     Readable string format\n */\nconst secondsToHHMMSS = (sec) => {\n\tsec = parseFloat(sec);\n\n\tlet hours = Math.floor(sec / 3600);\n\tlet minutes = Math.floor((sec - (hours * 3600)) / 60);\n\tlet seconds = Math.round(sec - (hours * 3600) - (minutes * 60));\n\n\tif (hours < 10) { hours = `0${ hours }`; }\n\tif (minutes < 10) { minutes = `0${ minutes }`; }\n\tif (seconds < 10) { seconds = `0${ seconds }`; }\n\n\tif (hours > 0) {\n\t\treturn `${ hours }:${ minutes }:${ seconds }`;\n\t}\n\tif (minutes > 0) {\n\t\treturn `${ minutes }:${ seconds }`;\n\t}\n\treturn sec;\n};\n\nexport const Analytics = {\n\tgetAgentOverviewData(options) {\n\t\tconst from = moment(options.daterange.from);\n\t\tconst to = moment(options.daterange.to);\n\n\t\tif (!(moment(from).isValid() && moment(to).isValid())) {\n\t\t\tconsole.log('livechat:getAgentOverviewData => Invalid dates');\n\t\t\treturn;\n\t\t}\n\n\t\tif (!this.AgentOverviewData[options.chartOptions.name]) {\n\t\t\tconsole.log(`Method RocketChat.Livechat.Analytics.AgentOverviewData.${ options.chartOptions.name } does NOT exist`);\n\t\t\treturn;\n\t\t}\n\n\t\treturn this.AgentOverviewData[options.chartOptions.name](from, to);\n\t},\n\n\tgetAnalyticsChartData(options) {\n\t\t// Check if function exists, prevent server error in case property altered\n\t\tif (!this.ChartData[options.chartOptions.name]) {\n\t\t\tconsole.log(`Method RocketChat.Livechat.Analytics.ChartData.${ options.chartOptions.name } does NOT exist`);\n\t\t\treturn;\n\t\t}\n\n\t\tconst from = moment(options.daterange.from);\n\t\tconst to = moment(options.daterange.to);\n\n\t\tif (!(moment(from).isValid() && moment(to).isValid())) {\n\t\t\tconsole.log('livechat:getAnalyticsChartData => Invalid dates');\n\t\t\treturn;\n\t\t}\n\n\n\t\tconst data = {\n\t\t\tchartLabel: options.chartOptions.name,\n\t\t\tdataLabels: [],\n\t\t\tdataPoints: [],\n\t\t};\n\n\t\tif (from.diff(to) === 0) {\t// data for single day\n\t\t\tfor (let m = moment(from); m.diff(to, 'days') <= 0; m.add(1, 'hours')) {\n\t\t\t\tconst hour = m.format('H');\n\t\t\t\tdata.dataLabels.push(`${ moment(hour, ['H']).format('hA') }-${ moment((parseInt(hour) + 1) % 24, ['H']).format('hA') }`);\n\n\t\t\t\tconst date = {\n\t\t\t\t\tgte: m,\n\t\t\t\t\tlt: moment(m).add(1, 'hours'),\n\t\t\t\t};\n\n\t\t\t\tdata.dataPoints.push(this.ChartData[options.chartOptions.name](date));\n\t\t\t}\n\t\t} else {\n\t\t\tfor (let m = moment(from); m.diff(to, 'days') <= 0; m.add(1, 'days')) {\n\t\t\t\tdata.dataLabels.push(m.format('M/D'));\n\n\t\t\t\tconst date = {\n\t\t\t\t\tgte: m,\n\t\t\t\t\tlt: moment(m).add(1, 'days'),\n\t\t\t\t};\n\n\t\t\t\tdata.dataPoints.push(this.ChartData[options.chartOptions.name](date));\n\t\t\t}\n\t\t}\n\n\t\treturn data;\n\t},\n\n\tgetAnalyticsOverviewData(options) {\n\t\tconst from = moment(options.daterange.from);\n\t\tconst to = moment(options.daterange.to);\n\n\t\tif (!(moment(from).isValid() && moment(to).isValid())) {\n\t\t\tconsole.log('livechat:getAnalyticsOverviewData => Invalid dates');\n\t\t\treturn;\n\t\t}\n\n\t\tif (!this.OverviewData[options.analyticsOptions.name]) {\n\t\t\tconsole.log(`Method RocketChat.Livechat.Analytics.OverviewData.${ options.analyticsOptions.name } does NOT exist`);\n\t\t\treturn;\n\t\t}\n\n\t\treturn this.OverviewData[options.analyticsOptions.name](from, to);\n\t},\n\n\tChartData: {\n\t\t/**\n\t\t *\n\t\t * @param {Object} date {gte: {Date}, lt: {Date}}\n\t\t *\n\t\t * @returns {Integer}\n\t\t */\n\t\tTotal_conversations(date) {\n\t\t\treturn RocketChat.models.Rooms.getTotalConversationsBetweenDate('l', date);\n\t\t},\n\n\t\tAvg_chat_duration(date) {\n\t\t\tlet total = 0;\n\t\t\tlet count = 0;\n\n\t\t\tRocketChat.models.Rooms.getAnalyticsMetricsBetweenDate('l', date).forEach(({ metrics }) => {\n\t\t\t\tif (metrics && metrics.chatDuration) {\n\t\t\t\t\ttotal += metrics.chatDuration;\n\t\t\t\t\tcount++;\n\t\t\t\t}\n\t\t\t});\n\n\t\t\tconst avgCD = (count) ? total / count : 0;\n\t\t\treturn Math.round(avgCD * 100) / 100;\n\t\t},\n\n\t\tTotal_messages(date) {\n\t\t\tlet total = 0;\n\n\t\t\tRocketChat.models.Rooms.getAnalyticsMetricsBetweenDate('l', date).forEach(({ msgs }) => {\n\t\t\t\tif (msgs) {\n\t\t\t\t\ttotal += msgs;\n\t\t\t\t}\n\t\t\t});\n\n\t\t\treturn total;\n\t\t},\n\n\t\t/**\n\t\t *\n\t\t * @param {Object} date {gte: {Date}, lt: {Date}}\n\t\t *\n\t\t * @returns {Double}\n\t\t */\n\t\tAvg_first_response_time(date) {\n\t\t\tlet frt = 0;\n\t\t\tlet count = 0;\n\t\t\tRocketChat.models.Rooms.getAnalyticsMetricsBetweenDate('l', date).forEach(({ metrics }) => {\n\t\t\t\tif (metrics && metrics.response && metrics.response.ft) {\n\t\t\t\t\tfrt += metrics.response.ft;\n\t\t\t\t\tcount++;\n\t\t\t\t}\n\t\t\t});\n\n\t\t\tconst avgFrt = (count) ? frt / count : 0;\n\t\t\treturn Math.round(avgFrt * 100) / 100;\n\t\t},\n\n\t\t/**\n\t\t *\n\t\t * @param {Object} date {gte: {Date}, lt: {Date}}\n\t\t *\n\t\t * @returns {Double}\n\t\t */\n\t\tBest_first_response_time(date) {\n\t\t\tlet maxFrt;\n\n\t\t\tRocketChat.models.Rooms.getAnalyticsMetricsBetweenDate('l', date).forEach(({ metrics }) => {\n\t\t\t\tif (metrics && metrics.response && metrics.response.ft) {\n\t\t\t\t\tmaxFrt = (maxFrt) ? Math.min(maxFrt, metrics.response.ft) : metrics.response.ft;\n\t\t\t\t}\n\t\t\t});\n\n\t\t\tif (!maxFrt) { maxFrt = 0; }\n\n\t\t\treturn Math.round(maxFrt * 100) / 100;\n\t\t},\n\n\t\t/**\n\t\t *\n\t\t * @param {Object} date {gte: {Date}, lt: {Date}}\n\t\t *\n\t\t * @returns {Double}\n\t\t */\n\t\tAvg_response_time(date) {\n\t\t\tlet art = 0;\n\t\t\tlet count = 0;\n\t\t\tRocketChat.models.Rooms.getAnalyticsMetricsBetweenDate('l', date).forEach(({ metrics }) => {\n\t\t\t\tif (metrics && metrics.response && metrics.response.avg) {\n\t\t\t\t\tart += metrics.response.avg;\n\t\t\t\t\tcount++;\n\t\t\t\t}\n\t\t\t});\n\n\t\t\tconst avgArt = (count) ? art / count : 0;\n\n\t\t\treturn Math.round(avgArt * 100) / 100;\n\t\t},\n\n\t\t/**\n\t\t *\n\t\t * @param {Object} date {gte: {Date}, lt: {Date}}\n\t\t *\n\t\t * @returns {Double}\n\t\t */\n\t\tAvg_reaction_time(date) {\n\t\t\tlet arnt = 0;\n\t\t\tlet count = 0;\n\t\t\tRocketChat.models.Rooms.getAnalyticsMetricsBetweenDate('l', date).forEach(({ metrics }) => {\n\t\t\t\tif (metrics && metrics.reaction && metrics.reaction.ft) {\n\t\t\t\t\tarnt += metrics.reaction.ft;\n\t\t\t\t\tcount++;\n\t\t\t\t}\n\t\t\t});\n\n\t\t\tconst avgArnt = (count) ? arnt / count : 0;\n\n\t\t\treturn Math.round(avgArnt * 100) / 100;\n\t\t},\n\t},\n\n\tOverviewData: {\n\t\t/**\n\t\t *\n\t\t * @param {Map} map\n\t\t *\n\t\t * @return {String}\n\t\t */\n\t\tgetKeyHavingMaxValue(map, def) {\n\t\t\tlet maxValue = 0;\n\t\t\tlet maxKey = def;\t// default\n\n\t\t\tmap.forEach((value, key) => {\n\t\t\t\tif (value > maxValue) {\n\t\t\t\t\tmaxValue = value;\n\t\t\t\t\tmaxKey = key;\n\t\t\t\t}\n\t\t\t});\n\n\t\t\treturn maxKey;\n\t\t},\n\n\t\t/**\n\t\t *\n\t\t * @param {Date} from\n\t\t * @param {Date} to\n\t\t *\n\t\t * @returns {Array[Object]}\n\t\t */\n\t\tConversations(from, to) {\n\t\t\tlet totalConversations = 0; // Total conversations\n\t\t\tlet openConversations = 0; // open conversations\n\t\t\tlet totalMessages = 0; // total msgs\n\t\t\tconst totalMessagesOnWeekday = new Map();\t// total messages on weekdays i.e Monday, Tuesday...\n\t\t\tconst totalMessagesInHour = new Map();\t\t// total messages in hour 0, 1, ... 23 of weekday\n\t\t\tconst days = to.diff(from, 'days') + 1;\t\t// total days\n\n\t\t\tconst summarize = (m) => ({ metrics, msgs }) => {\n\t\t\t\tif (metrics && !metrics.chatDuration) {\n\t\t\t\t\topenConversations++;\n\t\t\t\t}\n\t\t\t\ttotalMessages += msgs;\n\n\t\t\t\tconst weekday = m.format('dddd'); // @string: Monday, Tuesday ...\n\t\t\t\ttotalMessagesOnWeekday.set(weekday, (totalMessagesOnWeekday.has(weekday)) ? (totalMessagesOnWeekday.get(weekday) + msgs) : msgs);\n\t\t\t};\n\n\t\t\tfor (let m = moment(from); m.diff(to, 'days') <= 0; m.add(1, 'days')) {\n\t\t\t\tconst date = {\n\t\t\t\t\tgte: m,\n\t\t\t\t\tlt: moment(m).add(1, 'days'),\n\t\t\t\t};\n\n\t\t\t\tconst result = RocketChat.models.Rooms.getAnalyticsMetricsBetweenDate('l', date);\n\t\t\t\ttotalConversations += result.count();\n\n\t\t\t\tresult.forEach(summarize(m));\n\t\t\t}\n\n\t\t\tconst busiestDay = this.getKeyHavingMaxValue(totalMessagesOnWeekday, '-'); // returns key with max value\n\n\t\t\t// iterate through all busiestDay in given date-range and find busiest hour\n\t\t\tfor (let m = moment(from).day(busiestDay); m <= to; m.add(7, 'days')) {\n\t\t\t\tif (m < from) { continue; }\n\n\t\t\t\tfor (let h = moment(m); h.diff(m, 'days') <= 0; h.add(1, 'hours')) {\n\t\t\t\t\tconst date = {\n\t\t\t\t\t\tgte: h,\n\t\t\t\t\t\tlt: moment(h).add(1, 'hours'),\n\t\t\t\t\t};\n\n\t\t\t\t\tRocketChat.models.Rooms.getAnalyticsMetricsBetweenDate('l', date).forEach(({\n\t\t\t\t\t\tmsgs,\n\t\t\t\t\t}) => {\n\t\t\t\t\t\tconst dayHour = h.format('H');\t\t// @int : 0, 1, ... 23\n\t\t\t\t\t\ttotalMessagesInHour.set(dayHour, (totalMessagesInHour.has(dayHour)) ? (totalMessagesInHour.get(dayHour) + msgs) : msgs);\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tconst busiestHour = this.getKeyHavingMaxValue(totalMessagesInHour, -1);\n\n\t\t\tconst data = [{\n\t\t\t\ttitle: 'Total_conversations',\n\t\t\t\tvalue: totalConversations,\n\t\t\t}, {\n\t\t\t\ttitle: 'Open_conversations',\n\t\t\t\tvalue: openConversations,\n\t\t\t}, {\n\t\t\t\ttitle: 'Total_messages',\n\t\t\t\tvalue: totalMessages,\n\t\t\t}, {\n\t\t\t\ttitle: 'Busiest_day',\n\t\t\t\tvalue: busiestDay,\n\t\t\t}, {\n\t\t\t\ttitle: 'Conversations_per_day',\n\t\t\t\tvalue: (totalConversations / days).toFixed(2),\n\t\t\t}, {\n\t\t\t\ttitle: 'Busiest_time',\n\t\t\t\tvalue: (busiestHour > 0) ? `${ moment(busiestHour, ['H']).format('hA') }-${ moment((parseInt(busiestHour) + 1) % 24, ['H']).format('hA') }` : '-',\n\t\t\t}];\n\n\t\t\treturn data;\n\t\t},\n\n\t\t/**\n\t\t *\n\t\t * @param {Date} from\n\t\t * @param {Date} to\n\t\t *\n\t\t * @returns {Array[Object]}\n\t\t */\n\t\tProductivity(from, to) {\n\t\t\tlet avgResponseTime = 0;\n\t\t\tlet firstResponseTime = 0;\n\t\t\tlet avgReactionTime = 0;\n\t\t\tlet count = 0;\n\n\t\t\tconst date = {\n\t\t\t\tgte: from,\n\t\t\t\tlt: to.add(1, 'days'),\n\t\t\t};\n\n\t\t\tRocketChat.models.Rooms.getAnalyticsMetricsBetweenDate('l', date).forEach(({\n\t\t\t\tmetrics,\n\t\t\t}) => {\n\t\t\t\tif (metrics && metrics.response && metrics.reaction) {\n\t\t\t\t\tavgResponseTime += metrics.response.avg;\n\t\t\t\t\tfirstResponseTime += metrics.response.ft;\n\t\t\t\t\tavgReactionTime += metrics.reaction.ft;\n\t\t\t\t\tcount++;\n\t\t\t\t}\n\t\t\t});\n\n\t\t\tif (count) {\n\t\t\t\tavgResponseTime /= count;\n\t\t\t\tfirstResponseTime /= count;\n\t\t\t\tavgReactionTime /= count;\n\t\t\t}\n\n\t\t\tconst data = [{\n\t\t\t\ttitle: 'Avg_response_time',\n\t\t\t\tvalue: secondsToHHMMSS(avgResponseTime.toFixed(2)),\n\t\t\t}, {\n\t\t\t\ttitle: 'Avg_first_response_time',\n\t\t\t\tvalue: secondsToHHMMSS(firstResponseTime.toFixed(2)),\n\t\t\t}, {\n\t\t\t\ttitle: 'Avg_reaction_time',\n\t\t\t\tvalue: secondsToHHMMSS(avgReactionTime.toFixed(2)),\n\t\t\t}];\n\n\t\t\treturn data;\n\t\t},\n\t},\n\n\tAgentOverviewData: {\n\t\t/**\n\t\t * do operation equivalent to map[key] += value\n\t\t *\n\t\t */\n\t\tupdateMap(map, key, value) {\n\t\t\tmap.set(key, map.has(key) ? (map.get(key) + value) : value);\n\t\t},\n\n\t\t/**\n\t\t * Sort array of objects by value property of object\n\t\t * @param  {Array(Object)} data\n\t\t * @param  {Boolean} [inv=false] reverse sort\n\t\t */\n\t\tsortByValue(data, inv = false) {\n\t\t\tdata.sort(function(a, b) {\t\t// sort array\n\t\t\t\tif (parseFloat(a.value) > parseFloat(b.value)) {\n\t\t\t\t\treturn (inv) ? -1 : 1;\t\t// if inv, reverse sort\n\t\t\t\t}\n\t\t\t\tif (parseFloat(a.value) < parseFloat(b.value)) {\n\t\t\t\t\treturn (inv) ? 1 : -1;\n\t\t\t\t}\n\t\t\t\treturn 0;\n\t\t\t});\n\t\t},\n\n\t\t/**\n\t\t *\n\t\t * @param {Date} from\n\t\t * @param {Date} to\n\t\t *\n\t\t * @returns {Array(Object), Array(Object)}\n\t\t */\n\t\tTotal_conversations(from, to) {\n\t\t\tlet total = 0;\n\t\t\tconst agentConversations = new Map(); // stores total conversations for each agent\n\t\t\tconst date = {\n\t\t\t\tgte: from,\n\t\t\t\tlt: to.add(1, 'days'),\n\t\t\t};\n\n\t\t\tconst data = {\n\t\t\t\thead: [{\n\t\t\t\t\tname: 'Agent',\n\t\t\t\t}, {\n\t\t\t\t\tname: '%_of_conversations',\n\t\t\t\t}],\n\t\t\t\tdata: [],\n\t\t\t};\n\n\t\t\tRocketChat.models.Rooms.getAnalyticsMetricsBetweenDate('l', date).forEach(({\n\t\t\t\tservedBy,\n\t\t\t}) => {\n\t\t\t\tif (servedBy) {\n\t\t\t\t\tthis.updateMap(agentConversations, servedBy.username, 1);\n\t\t\t\t\ttotal++;\n\t\t\t\t}\n\t\t\t});\n\n\t\t\tagentConversations.forEach((value, key) => {\t// calculate percentage\n\t\t\t\tconst percentage = (value / total * 100).toFixed(2);\n\n\t\t\t\tdata.data.push({\n\t\t\t\t\tname: key,\n\t\t\t\t\tvalue: percentage,\n\t\t\t\t});\n\t\t\t});\n\n\t\t\tthis.sortByValue(data.data, true);\t// reverse sort array\n\n\t\t\tdata.data.forEach((value) => {\n\t\t\t\tvalue.value = `${ value.value }%`;\n\t\t\t});\n\n\t\t\treturn data;\n\t\t},\n\n\t\t/**\n\t\t *\n\t\t * @param {Date} from\n\t\t * @param {Date} to\n\t\t *\n\t\t * @returns {Array(Object), Array(Object)}\n\t\t */\n\t\tAvg_chat_duration(from, to) {\n\t\t\tconst agentChatDurations = new Map(); // stores total conversations for each agent\n\t\t\tconst date = {\n\t\t\t\tgte: from,\n\t\t\t\tlt: to.add(1, 'days'),\n\t\t\t};\n\n\t\t\tconst data = {\n\t\t\t\thead: [{\n\t\t\t\t\tname: 'Agent',\n\t\t\t\t}, {\n\t\t\t\t\tname: 'Avg_chat_duration',\n\t\t\t\t}],\n\t\t\t\tdata: [],\n\t\t\t};\n\n\t\t\tRocketChat.models.Rooms.getAnalyticsMetricsBetweenDate('l', date).forEach(({\n\t\t\t\tmetrics,\n\t\t\t\tservedBy,\n\t\t\t}) => {\n\t\t\t\tif (servedBy && metrics && metrics.chatDuration) {\n\t\t\t\t\tif (agentChatDurations.has(servedBy.username)) {\n\t\t\t\t\t\tagentChatDurations.set(servedBy.username, {\n\t\t\t\t\t\t\tchatDuration: agentChatDurations.get(servedBy.username).chatDuration + metrics.chatDuration,\n\t\t\t\t\t\t\ttotal: agentChatDurations.get(servedBy.username).total + 1,\n\t\t\t\t\t\t});\n\t\t\t\t\t} else {\n\t\t\t\t\t\tagentChatDurations.set(servedBy.username, {\n\t\t\t\t\t\t\tchatDuration: metrics.chatDuration,\n\t\t\t\t\t\t\ttotal: 1,\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t});\n\n\t\t\tagentChatDurations.forEach((obj, key) => {\t// calculate percentage\n\t\t\t\tconst avg = (obj.chatDuration / obj.total).toFixed(2);\n\n\t\t\t\tdata.data.push({\n\t\t\t\t\tname: key,\n\t\t\t\t\tvalue: avg,\n\t\t\t\t});\n\t\t\t});\n\n\t\t\tthis.sortByValue(data.data, true);\t\t// reverse sort array\n\n\t\t\tdata.data.forEach((obj) => {\n\t\t\t\tobj.value = secondsToHHMMSS(obj.value);\n\t\t\t});\n\n\t\t\treturn data;\n\t\t},\n\n\t\t/**\n\t\t *\n\t\t * @param {Date} from\n\t\t * @param {Date} to\n\t\t *\n\t\t * @returns {Array(Object), Array(Object)}\n\t\t */\n\t\tTotal_messages(from, to) {\n\t\t\tconst agentMessages = new Map(); // stores total conversations for each agent\n\t\t\tconst date = {\n\t\t\t\tgte: from,\n\t\t\t\tlt: to.add(1, 'days'),\n\t\t\t};\n\n\t\t\tconst data = {\n\t\t\t\thead: [{\n\t\t\t\t\tname: 'Agent',\n\t\t\t\t}, {\n\t\t\t\t\tname: 'Total_messages',\n\t\t\t\t}],\n\t\t\t\tdata: [],\n\t\t\t};\n\n\t\t\tRocketChat.models.Rooms.getAnalyticsMetricsBetweenDate('l', date).forEach(({\n\t\t\t\tservedBy,\n\t\t\t\tmsgs,\n\t\t\t}) => {\n\t\t\t\tif (servedBy) {\n\t\t\t\t\tthis.updateMap(agentMessages, servedBy.username, msgs);\n\t\t\t\t}\n\t\t\t});\n\n\t\t\tagentMessages.forEach((value, key) => {\t// calculate percentage\n\t\t\t\tdata.data.push({\n\t\t\t\t\tname: key,\n\t\t\t\t\tvalue,\n\t\t\t\t});\n\t\t\t});\n\n\t\t\tthis.sortByValue(data.data, true);\t\t// reverse sort array\n\n\t\t\treturn data;\n\t\t},\n\n\t\t/**\n\t\t *\n\t\t * @param {Date} from\n\t\t * @param {Date} to\n\t\t *\n\t\t * @returns {Array(Object), Array(Object)}\n\t\t */\n\t\tAvg_first_response_time(from, to) {\n\t\t\tconst agentAvgRespTime = new Map(); // stores avg response time for each agent\n\t\t\tconst date = {\n\t\t\t\tgte: from,\n\t\t\t\tlt: to.add(1, 'days'),\n\t\t\t};\n\n\t\t\tconst data = {\n\t\t\t\thead: [{\n\t\t\t\t\tname: 'Agent',\n\t\t\t\t}, {\n\t\t\t\t\tname: 'Avg_first_response_time',\n\t\t\t\t}],\n\t\t\t\tdata: [],\n\t\t\t};\n\n\t\t\tRocketChat.models.Rooms.getAnalyticsMetricsBetweenDate('l', date).forEach(({\n\t\t\t\tmetrics,\n\t\t\t\tservedBy,\n\t\t\t}) => {\n\t\t\t\tif (servedBy && metrics && metrics.response && metrics.response.ft) {\n\t\t\t\t\tif (agentAvgRespTime.has(servedBy.username)) {\n\t\t\t\t\t\tagentAvgRespTime.set(servedBy.username, {\n\t\t\t\t\t\t\tfrt: agentAvgRespTime.get(servedBy.username).frt + metrics.response.ft,\n\t\t\t\t\t\t\ttotal: agentAvgRespTime.get(servedBy.username).total + 1,\n\t\t\t\t\t\t});\n\t\t\t\t\t} else {\n\t\t\t\t\t\tagentAvgRespTime.set(servedBy.username, {\n\t\t\t\t\t\t\tfrt: metrics.response.ft,\n\t\t\t\t\t\t\ttotal: 1,\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t});\n\n\t\t\tagentAvgRespTime.forEach((obj, key) => {\t// calculate avg\n\t\t\t\tconst avg = obj.frt / obj.total;\n\n\t\t\t\tdata.data.push({\n\t\t\t\t\tname: key,\n\t\t\t\t\tvalue: avg.toFixed(2),\n\t\t\t\t});\n\t\t\t});\n\n\t\t\tthis.sortByValue(data.data, false);\t\t// sort array\n\n\t\t\tdata.data.forEach((obj) => {\n\t\t\t\tobj.value = secondsToHHMMSS(obj.value);\n\t\t\t});\n\n\t\t\treturn data;\n\t\t},\n\n\t\t/**\n\t\t *\n\t\t * @param {Date} from\n\t\t * @param {Date} to\n\t\t *\n\t\t * @returns {Array(Object), Array(Object)}\n\t\t */\n\t\tBest_first_response_time(from, to) {\n\t\t\tconst agentFirstRespTime = new Map(); // stores avg response time for each agent\n\t\t\tconst date = {\n\t\t\t\tgte: from,\n\t\t\t\tlt: to.add(1, 'days'),\n\t\t\t};\n\n\t\t\tconst data = {\n\t\t\t\thead: [{\n\t\t\t\t\tname: 'Agent',\n\t\t\t\t}, {\n\t\t\t\t\tname: 'Best_first_response_time',\n\t\t\t\t}],\n\t\t\t\tdata: [],\n\t\t\t};\n\n\t\t\tRocketChat.models.Rooms.getAnalyticsMetricsBetweenDate('l', date).forEach(({\n\t\t\t\tmetrics,\n\t\t\t\tservedBy,\n\t\t\t}) => {\n\t\t\t\tif (servedBy && metrics && metrics.response && metrics.response.ft) {\n\t\t\t\t\tif (agentFirstRespTime.has(servedBy.username)) {\n\t\t\t\t\t\tagentFirstRespTime.set(servedBy.username, Math.min(agentFirstRespTime.get(servedBy.username), metrics.response.ft));\n\t\t\t\t\t} else {\n\t\t\t\t\t\tagentFirstRespTime.set(servedBy.username, metrics.response.ft);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t});\n\n\t\t\tagentFirstRespTime.forEach((value, key) => {\t// calculate avg\n\t\t\t\tdata.data.push({\n\t\t\t\t\tname: key,\n\t\t\t\t\tvalue: value.toFixed(2),\n\t\t\t\t});\n\t\t\t});\n\n\t\t\tthis.sortByValue(data.data, false);\t\t// sort array\n\n\t\t\tdata.data.forEach((obj) => {\n\t\t\t\tobj.value = secondsToHHMMSS(obj.value);\n\t\t\t});\n\n\t\t\treturn data;\n\t\t},\n\n\t\t/**\n\t\t *\n\t\t * @param {Date} from\n\t\t * @param {Date} to\n\t\t *\n\t\t * @returns {Array(Object), Array(Object)}\n\t\t */\n\t\tAvg_response_time(from, to) {\n\t\t\tconst agentAvgRespTime = new Map(); // stores avg response time for each agent\n\t\t\tconst date = {\n\t\t\t\tgte: from,\n\t\t\t\tlt: to.add(1, 'days'),\n\t\t\t};\n\n\t\t\tconst data = {\n\t\t\t\thead: [{\n\t\t\t\t\tname: 'Agent',\n\t\t\t\t}, {\n\t\t\t\t\tname: 'Avg_response_time',\n\t\t\t\t}],\n\t\t\t\tdata: [],\n\t\t\t};\n\n\t\t\tRocketChat.models.Rooms.getAnalyticsMetricsBetweenDate('l', date).forEach(({\n\t\t\t\tmetrics,\n\t\t\t\tservedBy,\n\t\t\t}) => {\n\t\t\t\tif (servedBy && metrics && metrics.response && metrics.response.avg) {\n\t\t\t\t\tif (agentAvgRespTime.has(servedBy.username)) {\n\t\t\t\t\t\tagentAvgRespTime.set(servedBy.username, {\n\t\t\t\t\t\t\tavg: agentAvgRespTime.get(servedBy.username).avg + metrics.response.avg,\n\t\t\t\t\t\t\ttotal: agentAvgRespTime.get(servedBy.username).total + 1,\n\t\t\t\t\t\t});\n\t\t\t\t\t} else {\n\t\t\t\t\t\tagentAvgRespTime.set(servedBy.username, {\n\t\t\t\t\t\t\tavg: metrics.response.avg,\n\t\t\t\t\t\t\ttotal: 1,\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t});\n\n\t\t\tagentAvgRespTime.forEach((obj, key) => {\t// calculate avg\n\t\t\t\tconst avg = obj.avg / obj.total;\n\n\t\t\t\tdata.data.push({\n\t\t\t\t\tname: key,\n\t\t\t\t\tvalue: avg.toFixed(2),\n\t\t\t\t});\n\t\t\t});\n\n\t\t\tthis.sortByValue(data.data, false);\t\t// sort array\n\n\t\t\tdata.data.forEach((obj) => {\n\t\t\t\tobj.value = secondsToHHMMSS(obj.value);\n\t\t\t});\n\n\t\t\treturn data;\n\t\t},\n\n\t\t/**\n\t\t *\n\t\t * @param {Date} from\n\t\t * @param {Date} to\n\t\t *\n\t\t * @returns {Array(Object), Array(Object)}\n\t\t */\n\t\tAvg_reaction_time(from, to) {\n\t\t\tconst agentAvgReactionTime = new Map(); // stores avg reaction time for each agent\n\t\t\tconst date = {\n\t\t\t\tgte: from,\n\t\t\t\tlt: to.add(1, 'days'),\n\t\t\t};\n\n\t\t\tconst data = {\n\t\t\t\thead: [{\n\t\t\t\t\tname: 'Agent',\n\t\t\t\t}, {\n\t\t\t\t\tname: 'Avg_reaction_time',\n\t\t\t\t}],\n\t\t\t\tdata: [],\n\t\t\t};\n\n\t\t\tRocketChat.models.Rooms.getAnalyticsMetricsBetweenDate('l', date).forEach(({\n\t\t\t\tmetrics,\n\t\t\t\tservedBy,\n\t\t\t}) => {\n\t\t\t\tif (servedBy && metrics && metrics.reaction && metrics.reaction.ft) {\n\t\t\t\t\tif (agentAvgReactionTime.has(servedBy.username)) {\n\t\t\t\t\t\tagentAvgReactionTime.set(servedBy.username, {\n\t\t\t\t\t\t\tfrt: agentAvgReactionTime.get(servedBy.username).frt + metrics.reaction.ft,\n\t\t\t\t\t\t\ttotal: agentAvgReactionTime.get(servedBy.username).total + 1,\n\t\t\t\t\t\t});\n\t\t\t\t\t} else {\n\t\t\t\t\t\tagentAvgReactionTime.set(servedBy.username, {\n\t\t\t\t\t\t\tfrt: metrics.reaction.ft,\n\t\t\t\t\t\t\ttotal: 1,\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t});\n\n\t\t\tagentAvgReactionTime.forEach((obj, key) => {\t// calculate avg\n\t\t\t\tconst avg = obj.frt / obj.total;\n\n\t\t\t\tdata.data.push({\n\t\t\t\t\tname: key,\n\t\t\t\t\tvalue: avg.toFixed(2),\n\t\t\t\t});\n\t\t\t});\n\n\t\t\tthis.sortByValue(data.data, false);\t\t// sort array\n\n\t\t\tdata.data.forEach((obj) => {\n\t\t\t\tobj.value = secondsToHHMMSS(obj.value);\n\t\t\t});\n\n\t\t\treturn data;\n\t\t},\n\t},\n};\n","/* globals HTTP */\nimport _ from 'underscore';\nimport s from 'underscore.string';\nimport moment from 'moment';\nimport dns from 'dns';\nimport UAParser from 'ua-parser-js';\nimport * as Mailer from 'meteor/rocketchat:mailer';\n\nimport LivechatVisitors from '../models/LivechatVisitors';\nimport { Analytics } from './Analytics';\n\nRocketChat.Livechat = {\n\tAnalytics,\n\thistoryMonitorType: 'url',\n\n\tlogger: new Logger('Livechat', {\n\t\tsections: {\n\t\t\twebhook: 'Webhook',\n\t\t},\n\t}),\n\n\tgetNextAgent(department) {\n\t\tif (RocketChat.settings.get('Livechat_Routing_Method') === 'External') {\n\t\t\tfor (let i = 0; i < 10; i++) {\n\t\t\t\ttry {\n\t\t\t\t\tconst queryString = department ? `?departmentId=${ department }` : '';\n\t\t\t\t\tconst result = HTTP.call('GET', `${ RocketChat.settings.get('Livechat_External_Queue_URL') }${ queryString }`, {\n\t\t\t\t\t\theaders: {\n\t\t\t\t\t\t\t'User-Agent': 'RocketChat Server',\n\t\t\t\t\t\t\tAccept: 'application/json',\n\t\t\t\t\t\t\t'X-RocketChat-Secret-Token': RocketChat.settings.get('Livechat_External_Queue_Token'),\n\t\t\t\t\t\t},\n\t\t\t\t\t});\n\n\t\t\t\t\tif (result && result.data && result.data.username) {\n\t\t\t\t\t\tconst agent = RocketChat.models.Users.findOneOnlineAgentByUsername(result.data.username);\n\n\t\t\t\t\t\tif (agent) {\n\t\t\t\t\t\t\treturn {\n\t\t\t\t\t\t\t\tagentId: agent._id,\n\t\t\t\t\t\t\t\tusername: agent.username,\n\t\t\t\t\t\t\t};\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t} catch (e) {\n\t\t\t\t\tconsole.error('Error requesting agent from external queue.', e);\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t}\n\t\t\tthrow new Meteor.Error('no-agent-online', 'Sorry, no online agents');\n\t\t} else if (department) {\n\t\t\treturn RocketChat.models.LivechatDepartmentAgents.getNextAgentForDepartment(department);\n\t\t}\n\t\treturn RocketChat.models.Users.getNextAgent();\n\t},\n\tgetAgents(department) {\n\t\tif (department) {\n\t\t\treturn RocketChat.models.LivechatDepartmentAgents.findByDepartmentId(department);\n\t\t}\n\t\treturn RocketChat.models.Users.findAgents();\n\t},\n\tgetOnlineAgents(department) {\n\t\tif (department) {\n\t\t\treturn RocketChat.models.LivechatDepartmentAgents.getOnlineForDepartment(department);\n\t\t}\n\t\treturn RocketChat.models.Users.findOnlineAgents();\n\t},\n\tgetRequiredDepartment(onlineRequired = true) {\n\t\tconst departments = RocketChat.models.LivechatDepartment.findEnabledWithAgents();\n\n\t\treturn departments.fetch().find((dept) => {\n\t\t\tif (!dept.showOnRegistration) {\n\t\t\t\treturn false;\n\t\t\t}\n\t\t\tif (!onlineRequired) {\n\t\t\t\treturn true;\n\t\t\t}\n\t\t\tconst onlineAgents = RocketChat.models.LivechatDepartmentAgents.getOnlineForDepartment(dept._id);\n\t\t\treturn onlineAgents.count() > 0;\n\t\t});\n\t},\n\tgetRoom(guest, message, roomInfo, agent) {\n\t\tlet room = RocketChat.models.Rooms.findOneById(message.rid);\n\t\tlet newRoom = false;\n\n\t\tif (room && !room.open) {\n\t\t\tmessage.rid = Random.id();\n\t\t\troom = null;\n\t\t}\n\n\t\tif (room == null) {\n\t\t\t// if no department selected verify if there is at least one active and pick the first\n\t\t\tif (!agent && !guest.department) {\n\t\t\t\tconst department = this.getRequiredDepartment();\n\n\t\t\t\tif (department) {\n\t\t\t\t\tguest.department = department._id;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t// delegate room creation to QueueMethods\n\t\t\tconst routingMethod = RocketChat.settings.get('Livechat_Routing_Method');\n\t\t\troom = RocketChat.QueueMethods[routingMethod](guest, message, roomInfo, agent);\n\n\t\t\tnewRoom = true;\n\t\t}\n\n\t\tif (!room || room.v.token !== guest.token) {\n\t\t\tthrow new Meteor.Error('cannot-access-room');\n\t\t}\n\n\t\tif (newRoom) {\n\t\t\tRocketChat.models.Messages.setRoomIdByToken(guest.token, room._id);\n\t\t}\n\n\t\treturn { room, newRoom };\n\t},\n\n\tsendMessage({ guest, message, roomInfo, agent }) {\n\t\tconst { room, newRoom } = this.getRoom(guest, message, roomInfo, agent);\n\t\tif (guest.name) {\n\t\t\tmessage.alias = guest.name;\n\t\t}\n\n\t\t// return messages;\n\t\treturn _.extend(RocketChat.sendMessage(guest, message, room), { newRoom, showConnecting: this.showConnecting() });\n\t},\n\n\tupdateMessage({ guest, message }) {\n\t\tcheck(message, Match.ObjectIncluding({ _id: String }));\n\n\t\tconst originalMessage = RocketChat.models.Messages.findOneById(message._id);\n\t\tif (!originalMessage || !originalMessage._id) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst editAllowed = RocketChat.settings.get('Message_AllowEditing');\n\t\tconst editOwn = originalMessage.u && originalMessage.u._id === guest._id;\n\n\t\tif (!editAllowed || !editOwn) {\n\t\t\tthrow new Meteor.Error('error-action-not-allowed', 'Message editing not allowed', { method: 'livechatUpdateMessage' });\n\t\t}\n\n\t\tRocketChat.updateMessage(message, guest);\n\n\t\treturn true;\n\t},\n\n\tdeleteMessage({ guest, message }) {\n\t\tcheck(message, Match.ObjectIncluding({ _id: String }));\n\n\t\tconst msg = RocketChat.models.Messages.findOneById(message._id);\n\t\tif (!msg || !msg._id) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst deleteAllowed = RocketChat.settings.get('Message_AllowDeleting');\n\t\tconst editOwn = msg.u && msg.u._id === guest._id;\n\n\t\tif (!deleteAllowed || !editOwn) {\n\t\t\tthrow new Meteor.Error('error-action-not-allowed', 'Message deleting not allowed', { method: 'livechatDeleteMessage' });\n\t\t}\n\n\t\tRocketChat.deleteMessage(message, guest);\n\n\t\treturn true;\n\t},\n\n\tregisterGuest({ token, name, email, department, phone, username } = {}) {\n\t\tcheck(token, String);\n\n\t\tlet userId;\n\t\tconst updateUser = {\n\t\t\t$set: {\n\t\t\t\ttoken,\n\t\t\t},\n\t\t};\n\n\t\tconst user = LivechatVisitors.getVisitorByToken(token, { fields: { _id: 1 } });\n\n\t\tif (user) {\n\t\t\tuserId = user._id;\n\t\t} else {\n\t\t\tif (!username) {\n\t\t\t\tusername = LivechatVisitors.getNextVisitorUsername();\n\t\t\t}\n\n\t\t\tlet existingUser = null;\n\n\t\t\tif (s.trim(email) !== '' && (existingUser = LivechatVisitors.findOneGuestByEmailAddress(email))) {\n\t\t\t\tuserId = existingUser._id;\n\t\t\t} else {\n\t\t\t\tconst userData = {\n\t\t\t\t\tusername,\n\t\t\t\t};\n\n\t\t\t\tif (this.connection) {\n\t\t\t\t\tuserData.userAgent = this.connection.httpHeaders['user-agent'];\n\t\t\t\t\tuserData.ip = this.connection.httpHeaders['x-real-ip'] || this.connection.httpHeaders['x-forwarded-for'] || this.connection.clientAddress;\n\t\t\t\t\tuserData.host = this.connection.httpHeaders.host;\n\t\t\t\t}\n\n\t\t\t\tuserId = LivechatVisitors.insert(userData);\n\t\t\t}\n\t\t}\n\n\t\tif (phone) {\n\t\t\tupdateUser.$set.phone = [\n\t\t\t\t{ phoneNumber: phone.number },\n\t\t\t];\n\t\t}\n\n\t\tif (email && email.trim() !== '') {\n\t\t\tupdateUser.$set.visitorEmails = [\n\t\t\t\t{ address: email },\n\t\t\t];\n\t\t}\n\n\t\tif (name) {\n\t\t\tupdateUser.$set.name = name;\n\t\t}\n\n\t\tif (department) {\n\t\t\tupdateUser.$set.department = department;\n\t\t}\n\n\t\tLivechatVisitors.updateById(userId, updateUser);\n\n\t\treturn userId;\n\t},\n\n\tsetDepartmentForGuest({ token, department } = {}) {\n\t\tcheck(token, String);\n\n\t\tconst updateUser = {\n\t\t\t$set: {\n\t\t\t\tdepartment,\n\t\t\t},\n\t\t};\n\n\t\tconst user = LivechatVisitors.getVisitorByToken(token, { fields: { _id: 1 } });\n\t\tif (user) {\n\t\t\treturn LivechatVisitors.updateById(user._id, updateUser);\n\t\t}\n\t\treturn false;\n\t},\n\n\tsaveGuest({ _id, name, email, phone }) {\n\t\tconst updateData = {};\n\n\t\tif (name) {\n\t\t\tupdateData.name = name;\n\t\t}\n\t\tif (email) {\n\t\t\tupdateData.email = email;\n\t\t}\n\t\tif (phone) {\n\t\t\tupdateData.phone = phone;\n\t\t}\n\t\tconst ret = LivechatVisitors.saveGuestById(_id, updateData);\n\n\t\tMeteor.defer(() => {\n\t\t\tRocketChat.callbacks.run('livechat.saveGuest', updateData);\n\t\t});\n\n\t\treturn ret;\n\t},\n\n\tcloseRoom({ user, visitor, room, comment }) {\n\t\tconst now = new Date();\n\n\t\tconst closeData = {\n\t\t\tclosedAt: now,\n\t\t\tchatDuration: (now.getTime() - room.ts) / 1000,\n\t\t};\n\n\t\tif (user) {\n\t\t\tcloseData.closer = 'user';\n\t\t\tcloseData.closedBy = {\n\t\t\t\t_id: user._id,\n\t\t\t\tusername: user.username,\n\t\t\t};\n\t\t} else if (visitor) {\n\t\t\tcloseData.closer = 'visitor';\n\t\t\tcloseData.closedBy = {\n\t\t\t\t_id: visitor._id,\n\t\t\t\tusername: visitor.username,\n\t\t\t};\n\t\t}\n\n\t\tRocketChat.models.Rooms.closeByRoomId(room._id, closeData);\n\t\tRocketChat.models.LivechatInquiry.closeByRoomId(room._id, closeData);\n\n\t\tconst message = {\n\t\t\tt: 'livechat-close',\n\t\t\tmsg: comment,\n\t\t\tgroupable: false,\n\t\t};\n\n\t\tRocketChat.sendMessage(user, message, room);\n\n\t\tif (room.servedBy) {\n\t\t\tRocketChat.models.Subscriptions.hideByRoomIdAndUserId(room._id, room.servedBy._id);\n\t\t}\n\t\tRocketChat.models.Messages.createCommandWithRoomIdAndUser('promptTranscript', room._id, closeData.closedBy);\n\n\t\tMeteor.defer(() => {\n\t\t\tRocketChat.callbacks.run('livechat.closeRoom', room);\n\t\t});\n\n\t\treturn true;\n\t},\n\n\tsetCustomFields({ token, key, value, overwrite } = {}) {\n\t\tcheck(token, String);\n\t\tcheck(key, String);\n\t\tcheck(value, String);\n\t\tcheck(overwrite, Boolean);\n\n\t\tconst customField = RocketChat.models.LivechatCustomField.findOneById(key);\n\t\tif (!customField) {\n\t\t\tthrow new Meteor.Error('invalid-custom-field');\n\t\t}\n\n\t\tif (customField.scope === 'room') {\n\t\t\treturn RocketChat.models.Rooms.updateLivechatDataByToken(token, key, value, overwrite);\n\t\t} else {\n\t\t\treturn LivechatVisitors.updateLivechatDataByToken(token, key, value, overwrite);\n\t\t}\n\t},\n\n\tgetInitSettings() {\n\t\tconst settings = {};\n\n\t\tRocketChat.models.Settings.findNotHiddenPublic([\n\t\t\t'Livechat_title',\n\t\t\t'Livechat_title_color',\n\t\t\t'Livechat_enabled',\n\t\t\t'Livechat_registration_form',\n\t\t\t'Livechat_allow_switching_departments',\n\t\t\t'Livechat_offline_title',\n\t\t\t'Livechat_offline_title_color',\n\t\t\t'Livechat_offline_message',\n\t\t\t'Livechat_offline_success_message',\n\t\t\t'Livechat_offline_form_unavailable',\n\t\t\t'Livechat_display_offline_form',\n\t\t\t'Livechat_videocall_enabled',\n\t\t\t'Jitsi_Enabled',\n\t\t\t'Language',\n\t\t\t'Livechat_enable_transcript',\n\t\t\t'Livechat_transcript_message',\n\t\t\t'Livechat_fileupload_enabled',\n\t\t\t'FileUpload_Enabled',\n\t\t\t'Livechat_conversation_finished_message',\n\t\t\t'Livechat_name_field_registration_form',\n\t\t\t'Livechat_email_field_registration_form',\n\n\t\t]).forEach((setting) => {\n\t\t\tsettings[setting._id] = setting.value;\n\t\t});\n\n\t\tRocketChat.settings.get('Livechat_history_monitor_type', (key, value) => {\n\t\t\tsettings[key] = value;\n\t\t});\n\n\t\treturn settings;\n\t},\n\n\tsaveRoomInfo(roomData, guestData) {\n\t\tif ((roomData.topic != null || roomData.tags != null) && !RocketChat.models.Rooms.setTopicAndTagsById(roomData._id, roomData.topic, roomData.tags)) {\n\t\t\treturn false;\n\t\t}\n\n\t\tMeteor.defer(() => {\n\t\t\tRocketChat.callbacks.run('livechat.saveRoom', roomData);\n\t\t});\n\n\t\tif (!_.isEmpty(guestData.name)) {\n\t\t\treturn RocketChat.models.Rooms.setFnameById(roomData._id, guestData.name) && RocketChat.models.Subscriptions.updateDisplayNameByRoomId(roomData._id, guestData.name);\n\t\t}\n\t},\n\n\tcloseOpenChats(userId, comment) {\n\t\tconst user = RocketChat.models.Users.findOneById(userId);\n\t\tRocketChat.models.Rooms.findOpenByAgent(userId).forEach((room) => {\n\t\t\tthis.closeRoom({ user, room, comment });\n\t\t});\n\t},\n\n\tforwardOpenChats(userId) {\n\t\tRocketChat.models.Rooms.findOpenByAgent(userId).forEach((room) => {\n\t\t\tconst guest = LivechatVisitors.findOneById(room.v._id);\n\t\t\tthis.transfer(room, guest, { departmentId: guest.department });\n\t\t});\n\t},\n\n\tsavePageHistory(token, roomId, pageInfo) {\n\t\tif (pageInfo.change === RocketChat.Livechat.historyMonitorType) {\n\n\t\t\tconst user = RocketChat.models.Users.findOneById('rocket.cat');\n\n\t\t\tconst pageTitle = pageInfo.title;\n\t\t\tconst pageUrl = pageInfo.location.href;\n\t\t\tconst extraData = {\n\t\t\t\tnavigation: {\n\t\t\t\t\tpage: pageInfo,\n\t\t\t\t\ttoken,\n\t\t\t\t},\n\t\t\t};\n\n\t\t\tif (!roomId) {\n\t\t\t\t// keep history of unregistered visitors for 1 month\n\t\t\t\tconst keepHistoryMiliseconds = 2592000000;\n\t\t\t\textraData.expireAt = new Date().getTime() + keepHistoryMiliseconds;\n\t\t\t}\n\n\t\t\tif (!RocketChat.settings.get('Livechat_Visitor_navigation_as_a_message')) {\n\t\t\t\textraData._hidden = true;\n\t\t\t}\n\n\t\t\treturn RocketChat.models.Messages.createNavigationHistoryWithRoomIdMessageAndUser(roomId, `${ pageTitle } - ${ pageUrl }`, user, extraData);\n\t\t}\n\n\t\treturn;\n\t},\n\n\ttransfer(room, guest, transferData) {\n\t\tlet agent;\n\n\t\tif (transferData.userId) {\n\t\t\tconst user = RocketChat.models.Users.findOneById(transferData.userId);\n\t\t\tagent = {\n\t\t\t\tagentId: user._id,\n\t\t\t\tusername: user.username,\n\t\t\t};\n\t\t} else if (RocketChat.settings.get('Livechat_Routing_Method') !== 'Guest_Pool') {\n\t\t\tagent = RocketChat.Livechat.getNextAgent(transferData.departmentId);\n\t\t} else {\n\t\t\treturn RocketChat.Livechat.returnRoomAsInquiry(room._id, transferData.departmentId);\n\t\t}\n\n\t\tconst { servedBy } = room;\n\n\t\tif (agent && agent.agentId !== servedBy._id) {\n\t\t\tRocketChat.models.Rooms.changeAgentByRoomId(room._id, agent);\n\n\t\t\tif (transferData.departmentId) {\n\t\t\t\tRocketChat.models.Rooms.changeDepartmentIdByRoomId(room._id, transferData.departmentId);\n\t\t\t}\n\n\t\t\tconst subscriptionData = {\n\t\t\t\trid: room._id,\n\t\t\t\tname: guest.name || guest.username,\n\t\t\t\talert: true,\n\t\t\t\topen: true,\n\t\t\t\tunread: 1,\n\t\t\t\tuserMentions: 1,\n\t\t\t\tgroupMentions: 0,\n\t\t\t\tu: {\n\t\t\t\t\t_id: agent.agentId,\n\t\t\t\t\tusername: agent.username,\n\t\t\t\t},\n\t\t\t\tt: 'l',\n\t\t\t\tdesktopNotifications: 'all',\n\t\t\t\tmobilePushNotifications: 'all',\n\t\t\t\temailNotifications: 'all',\n\t\t\t};\n\t\t\tRocketChat.models.Subscriptions.removeByRoomIdAndUserId(room._id, servedBy._id);\n\n\t\t\tRocketChat.models.Subscriptions.insert(subscriptionData);\n\t\t\tRocketChat.models.Rooms.incUsersCountById(room._id);\n\n\t\t\tRocketChat.models.Messages.createUserLeaveWithRoomIdAndUser(room._id, { _id: servedBy._id, username: servedBy.username });\n\t\t\tRocketChat.models.Messages.createUserJoinWithRoomIdAndUser(room._id, { _id: agent.agentId, username: agent.username });\n\n\t\t\tconst guestData = {\n\t\t\t\ttoken: guest.token,\n\t\t\t\tdepartment: transferData.departmentId,\n\t\t\t};\n\n\t\t\tthis.setDepartmentForGuest(guestData);\n\t\t\tconst data = RocketChat.models.Users.getAgentInfo(agent.agentId);\n\n\t\t\tRocketChat.Livechat.stream.emit(room._id, {\n\t\t\t\ttype: 'agentData',\n\t\t\t\tdata,\n\t\t\t});\n\n\t\t\treturn true;\n\t\t}\n\n\t\treturn false;\n\t},\n\n\treturnRoomAsInquiry(rid, departmentId) {\n\t\tconst room = RocketChat.models.Rooms.findOneById(rid);\n\t\tif (!room) {\n\t\t\tthrow new Meteor.Error('error-invalid-room', 'Invalid room', { method: 'livechat:returnRoomAsInquiry' });\n\t\t}\n\n\t\tif (!room.servedBy) {\n\t\t\treturn false;\n\t\t}\n\n\t\tconst user = RocketChat.models.Users.findOne(room.servedBy._id);\n\t\tif (!user || !user._id) {\n\t\t\tthrow new Meteor.Error('error-invalid-user', 'Invalid user', { method: 'livechat:returnRoomAsInquiry' });\n\t\t}\n\n\t\tconst agentIds = [];\n\t\t// get the agents of the department\n\t\tif (departmentId) {\n\t\t\tlet agents = RocketChat.Livechat.getOnlineAgents(departmentId);\n\n\t\t\tif (agents.count() === 0 && RocketChat.settings.get('Livechat_guest_pool_with_no_agents')) {\n\t\t\t\tagents = RocketChat.Livechat.getAgents(departmentId);\n\t\t\t}\n\n\t\t\tif (agents.count() === 0) {\n\t\t\t\treturn false;\n\t\t\t}\n\n\t\t\tagents.forEach((agent) => {\n\t\t\t\tagentIds.push(agent.agentId);\n\t\t\t});\n\n\t\t\tRocketChat.models.Rooms.changeDepartmentIdByRoomId(room._id, departmentId);\n\t\t}\n\n\t\t// delete agent and room subscription\n\t\tRocketChat.models.Subscriptions.removeByRoomId(rid);\n\n\t\t// remove agent from room\n\t\tRocketChat.models.Rooms.removeAgentByRoomId(rid);\n\n\t\t// find inquiry corresponding to room\n\t\tconst inquiry = RocketChat.models.LivechatInquiry.findOne({ rid });\n\t\tif (!inquiry) {\n\t\t\treturn false;\n\t\t}\n\n\t\tlet openInq;\n\t\t// mark inquiry as open\n\t\tif (agentIds.length === 0) {\n\t\t\topenInq = RocketChat.models.LivechatInquiry.openInquiry(inquiry._id);\n\t\t} else {\n\t\t\topenInq = RocketChat.models.LivechatInquiry.openInquiryWithAgents(inquiry._id, agentIds);\n\t\t}\n\n\t\tif (openInq) {\n\t\t\tRocketChat.models.Messages.createUserLeaveWithRoomIdAndUser(rid, { _id: room.servedBy._id, username: room.servedBy.username });\n\n\t\t\tRocketChat.Livechat.stream.emit(rid, {\n\t\t\t\ttype: 'agentData',\n\t\t\t\tdata: null,\n\t\t\t});\n\t\t}\n\n\t\treturn openInq;\n\t},\n\n\tsendRequest(postData, callback, trying = 1) {\n\t\ttry {\n\t\t\tconst options = {\n\t\t\t\theaders: {\n\t\t\t\t\t'X-RocketChat-Livechat-Token': RocketChat.settings.get('Livechat_secret_token'),\n\t\t\t\t},\n\t\t\t\tdata: postData,\n\t\t\t};\n\t\t\treturn HTTP.post(RocketChat.settings.get('Livechat_webhookUrl'), options);\n\t\t} catch (e) {\n\t\t\tRocketChat.Livechat.logger.webhook.error(`Response error on ${ trying } try ->`, e);\n\t\t\t// try 10 times after 10 seconds each\n\t\t\tif (trying < 10) {\n\t\t\t\tRocketChat.Livechat.logger.webhook.warn('Will try again in 10 seconds ...');\n\t\t\t\ttrying++;\n\t\t\t\tsetTimeout(Meteor.bindEnvironment(() => {\n\t\t\t\t\tRocketChat.Livechat.sendRequest(postData, callback, trying);\n\t\t\t\t}), 10000);\n\t\t\t}\n\t\t}\n\t},\n\n\tgetLivechatRoomGuestInfo(room) {\n\t\tconst visitor = LivechatVisitors.findOneById(room.v._id);\n\t\tconst agent = RocketChat.models.Users.findOneById(room.servedBy && room.servedBy._id);\n\n\t\tconst ua = new UAParser();\n\t\tua.setUA(visitor.userAgent);\n\n\t\tconst postData = {\n\t\t\t_id: room._id,\n\t\t\tlabel: room.fname || room.label, // using same field for compatibility\n\t\t\ttopic: room.topic,\n\t\t\tcreatedAt: room.ts,\n\t\t\tlastMessageAt: room.lm,\n\t\t\ttags: room.tags,\n\t\t\tcustomFields: room.livechatData,\n\t\t\tvisitor: {\n\t\t\t\t_id: visitor._id,\n\t\t\t\ttoken: visitor.token,\n\t\t\t\tname: visitor.name,\n\t\t\t\tusername: visitor.username,\n\t\t\t\temail: null,\n\t\t\t\tphone: null,\n\t\t\t\tdepartment: visitor.department,\n\t\t\t\tip: visitor.ip,\n\t\t\t\tos: ua.getOS().name && (`${ ua.getOS().name } ${ ua.getOS().version }`),\n\t\t\t\tbrowser: ua.getBrowser().name && (`${ ua.getBrowser().name } ${ ua.getBrowser().version }`),\n\t\t\t\tcustomFields: visitor.livechatData,\n\t\t\t},\n\t\t};\n\n\t\tif (agent) {\n\t\t\tpostData.agent = {\n\t\t\t\t_id: agent._id,\n\t\t\t\tusername: agent.username,\n\t\t\t\tname: agent.name,\n\t\t\t\temail: null,\n\t\t\t};\n\n\t\t\tif (agent.emails && agent.emails.length > 0) {\n\t\t\t\tpostData.agent.email = agent.emails[0].address;\n\t\t\t}\n\t\t}\n\n\t\tif (room.crmData) {\n\t\t\tpostData.crmData = room.crmData;\n\t\t}\n\n\t\tif (visitor.visitorEmails && visitor.visitorEmails.length > 0) {\n\t\t\tpostData.visitor.email = visitor.visitorEmails;\n\t\t}\n\t\tif (visitor.phone && visitor.phone.length > 0) {\n\t\t\tpostData.visitor.phone = visitor.phone;\n\t\t}\n\n\t\treturn postData;\n\t},\n\n\taddAgent(username) {\n\t\tcheck(username, String);\n\n\t\tconst user = RocketChat.models.Users.findOneByUsername(username, { fields: { _id: 1, username: 1 } });\n\n\t\tif (!user) {\n\t\t\tthrow new Meteor.Error('error-invalid-user', 'Invalid user', { method: 'livechat:addAgent' });\n\t\t}\n\n\t\tif (RocketChat.authz.addUserRoles(user._id, 'livechat-agent')) {\n\t\t\tRocketChat.models.Users.setOperator(user._id, true);\n\t\t\tRocketChat.models.Users.setLivechatStatus(user._id, 'available');\n\t\t\treturn user;\n\t\t}\n\n\t\treturn false;\n\t},\n\n\taddManager(username) {\n\t\tcheck(username, String);\n\n\t\tconst user = RocketChat.models.Users.findOneByUsername(username, { fields: { _id: 1, username: 1 } });\n\n\t\tif (!user) {\n\t\t\tthrow new Meteor.Error('error-invalid-user', 'Invalid user', { method: 'livechat:addManager' });\n\t\t}\n\n\t\tif (RocketChat.authz.addUserRoles(user._id, 'livechat-manager')) {\n\t\t\treturn user;\n\t\t}\n\n\t\treturn false;\n\t},\n\n\tremoveAgent(username) {\n\t\tcheck(username, String);\n\n\t\tconst user = RocketChat.models.Users.findOneByUsername(username, { fields: { _id: 1 } });\n\n\t\tif (!user) {\n\t\t\tthrow new Meteor.Error('error-invalid-user', 'Invalid user', { method: 'livechat:removeAgent' });\n\t\t}\n\n\t\tif (RocketChat.authz.removeUserFromRoles(user._id, 'livechat-agent')) {\n\t\t\tRocketChat.models.Users.setOperator(user._id, false);\n\t\t\tRocketChat.models.Users.setLivechatStatus(user._id, 'not-available');\n\t\t\treturn true;\n\t\t}\n\n\t\treturn false;\n\t},\n\n\tremoveManager(username) {\n\t\tcheck(username, String);\n\n\t\tconst user = RocketChat.models.Users.findOneByUsername(username, { fields: { _id: 1 } });\n\n\t\tif (!user) {\n\t\t\tthrow new Meteor.Error('error-invalid-user', 'Invalid user', { method: 'livechat:removeManager' });\n\t\t}\n\n\t\treturn RocketChat.authz.removeUserFromRoles(user._id, 'livechat-manager');\n\t},\n\n\tsaveDepartment(_id, departmentData, departmentAgents) {\n\t\tcheck(_id, Match.Maybe(String));\n\n\t\tcheck(departmentData, {\n\t\t\tenabled: Boolean,\n\t\t\tname: String,\n\t\t\tdescription: Match.Optional(String),\n\t\t\tshowOnRegistration: Boolean,\n\t\t});\n\n\t\tcheck(departmentAgents, [\n\t\t\tMatch.ObjectIncluding({\n\t\t\t\tagentId: String,\n\t\t\t\tusername: String,\n\t\t\t}),\n\t\t]);\n\n\t\tif (_id) {\n\t\t\tconst department = RocketChat.models.LivechatDepartment.findOneById(_id);\n\t\t\tif (!department) {\n\t\t\t\tthrow new Meteor.Error('error-department-not-found', 'Department not found', { method: 'livechat:saveDepartment' });\n\t\t\t}\n\t\t}\n\n\t\treturn RocketChat.models.LivechatDepartment.createOrUpdateDepartment(_id, departmentData, departmentAgents);\n\t},\n\n\tremoveDepartment(_id) {\n\t\tcheck(_id, String);\n\n\t\tconst department = RocketChat.models.LivechatDepartment.findOneById(_id, { fields: { _id: 1 } });\n\n\t\tif (!department) {\n\t\t\tthrow new Meteor.Error('department-not-found', 'Department not found', { method: 'livechat:removeDepartment' });\n\t\t}\n\n\t\treturn RocketChat.models.LivechatDepartment.removeById(_id);\n\t},\n\n\tshowConnecting() {\n\t\tif (RocketChat.settings.get('Livechat_Routing_Method') === 'Guest_Pool') {\n\t\t\treturn RocketChat.settings.get('Livechat_open_inquiery_show_connecting');\n\t\t} else {\n\t\t\treturn false;\n\t\t}\n\t},\n\n\tsendEmail(from, to, replyTo, subject, html) {\n\t\tMailer.send({\n\t\t\tto,\n\t\t\tfrom,\n\t\t\treplyTo,\n\t\t\tsubject,\n\t\t\thtml,\n\t\t});\n\t},\n\n\tsendTranscript({ token, rid, email }) {\n\t\tcheck(rid, String);\n\t\tcheck(email, String);\n\n\t\tconst room = RocketChat.models.Rooms.findOneById(rid);\n\n\t\tconst visitor = LivechatVisitors.getVisitorByToken(token);\n\t\tconst userLanguage = (visitor && visitor.language) || RocketChat.settings.get('language') || 'en';\n\n\t\t// allow to only user to send transcripts from their own chats\n\t\tif (!room || room.t !== 'l' || !room.v || room.v.token !== token) {\n\t\t\tthrow new Meteor.Error('error-invalid-room', 'Invalid room');\n\t\t}\n\n\t\tconst messages = RocketChat.models.Messages.findVisibleByRoomIdNotContainingTypes(rid, ['livechat_navigation_history'], { sort: { ts: 1 } });\n\n\t\tlet html = '<div> <hr>';\n\t\tmessages.forEach((message) => {\n\t\t\tif (message.t && ['command', 'livechat-close', 'livechat_video_call'].indexOf(message.t) !== -1) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tlet author;\n\t\t\tif (message.u._id === visitor._id) {\n\t\t\t\tauthor = TAPi18n.__('You', { lng: userLanguage });\n\t\t\t} else {\n\t\t\t\tauthor = message.u.username;\n\t\t\t}\n\n\t\t\tconst datetime = moment(message.ts).locale(userLanguage).format('LLL');\n\t\t\tconst singleMessage = `\n\t\t\t\t<p><strong>${ author }</strong>  <em>${ datetime }</em></p>\n\t\t\t\t<p>${ message.msg }</p>\n\t\t\t`;\n\t\t\thtml = html + singleMessage;\n\t\t});\n\n\t\thtml = `${ html }</div>`;\n\n\t\tlet fromEmail = RocketChat.settings.get('From_Email').match(/\\b[A-Z0-9._%+-]+@(?:[A-Z0-9-]+\\.)+[A-Z]{2,4}\\b/i);\n\n\t\tif (fromEmail) {\n\t\t\tfromEmail = fromEmail[0];\n\t\t} else {\n\t\t\tfromEmail = RocketChat.settings.get('From_Email');\n\t\t}\n\n\t\tconst subject = TAPi18n.__('Transcript_of_your_livechat_conversation', { lng: userLanguage });\n\n\t\tthis.sendEmail(fromEmail, email, fromEmail, subject, html);\n\n\t\tMeteor.defer(() => {\n\t\t\tRocketChat.callbacks.run('livechat.sendTranscript', messages, email);\n\t\t});\n\n\t\treturn true;\n\t},\n\n\tsendOfflineMessage(data = {}) {\n\t\tif (!RocketChat.settings.get('Livechat_display_offline_form')) {\n\t\t\treturn false;\n\t\t}\n\n\t\tconst message = (`${ data.message }`).replace(/([^>\\r\\n]?)(\\r\\n|\\n\\r|\\r|\\n)/g, '$1' + '<br>' + '$2');\n\n\t\tconst html = `\n\t\t\t<h1>New livechat message</h1>\n\t\t\t<p><strong>Visitor name:</strong> ${ data.name }</p>\n\t\t\t<p><strong>Visitor email:</strong> ${ data.email }</p>\n\t\t\t<p><strong>Message:</strong><br>${ message }</p>`;\n\n\t\tlet fromEmail = RocketChat.settings.get('From_Email').match(/\\b[A-Z0-9._%+-]+@(?:[A-Z0-9-]+\\.)+[A-Z]{2,4}\\b/i);\n\n\t\tif (fromEmail) {\n\t\t\tfromEmail = fromEmail[0];\n\t\t} else {\n\t\t\tfromEmail = RocketChat.settings.get('From_Email');\n\t\t}\n\n\t\tif (RocketChat.settings.get('Livechat_validate_offline_email')) {\n\t\t\tconst emailDomain = data.email.substr(data.email.lastIndexOf('@') + 1);\n\n\t\t\ttry {\n\t\t\t\tMeteor.wrapAsync(dns.resolveMx)(emailDomain);\n\t\t\t} catch (e) {\n\t\t\t\tthrow new Meteor.Error('error-invalid-email-address', 'Invalid email address', { method: 'livechat:sendOfflineMessage' });\n\t\t\t}\n\t\t}\n\n\t\tconst to = RocketChat.settings.get('Livechat_offline_email');\n\t\tconst from = `${ data.name } - ${ data.email } <${ fromEmail }>`;\n\t\tconst replyTo = `${ data.name } <${ data.email }>`;\n\t\tconst subject = `Livechat offline message from ${ data.name }: ${ (`${ data.message }`).substring(0, 20) }`;\n\n\t\tthis.sendEmail(from, to, replyTo, subject, html);\n\n\t\tMeteor.defer(() => {\n\t\t\tRocketChat.callbacks.run('livechat.offlineMessage', data);\n\t\t});\n\n\t\treturn true;\n\t},\n};\n\nRocketChat.Livechat.stream = new Meteor.Streamer('livechat-room');\n\nRocketChat.Livechat.stream.allowRead((roomId, extraData) => {\n\tconst room = RocketChat.models.Rooms.findOneById(roomId);\n\n\tif (!room) {\n\t\tconsole.warn(`Invalid eventName: \"${ roomId }\"`);\n\t\treturn false;\n\t}\n\n\tif (room.t === 'l' && extraData && extraData.visitorToken && room.v.token === extraData.visitorToken) {\n\t\treturn true;\n\t}\n\treturn false;\n});\n\nRocketChat.settings.get('Livechat_history_monitor_type', (key, value) => {\n\tRocketChat.Livechat.historyMonitorType = value;\n});\n","import _ from 'underscore';\nimport { sendNotification } from 'meteor/rocketchat:lib';\n\nRocketChat.QueueMethods = {\n\t/* Least Amount Queuing method:\n\t *\n\t * default method where the agent with the least number\n\t * of open chats is paired with the incoming livechat\n\t */\n\t'Least_Amount'(guest, message, roomInfo, agent) {\n\t\tif (!agent) {\n\t\t\tagent = RocketChat.Livechat.getNextAgent(guest.department);\n\t\t\tif (!agent) {\n\t\t\t\tthrow new Meteor.Error('no-agent-online', 'Sorry, no online agents');\n\t\t\t}\n\t\t}\n\n\t\tRocketChat.models.Rooms.updateLivechatRoomCount();\n\n\t\tconst room = _.extend({\n\t\t\t_id: message.rid,\n\t\t\tmsgs: 0,\n\t\t\tusersCount: 1,\n\t\t\tlm: new Date(),\n\t\t\tfname: (roomInfo && roomInfo.fname) || guest.name || guest.username,\n\t\t\t// usernames: [agent.username, guest.username],\n\t\t\tt: 'l',\n\t\t\tts: new Date(),\n\t\t\tv: {\n\t\t\t\t_id: guest._id,\n\t\t\t\tusername: guest.username,\n\t\t\t\ttoken: message.token,\n\t\t\t\tstatus: guest.status || 'online',\n\t\t\t},\n\t\t\tservedBy: {\n\t\t\t\t_id: agent.agentId,\n\t\t\t\tusername: agent.username,\n\t\t\t\tts: new Date(),\n\t\t\t},\n\t\t\tcl: false,\n\t\t\topen: true,\n\t\t\twaitingResponse: true,\n\t\t}, roomInfo);\n\n\t\tconst subscriptionData = {\n\t\t\trid: message.rid,\n\t\t\tfname: guest.name || guest.username,\n\t\t\talert: true,\n\t\t\topen: true,\n\t\t\tunread: 1,\n\t\t\tuserMentions: 1,\n\t\t\tgroupMentions: 0,\n\t\t\tu: {\n\t\t\t\t_id: agent.agentId,\n\t\t\t\tusername: agent.username,\n\t\t\t},\n\t\t\tt: 'l',\n\t\t\tdesktopNotifications: 'all',\n\t\t\tmobilePushNotifications: 'all',\n\t\t\temailNotifications: 'all',\n\t\t};\n\n\t\tif (guest.department) {\n\t\t\troom.departmentId = guest.department;\n\t\t}\n\n\t\tRocketChat.models.Rooms.insert(room);\n\n\t\tRocketChat.models.Subscriptions.insert(subscriptionData);\n\n\t\tRocketChat.Livechat.stream.emit(room._id, {\n\t\t\ttype: 'agentData',\n\t\t\tdata: RocketChat.models.Users.getAgentInfo(agent.agentId),\n\t\t});\n\n\t\treturn room;\n\t},\n\t/* Guest Pool Queuing Method:\n\t *\n\t * An incomming livechat is created as an Inquiry\n\t * which is picked up from an agent.\n\t * An Inquiry is visible to all agents (TODO: in the correct department)\n     *\n\t * A room is still created with the initial message, but it is occupied by\n\t * only the client until paired with an agent\n\t */\n\t'Guest_Pool'(guest, message, roomInfo) {\n\t\tlet agents = RocketChat.Livechat.getOnlineAgents(guest.department);\n\n\t\tif (agents.count() === 0 && RocketChat.settings.get('Livechat_guest_pool_with_no_agents')) {\n\t\t\tagents = RocketChat.Livechat.getAgents(guest.department);\n\t\t}\n\n\t\tif (agents.count() === 0) {\n\t\t\tthrow new Meteor.Error('no-agent-online', 'Sorry, no online agents');\n\t\t}\n\n\t\tRocketChat.models.Rooms.updateLivechatRoomCount();\n\n\t\tconst agentIds = [];\n\n\t\tagents.forEach((agent) => {\n\t\t\tif (guest.department) {\n\t\t\t\tagentIds.push(agent.agentId);\n\t\t\t} else {\n\t\t\t\tagentIds.push(agent._id);\n\t\t\t}\n\t\t});\n\n\t\tconst inquiry = {\n\t\t\trid: message.rid,\n\t\t\tmessage: message.msg,\n\t\t\tname: guest.name || guest.username,\n\t\t\tts: new Date(),\n\t\t\tdepartment: guest.department,\n\t\t\tagents: agentIds,\n\t\t\tstatus: 'open',\n\t\t\tv: {\n\t\t\t\t_id: guest._id,\n\t\t\t\tusername: guest.username,\n\t\t\t\ttoken: message.token,\n\t\t\t\tstatus: guest.status || 'online',\n\t\t\t},\n\t\t\tt: 'l',\n\t\t};\n\n\t\tconst room = _.extend({\n\t\t\t_id: message.rid,\n\t\t\tmsgs: 0,\n\t\t\tusersCount: 0,\n\t\t\tlm: new Date(),\n\t\t\tfname: guest.name || guest.username,\n\t\t\t// usernames: [guest.username],\n\t\t\tt: 'l',\n\t\t\tts: new Date(),\n\t\t\tv: {\n\t\t\t\t_id: guest._id,\n\t\t\t\tusername: guest.username,\n\t\t\t\ttoken: message.token,\n\t\t\t\tstatus: guest.status,\n\t\t\t},\n\t\t\tcl: false,\n\t\t\topen: true,\n\t\t\twaitingResponse: true,\n\t\t}, roomInfo);\n\n\t\tif (guest.department) {\n\t\t\troom.departmentId = guest.department;\n\t\t}\n\n\t\tRocketChat.models.LivechatInquiry.insert(inquiry);\n\t\tRocketChat.models.Rooms.insert(room);\n\n\t\t// Alert the agents of the queued request\n\t\tagentIds.forEach((agentId) => {\n\t\t\tsendNotification({\n\t\t\t\t// fake a subscription in order to make use of the function defined above\n\t\t\t\tsubscription: {\n\t\t\t\t\trid: room._id,\n\t\t\t\t\tt : room.t,\n\t\t\t\t\tu: {\n\t\t\t\t\t\t_id : agentId,\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t\tsender: room.v,\n\t\t\t\thasMentionToAll: true, // consider all agents to be in the room\n\t\t\t\thasMentionToHere: false,\n\t\t\t\tmessage: Object.assign(message, { u: room.v }),\n\t\t\t\tnotificationMessage: message.msg,\n\t\t\t\troom: Object.assign(room, { name: TAPi18n.__('New_livechat_in_queue') }),\n\t\t\t\tmentionIds: [],\n\t\t\t});\n\t\t});\n\t\treturn room;\n\t},\n\t'External'(guest, message, roomInfo, agent) {\n\t\treturn this['Least_Amount'](guest, message, roomInfo, agent); // eslint-disable-line\n\t},\n};\n","// Every minute check if office closed\nMeteor.setInterval(function() {\n\tif (RocketChat.settings.get('Livechat_enable_office_hours')) {\n\t\tif (RocketChat.models.LivechatOfficeHour.isOpeningTime()) {\n\t\t\tRocketChat.models.Users.openOffice();\n\t\t} else if (RocketChat.models.LivechatOfficeHour.isClosingTime()) {\n\t\t\tRocketChat.models.Users.closeOffice();\n\t\t}\n\t}\n}, 60000);\n","const gatewayURL = 'https://omni.rocket.chat';\n\nexport default {\n\tenable() {\n\t\tconst result = HTTP.call('POST', `${ gatewayURL }/facebook/enable`, {\n\t\t\theaders: {\n\t\t\t\tauthorization: `Bearer ${ RocketChat.settings.get('Livechat_Facebook_API_Key') }`,\n\t\t\t\t'content-type': 'application/json',\n\t\t\t},\n\t\t\tdata: {\n\t\t\t\turl: RocketChat.settings.get('Site_Url'),\n\t\t\t},\n\t\t});\n\t\treturn result.data;\n\t},\n\n\tdisable() {\n\t\tconst result = HTTP.call('DELETE', `${ gatewayURL }/facebook/enable`, {\n\t\t\theaders: {\n\t\t\t\tauthorization: `Bearer ${ RocketChat.settings.get('Livechat_Facebook_API_Key') }`,\n\t\t\t\t'content-type': 'application/json',\n\t\t\t},\n\t\t});\n\t\treturn result.data;\n\t},\n\n\tlistPages() {\n\t\tconst result = HTTP.call('GET', `${ gatewayURL }/facebook/pages`, {\n\t\t\theaders: {\n\t\t\t\tauthorization: `Bearer ${ RocketChat.settings.get('Livechat_Facebook_API_Key') }`,\n\t\t\t},\n\t\t});\n\t\treturn result.data;\n\t},\n\n\tsubscribe(pageId) {\n\t\tconst result = HTTP.call('POST', `${ gatewayURL }/facebook/page/${ pageId }/subscribe`, {\n\t\t\theaders: {\n\t\t\t\tauthorization: `Bearer ${ RocketChat.settings.get('Livechat_Facebook_API_Key') }`,\n\t\t\t},\n\t\t});\n\t\treturn result.data;\n\t},\n\n\tunsubscribe(pageId) {\n\t\tconst result = HTTP.call('DELETE', `${ gatewayURL }/facebook/page/${ pageId }/subscribe`, {\n\t\t\theaders: {\n\t\t\t\tauthorization: `Bearer ${ RocketChat.settings.get('Livechat_Facebook_API_Key') }`,\n\t\t\t},\n\t\t});\n\t\treturn result.data;\n\t},\n\n\treply({ page, token, text }) {\n\t\treturn HTTP.call('POST', `${ gatewayURL }/facebook/reply`, {\n\t\t\theaders: {\n\t\t\t\tauthorization: `Bearer ${ RocketChat.settings.get('Livechat_Facebook_API_Key') }`,\n\t\t\t},\n\t\t\tdata: {\n\t\t\t\tpage,\n\t\t\t\ttoken,\n\t\t\t\ttext,\n\t\t\t},\n\t\t});\n\t},\n};\n","import LivechatVisitors from './models/LivechatVisitors';\n\nRocketChat.callbacks.add('afterSaveMessage', function(message, room) {\n\t// skips this callback if the message was edited\n\tif (message.editedAt) {\n\t\treturn message;\n\t}\n\n\tif (!RocketChat.SMS.enabled) {\n\t\treturn message;\n\t}\n\n\t// only send the sms by SMS if it is a livechat room with SMS set to true\n\tif (!(typeof room.t !== 'undefined' && room.t === 'l' && room.sms && room.v && room.v.token)) {\n\t\treturn message;\n\t}\n\n\t// if the message has a token, it was sent from the visitor, so ignore it\n\tif (message.token) {\n\t\treturn message;\n\t}\n\n\t// if the message has a type means it is a special message (like the closing comment), so skips\n\tif (message.t) {\n\t\treturn message;\n\t}\n\n\tconst SMSService = RocketChat.SMS.getService(RocketChat.settings.get('SMS_Service'));\n\n\tif (!SMSService) {\n\t\treturn message;\n\t}\n\n\tconst visitor = LivechatVisitors.getVisitorByToken(room.v.token);\n\n\tif (!visitor || !visitor.phone || visitor.phone.length === 0) {\n\t\treturn message;\n\t}\n\n\tSMSService.send(room.sms.from, visitor.phone[0].phoneNumber, message.msg);\n\n\treturn message;\n\n}, RocketChat.callbacks.priority.LOW, 'sendMessageBySms');\n","/* globals UserPresenceMonitor */\n\nlet agentsHandler;\nlet monitorAgents = false;\nlet actionTimeout = 60000;\n\nconst onlineAgents = {\n\tusers: {},\n\tqueue: {},\n\n\tadd(userId) {\n\t\tif (this.queue[userId]) {\n\t\t\tclearTimeout(this.queue[userId]);\n\t\t\tdelete this.queue[userId];\n\t\t}\n\t\tthis.users[userId] = 1;\n\t},\n\n\tremove(userId, callback) {\n\t\tif (this.queue[userId]) {\n\t\t\tclearTimeout(this.queue[userId]);\n\t\t}\n\t\tthis.queue[userId] = setTimeout(Meteor.bindEnvironment(() => {\n\t\t\tcallback();\n\n\t\t\tdelete this.users[userId];\n\t\t\tdelete this.queue[userId];\n\t\t}), actionTimeout);\n\t},\n\n\texists(userId) {\n\t\treturn !!this.users[userId];\n\t},\n};\n\nfunction runAgentLeaveAction(userId) {\n\tconst action = RocketChat.settings.get('Livechat_agent_leave_action');\n\tif (action === 'close') {\n\t\treturn RocketChat.Livechat.closeOpenChats(userId, RocketChat.settings.get('Livechat_agent_leave_comment'));\n\t} else if (action === 'forward') {\n\t\treturn RocketChat.Livechat.forwardOpenChats(userId);\n\t}\n}\n\nRocketChat.settings.get('Livechat_agent_leave_action_timeout', function(key, value) {\n\tactionTimeout = value * 1000;\n});\n\nRocketChat.settings.get('Livechat_agent_leave_action', function(key, value) {\n\tmonitorAgents = value;\n\tif (value !== 'none') {\n\t\tif (!agentsHandler) {\n\t\t\tagentsHandler = RocketChat.models.Users.findOnlineAgents().observeChanges({\n\t\t\t\tadded(id) {\n\t\t\t\t\tonlineAgents.add(id);\n\t\t\t\t},\n\t\t\t\tchanged(id, fields) {\n\t\t\t\t\tif (fields.statusLivechat && fields.statusLivechat === 'not-available') {\n\t\t\t\t\t\tonlineAgents.remove(id, () => {\n\t\t\t\t\t\t\trunAgentLeaveAction(id);\n\t\t\t\t\t\t});\n\t\t\t\t\t} else {\n\t\t\t\t\t\tonlineAgents.add(id);\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\tremoved(id) {\n\t\t\t\t\tonlineAgents.remove(id, () => {\n\t\t\t\t\t\trunAgentLeaveAction(id);\n\t\t\t\t\t});\n\t\t\t\t},\n\t\t\t});\n\t\t}\n\t} else if (agentsHandler) {\n\t\tagentsHandler.stop();\n\t\tagentsHandler = null;\n\t}\n});\n\nUserPresenceMonitor.onSetUserStatus((user, status/* , statusConnection*/) => {\n\tif (!monitorAgents) {\n\t\treturn;\n\t}\n\tif (onlineAgents.exists(user._id)) {\n\t\tif (status === 'offline' || user.statusLivechat === 'not-available') {\n\t\t\tonlineAgents.remove(user._id, () => {\n\t\t\t\trunAgentLeaveAction(user._id);\n\t\t\t});\n\t\t}\n\t}\n});\n","import s from 'underscore.string';\n\nMeteor.publish('livechat:customFields', function(_id) {\n\tif (!this.userId) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:customFields' }));\n\t}\n\n\tif (!RocketChat.authz.hasPermission(this.userId, 'view-l-room')) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:customFields' }));\n\t}\n\n\tif (s.trim(_id)) {\n\t\treturn RocketChat.models.LivechatCustomField.find({ _id });\n\t}\n\n\treturn RocketChat.models.LivechatCustomField.find();\n\n});\n","Meteor.publish('livechat:departmentAgents', function(departmentId) {\n\tif (!this.userId) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:departmentAgents' }));\n\t}\n\n\tif (!RocketChat.authz.hasPermission(this.userId, 'view-livechat-rooms')) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:departmentAgents' }));\n\t}\n\n\treturn RocketChat.models.LivechatDepartmentAgents.find({ departmentId });\n});\n","Meteor.publish('livechat:externalMessages', function(roomId) {\n\treturn RocketChat.models.LivechatExternalMessage.findByRoomId(roomId);\n});\n","Meteor.publish('livechat:agents', function() {\n\tif (!this.userId) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:agents' }));\n\t}\n\n\tif (!RocketChat.authz.hasPermission(this.userId, 'view-l-room')) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:agents' }));\n\t}\n\n\tconst self = this;\n\n\tconst handle = RocketChat.authz.getUsersInRole('livechat-agent').observeChanges({\n\t\tadded(id, fields) {\n\t\t\tself.added('agentUsers', id, fields);\n\t\t},\n\t\tchanged(id, fields) {\n\t\t\tself.changed('agentUsers', id, fields);\n\t\t},\n\t\tremoved(id) {\n\t\t\tself.removed('agentUsers', id);\n\t\t},\n\t});\n\n\tself.ready();\n\n\tself.onStop(function() {\n\t\thandle.stop();\n\t});\n});\n","Meteor.publish('livechat:appearance', function() {\n\tif (!this.userId) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:appearance' }));\n\t}\n\n\tif (!RocketChat.authz.hasPermission(this.userId, 'view-livechat-manager')) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:appearance' }));\n\t}\n\n\tconst query = {\n\t\t_id: {\n\t\t\t$in: [\n\t\t\t\t'Livechat_title',\n\t\t\t\t'Livechat_title_color',\n\t\t\t\t'Livechat_show_agent_email',\n\t\t\t\t'Livechat_display_offline_form',\n\t\t\t\t'Livechat_offline_form_unavailable',\n\t\t\t\t'Livechat_offline_message',\n\t\t\t\t'Livechat_offline_success_message',\n\t\t\t\t'Livechat_offline_title',\n\t\t\t\t'Livechat_offline_title_color',\n\t\t\t\t'Livechat_offline_email',\n\t\t\t\t'Livechat_conversation_finished_message',\n\t\t\t\t'Livechat_registration_form',\n\t\t\t\t'Livechat_name_field_registration_form',\n\t\t\t\t'Livechat_email_field_registration_form',\n\t\t\t],\n\t\t},\n\t};\n\n\tconst self = this;\n\n\tconst handle = RocketChat.models.Settings.find(query).observeChanges({\n\t\tadded(id, fields) {\n\t\t\tself.added('livechatAppearance', id, fields);\n\t\t},\n\t\tchanged(id, fields) {\n\t\t\tself.changed('livechatAppearance', id, fields);\n\t\t},\n\t\tremoved(id) {\n\t\t\tself.removed('livechatAppearance', id);\n\t\t},\n\t});\n\n\tthis.ready();\n\n\tthis.onStop(() => {\n\t\thandle.stop();\n\t});\n});\n","Meteor.publish('livechat:departments', function(_id) {\n\tif (!this.userId) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:agents' }));\n\t}\n\n\tif (!RocketChat.authz.hasPermission(this.userId, 'view-l-room')) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:agents' }));\n\t}\n\n\tif (_id !== undefined) {\n\t\treturn RocketChat.models.LivechatDepartment.findByDepartmentId(_id);\n\t} else {\n\t\treturn RocketChat.models.LivechatDepartment.find();\n\t}\n\n});\n","Meteor.publish('livechat:integration', function() {\n\tif (!this.userId) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:integration' }));\n\t}\n\n\tif (!RocketChat.authz.hasPermission(this.userId, 'view-livechat-manager')) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:integration' }));\n\t}\n\n\tconst self = this;\n\n\tconst handle = RocketChat.models.Settings.findByIds(['Livechat_webhookUrl', 'Livechat_secret_token', 'Livechat_webhook_on_close', 'Livechat_webhook_on_offline_msg', 'Livechat_webhook_on_visitor_message', 'Livechat_webhook_on_agent_message']).observeChanges({\n\t\tadded(id, fields) {\n\t\t\tself.added('livechatIntegration', id, fields);\n\t\t},\n\t\tchanged(id, fields) {\n\t\t\tself.changed('livechatIntegration', id, fields);\n\t\t},\n\t\tremoved(id) {\n\t\t\tself.removed('livechatIntegration', id);\n\t\t},\n\t});\n\n\tself.ready();\n\n\tself.onStop(function() {\n\t\thandle.stop();\n\t});\n});\n","Meteor.publish('livechat:managers', function() {\n\tif (!this.userId) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:managers' }));\n\t}\n\n\tif (!RocketChat.authz.hasPermission(this.userId, 'view-livechat-rooms')) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:managers' }));\n\t}\n\n\tconst self = this;\n\n\tconst handle = RocketChat.authz.getUsersInRole('livechat-manager').observeChanges({\n\t\tadded(id, fields) {\n\t\t\tself.added('managerUsers', id, fields);\n\t\t},\n\t\tchanged(id, fields) {\n\t\t\tself.changed('managerUsers', id, fields);\n\t\t},\n\t\tremoved(id) {\n\t\t\tself.removed('managerUsers', id);\n\t\t},\n\t});\n\n\tself.ready();\n\n\tself.onStop(function() {\n\t\thandle.stop();\n\t});\n});\n","Meteor.publish('livechat:monitoring', function(date) {\n\tif (!this.userId) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:monitoring' }));\n\t}\n\n\tif (!RocketChat.authz.hasPermission(this.userId, 'view-livechat-manager')) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:monitoring' }));\n\t}\n\n\tdate = {\n\t\tgte: new Date(date.gte),\n\t\tlt: new Date(date.lt),\n\t};\n\n\tcheck(date.gte, Date);\n\tcheck(date.lt, Date);\n\n\tconst self = this;\n\n\tconst handle = RocketChat.models.Rooms.getAnalyticsMetricsBetweenDate('l', date).observeChanges({\n\t\tadded(id, fields) {\n\t\t\tself.added('livechatMonitoring', id, fields);\n\t\t},\n\t\tchanged(id, fields) {\n\t\t\tself.changed('livechatMonitoring', id, fields);\n\t\t},\n\t\tremoved(id) {\n\t\t\tself.removed('livechatMonitoring', id);\n\t\t},\n\t});\n\n\tself.ready();\n\n\tself.onStop(function() {\n\t\thandle.stop();\n\t});\n});\n","Meteor.publish('livechat:rooms', function(filter = {}, offset = 0, limit = 20) {\n\tif (!this.userId) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:rooms' }));\n\t}\n\n\tif (!RocketChat.authz.hasPermission(this.userId, 'view-livechat-rooms')) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:rooms' }));\n\t}\n\n\tcheck(filter, {\n\t\tname: Match.Maybe(String), // room name to filter\n\t\tagent: Match.Maybe(String), // agent _id who is serving\n\t\tstatus: Match.Maybe(String), // either 'opened' or 'closed'\n\t\tfrom: Match.Maybe(Date),\n\t\tto: Match.Maybe(Date),\n\t});\n\n\tconst query = {};\n\tif (filter.name) {\n\t\tquery.label = new RegExp(filter.name, 'i');\n\t}\n\tif (filter.agent) {\n\t\tquery['servedBy._id'] = filter.agent;\n\t}\n\tif (filter.status) {\n\t\tif (filter.status === 'opened') {\n\t\t\tquery.open = true;\n\t\t} else {\n\t\t\tquery.open = { $exists: false };\n\t\t}\n\t}\n\tif (filter.from) {\n\t\tquery.ts = {\n\t\t\t$gte: filter.from,\n\t\t};\n\t}\n\tif (filter.to) {\n\t\tfilter.to.setDate(filter.to.getDate() + 1);\n\t\tfilter.to.setSeconds(filter.to.getSeconds() - 1);\n\n\t\tif (!query.ts) {\n\t\t\tquery.ts = {};\n\t\t}\n\t\tquery.ts.$lte = filter.to;\n\t}\n\n\tconst self = this;\n\n\tconst handle = RocketChat.models.Rooms.findLivechat(query, offset, limit).observeChanges({\n\t\tadded(id, fields) {\n\t\t\tself.added('livechatRoom', id, fields);\n\t\t},\n\t\tchanged(id, fields) {\n\t\t\tself.changed('livechatRoom', id, fields);\n\t\t},\n\t\tremoved(id) {\n\t\t\tself.removed('livechatRoom', id);\n\t\t},\n\t});\n\n\tthis.ready();\n\n\tthis.onStop(() => {\n\t\thandle.stop();\n\t});\n});\n","Meteor.publish('livechat:queue', function() {\n\tif (!this.userId) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:queue' }));\n\t}\n\n\tif (!RocketChat.authz.hasPermission(this.userId, 'view-l-room')) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:queue' }));\n\t}\n\n\t// let sort = { count: 1, sort: 1, username: 1 };\n\t// let onlineUsers = {};\n\n\t// let handleUsers = RocketChat.models.Users.findOnlineAgents().observeChanges({\n\t// \tadded(id, fields) {\n\t// \t\tonlineUsers[fields.username] = 1;\n\t// \t\t// this.added('livechatQueueUser', id, fields);\n\t// \t},\n\t// \tchanged(id, fields) {\n\t// \t\tonlineUsers[fields.username] = 1;\n\t// \t\t// this.changed('livechatQueueUser', id, fields);\n\t// \t},\n\t// \tremoved(id) {\n\t// \t\tthis.removed('livechatQueueUser', id);\n\t// \t}\n\t// });\n\n\tconst self = this;\n\n\tconst handleDepts = RocketChat.models.LivechatDepartmentAgents.findUsersInQueue().observeChanges({\n\t\tadded(id, fields) {\n\t\t\tself.added('livechatQueueUser', id, fields);\n\t\t},\n\t\tchanged(id, fields) {\n\t\t\tself.changed('livechatQueueUser', id, fields);\n\t\t},\n\t\tremoved(id) {\n\t\t\tself.removed('livechatQueueUser', id);\n\t\t},\n\t});\n\n\tthis.ready();\n\n\tthis.onStop(() => {\n\t\t// handleUsers.stop();\n\t\thandleDepts.stop();\n\t});\n});\n","Meteor.publish('livechat:triggers', function(_id) {\n\tif (!this.userId) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:triggers' }));\n\t}\n\n\tif (!RocketChat.authz.hasPermission(this.userId, 'view-livechat-manager')) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:triggers' }));\n\t}\n\n\tif (_id !== undefined) {\n\t\treturn RocketChat.models.LivechatTrigger.findById(_id);\n\t} else {\n\t\treturn RocketChat.models.LivechatTrigger.find();\n\t}\n});\n","import LivechatVisitors from '../models/LivechatVisitors';\n\nMeteor.publish('livechat:visitors', function(date) {\n\tif (!this.userId) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:visitors' }));\n\t}\n\n\tif (!RocketChat.authz.hasPermission(this.userId, 'view-livechat-manager')) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:visitors' }));\n\t}\n\n\tdate = {\n\t\tgte: new Date(date.gte),\n\t\tlt: new Date(date.lt),\n\t};\n\n\tcheck(date.gte, Date);\n\tcheck(date.lt, Date);\n\n\tconst self = this;\n\n\tconst handle = LivechatVisitors.getVisitorsBetweenDate(date).observeChanges({\n\t\tadded(id, fields) {\n\t\t\tself.added('livechatVisitors', id, fields);\n\t\t},\n\t\tchanged(id, fields) {\n\t\t\tself.changed('livechatVisitors', id, fields);\n\t\t},\n\t\tremoved(id) {\n\t\t\tself.removed('livechatVisitors', id);\n\t\t},\n\t});\n\n\tself.ready();\n\n\tself.onStop(function() {\n\t\thandle.stop();\n\t});\n});\n","Meteor.publish('livechat:visitorHistory', function({ rid: roomId }) {\n\tif (!this.userId) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:visitorHistory' }));\n\t}\n\n\tif (!RocketChat.authz.hasPermission(this.userId, 'view-l-room')) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:visitorHistory' }));\n\t}\n\n\tconst room = RocketChat.models.Rooms.findOneById(roomId);\n\n\tconst subscription = RocketChat.models.Subscriptions.findOneByRoomIdAndUserId(room._id, this.userId, { fields: { _id: 1 } });\n\tif (!subscription) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:visitorHistory' }));\n\t}\n\n\tconst self = this;\n\n\tif (room && room.v && room.v._id) {\n\t\tconst handle = RocketChat.models.Rooms.findByVisitorId(room.v._id).observeChanges({\n\t\t\tadded(id, fields) {\n\t\t\t\tself.added('visitor_history', id, fields);\n\t\t\t},\n\t\t\tchanged(id, fields) {\n\t\t\t\tself.changed('visitor_history', id, fields);\n\t\t\t},\n\t\t\tremoved(id) {\n\t\t\t\tself.removed('visitor_history', id);\n\t\t\t},\n\t\t});\n\n\t\tself.ready();\n\n\t\tself.onStop(function() {\n\t\t\thandle.stop();\n\t\t});\n\t} else {\n\t\tself.ready();\n\t}\n});\n","import LivechatVisitors from '../models/LivechatVisitors';\n\nMeteor.publish('livechat:visitorInfo', function({ rid: roomId }) {\n\tif (!this.userId) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:visitorInfo' }));\n\t}\n\n\tif (!RocketChat.authz.hasPermission(this.userId, 'view-l-room')) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:visitorInfo' }));\n\t}\n\n\tconst room = RocketChat.models.Rooms.findOneById(roomId);\n\n\tif (room && room.v && room.v._id) {\n\t\treturn LivechatVisitors.findById(room.v._id);\n\t} else {\n\t\treturn this.ready();\n\t}\n});\n","Meteor.publish('livechat:visitorPageVisited', function({ rid: roomId }) {\n\n\tif (!this.userId) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:visitorPageVisited' }));\n\t}\n\n\tif (!RocketChat.authz.hasPermission(this.userId, 'view-l-room')) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:visitorPageVisited' }));\n\t}\n\n\tconst self = this;\n\tconst room = RocketChat.models.Rooms.findOneById(roomId);\n\n\tif (room) {\n\t\tconst handle = RocketChat.models.Messages.findByRoomIdAndType(room._id, 'livechat_navigation_history').observeChanges({\n\t\t\tadded(id, fields) {\n\t\t\t\tself.added('visitor_navigation_history', id, fields);\n\t\t\t},\n\t\t\tchanged(id, fields) {\n\t\t\t\tself.changed('visitor_navigation_history', id, fields);\n\t\t\t},\n\t\t\tremoved(id) {\n\t\t\t\tself.removed('visitor_navigation_history', id);\n\t\t\t},\n\t\t});\n\n\t\tself.ready();\n\n\t\tself.onStop(function() {\n\t\t\thandle.stop();\n\t\t});\n\t} else {\n\t\tself.ready();\n\t}\n});\n","Meteor.publish('livechat:inquiry', function() {\n\tif (!this.userId) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:inquiry' }));\n\t}\n\n\tif (!RocketChat.authz.hasPermission(this.userId, 'view-l-room')) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:inquiry' }));\n\t}\n\n\tconst query = {\n\t\tagents: this.userId,\n\t\tstatus: 'open',\n\t};\n\n\treturn RocketChat.models.LivechatInquiry.find(query);\n});\n","Meteor.publish('livechat:officeHour', function() {\n\tif (!RocketChat.authz.hasPermission(this.userId, 'view-l-room')) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:agents' }));\n\t}\n\n\treturn RocketChat.models.LivechatOfficeHour.find();\n});\n","import '../imports/server/rest/departments.js';\nimport '../imports/server/rest/facebook.js';\nimport '../imports/server/rest/sms.js';\nimport '../imports/server/rest/users.js';\nimport '../imports/server/rest/upload.js';\n","import './v1/config.js';\nimport './v1/visitor.js';\nimport './v1/transcript.js';\nimport './v1/offlineMessage.js';\nimport './v1/pageVisited.js';\nimport './v1/agent.js';\nimport './v1/message.js';\nimport './v1/customField.js';\nimport './v1/room.js';\nimport './v1/videoCall.js';\n","import _ from 'underscore';\nimport LivechatVisitors from '../../models/LivechatVisitors';\n\nexport function online() {\n\treturn RocketChat.models.Users.findOnlineAgents().count() > 0;\n}\n\nexport function findTriggers() {\n\treturn RocketChat.models.LivechatTrigger.findEnabled().fetch().map((trigger) => _.pick(trigger, '_id', 'actions', 'conditions'));\n}\n\nexport function findDepartments() {\n\treturn RocketChat.models.LivechatDepartment.findEnabledWithAgents().fetch().map((department) => _.pick(department, '_id', 'name', 'showOnRegistration'));\n}\n\nexport function findGuest(token) {\n\treturn LivechatVisitors.getVisitorByToken(token, {\n\t\tfields: {\n\t\t\tname: 1,\n\t\t\tusername: 1,\n\t\t\ttoken: 1,\n\t\t},\n\t});\n}\n\nexport function findRoom(token, rid) {\n\tconst fields = {\n\t\tdepartmentId: 1,\n\t\tservedBy: 1,\n\t\topen: 1,\n\t};\n\n\tif (!rid) {\n\t\treturn RocketChat.models.Rooms.findLivechatByVisitorToken(token, fields);\n\t}\n\n\treturn RocketChat.models.Rooms.findLivechatByIdAndVisitorToken(rid, token, fields);\n}\n\nexport function getRoom(guest, rid, roomInfo) {\n\tconst token = guest && guest.token;\n\n\tconst message = {\n\t\t_id: Random.id(),\n\t\trid,\n\t\tmsg: '',\n\t\ttoken,\n\t\tts: new Date(),\n\t};\n\n\treturn RocketChat.Livechat.getRoom(guest, message, roomInfo);\n}\n\nexport function findAgent(agentId) {\n\treturn RocketChat.models.Users.getAgentInfo(agentId);\n}\n\nexport function settings() {\n\tconst initSettings = RocketChat.Livechat.getInitSettings();\n\n\treturn {\n\t\tenabled: initSettings.Livechat_enabled,\n\t\tsettings: {\n\t\t\tregistrationForm: initSettings.Livechat_registration_form,\n\t\t\tallowSwitchingDepartments: initSettings.Livechat_allow_switching_departments,\n\t\t\tnameFieldRegistrationForm: initSettings.Livechat_name_field_registration_form,\n\t\t\temailFieldRegistrationForm: initSettings.Livechat_email_field_registration_form,\n\t\t\tdisplayOfflineForm: initSettings.Livechat_display_offline_form,\n\t\t\tvideoCall: initSettings.Livechat_videocall_enabled === true && initSettings.Jitsi_Enabled === true,\n\t\t\tfileUpload: initSettings.Livechat_fileupload_enabled && initSettings.FileUpload_Enabled,\n\t\t\tlanguage: initSettings.Language,\n\t\t\ttranscript: initSettings.Livechat_enable_transcript,\n\t\t\thistoryMonitorType: initSettings.Livechat_history_monitor_type,\n\t\t},\n\t\ttheme: {\n\t\t\ttitle: initSettings.Livechat_title,\n\t\t\tcolor: initSettings.Livechat_title_color,\n\t\t\tofflineTitle: initSettings.Livechat_offline_title,\n\t\t\tofflineColor: initSettings.Livechat_offline_title_color,\n\t\t\tactionLinks: [\n\t\t\t\t{ icon: 'icon-videocam', i18nLabel: 'Accept', method_id: 'createLivechatCall', params: '' },\n\t\t\t\t{ icon: 'icon-cancel', i18nLabel: 'Decline', method_id: 'denyLivechatCall', params: '' },\n\t\t\t],\n\t\t},\n\t\tmessages: {\n\t\t\tofflineMessage: initSettings.Livechat_offline_message,\n\t\t\tofflineSuccessMessage: initSettings.Livechat_offline_success_message,\n\t\t\tofflineUnavailableMessage: initSettings.Livechat_offline_form_unavailable,\n\t\t\tconversationFinishedMessage: initSettings.Livechat_conversation_finished_message,\n\t\t\ttranscriptMessage: initSettings.Livechat_transcript_message,\n\t\t},\n\t\tsurvey: {\n\t\t\titems: ['satisfaction', 'agentKnowledge', 'agentResposiveness', 'agentFriendliness'],\n\t\t\tvalues: ['1', '2', '3', '4', '5'],\n\t\t},\n\t};\n}\n\n\n","import { findRoom, findGuest, findAgent } from '../lib/livechat';\n\nRocketChat.API.v1.addRoute('livechat/agent.info/:rid/:token', {\n\tget() {\n\t\ttry {\n\t\t\tcheck(this.urlParams, {\n\t\t\t\trid: String,\n\t\t\t\ttoken: String,\n\t\t\t});\n\n\t\t\tconst visitor = findGuest(this.urlParams.token);\n\t\t\tif (!visitor) {\n\t\t\t\tthrow new Meteor.Error('invalid-token');\n\t\t\t}\n\n\t\t\tconst room = findRoom(this.urlParams.token, this.urlParams.rid);\n\t\t\tif (!room) {\n\t\t\t\tthrow new Meteor.Error('invalid-room');\n\t\t\t}\n\n\t\t\tconst agent = room && room.servedBy && findAgent(room.servedBy._id);\n\t\t\tif (!agent) {\n\t\t\t\tthrow new Meteor.Error('invalid-agent');\n\t\t\t}\n\n\t\t\treturn RocketChat.API.v1.success({ agent });\n\t\t} catch (e) {\n\t\t\treturn RocketChat.API.v1.failure(e);\n\t\t}\n\t},\n});\n\nRocketChat.API.v1.addRoute('livechat/agent.next/:token', {\n\tget() {\n\t\ttry {\n\t\t\tcheck(this.urlParams, {\n\t\t\t\ttoken: String,\n\t\t\t});\n\n\t\t\tcheck(this.queryParams, {\n\t\t\t\tdepartment: Match.Maybe(String),\n\t\t\t});\n\n\t\t\tconst visitor = findGuest(this.urlParams.token);\n\t\t\tif (!visitor) {\n\t\t\t\tthrow new Meteor.Error('invalid-token');\n\t\t\t}\n\n\t\t\tlet { department } = this.queryParams;\n\t\t\tif (!department) {\n\t\t\t\tconst requireDeparment = RocketChat.Livechat.getRequiredDepartment();\n\t\t\t\tif (requireDeparment) {\n\t\t\t\t\tdepartment = requireDeparment._id;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tconst agentData = RocketChat.Livechat.getNextAgent(department);\n\t\t\tif (!agentData) {\n\t\t\t\tthrow new Meteor.Error('agent-not-found');\n\t\t\t}\n\n\t\t\tconst agent = findAgent(agentData.agentId);\n\t\t\tif (!agent) {\n\t\t\t\tthrow new Meteor.Error('invalid-agent');\n\t\t\t}\n\n\t\t\treturn RocketChat.API.v1.success({ agent });\n\t\t} catch (e) {\n\t\t\treturn RocketChat.API.v1.failure(e);\n\t\t}\n\t},\n});\n","import { findRoom, findGuest, settings, online } from '../lib/livechat';\n\nRocketChat.API.v1.addRoute('livechat/config', {\n\tget() {\n\t\ttry {\n\t\t\tcheck(this.queryParams, {\n\t\t\t\ttoken: Match.Maybe(String),\n\t\t\t});\n\n\t\t\tconst config = settings();\n\t\t\tif (!config.enabled) {\n\t\t\t\treturn RocketChat.API.v1.success({ config: { enabled: false } });\n\t\t\t}\n\n\t\t\tconst { status } = online();\n\n\t\t\tlet guest;\n\t\t\tlet room;\n\t\t\tlet agent;\n\n\t\t\tif (this.queryParams.token) {\n\t\t\t\tguest = findGuest(this.queryParams.token);\n\t\t\t\troom = findRoom(this.queryParams.token);\n\t\t\t\tagent = room && room.servedBy && RocketChat.models.Users.getAgentInfo(room.servedBy._id);\n\t\t\t}\n\n\t\t\tObject.assign(config, { online: status, guest, room, agent });\n\n\t\t\treturn RocketChat.API.v1.success({ config });\n\t\t} catch (e) {\n\t\t\treturn RocketChat.API.v1.failure(e);\n\t\t}\n\t},\n});\n","import { findGuest } from '../lib/livechat';\n\nRocketChat.API.v1.addRoute('livechat/custom.field', {\n\tpost() {\n\t\ttry {\n\t\t\tcheck(this.bodyParams, {\n\t\t\t\ttoken: String,\n\t\t\t\tkey: String,\n\t\t\t\tvalue: String,\n\t\t\t\toverwrite: Boolean,\n\t\t\t});\n\n\t\t\tconst { token, key, value, overwrite } = this.bodyParams;\n\n\t\t\tconst guest = findGuest(token);\n\t\t\tif (!guest) {\n\t\t\t\tthrow new Meteor.Error('invalid-token');\n\t\t\t}\n\n\t\t\tif (!RocketChat.Livechat.setCustomFields({ token, key, value, overwrite })) {\n\t\t\t\treturn RocketChat.API.v1.failure();\n\t\t\t}\n\n\t\t\treturn RocketChat.API.v1.success({ field: { key, value, overwrite } });\n\t\t} catch (e) {\n\t\t\treturn RocketChat.API.v1.failure(e);\n\t\t}\n\t},\n});\n\nRocketChat.API.v1.addRoute('livechat/custom.fields', {\n\tpost() {\n\t\tcheck(this.bodyParams, {\n\t\t\ttoken: String,\n\t\t\tcustomFields: [\n\t\t\t\tMatch.ObjectIncluding({\n\t\t\t\t\tkey: String,\n\t\t\t\t\tvalue: String,\n\t\t\t\t\toverwrite: Boolean,\n\t\t\t\t}),\n\t\t\t],\n\t\t});\n\n\t\tconst { token } = this.bodyParams;\n\t\tconst guest = findGuest(token);\n\t\tif (!guest) {\n\t\t\tthrow new Meteor.Error('invalid-token');\n\t\t}\n\n\t\tconst fields = this.bodyParams.customFields.map((customField) => {\n\t\t\tconst data = Object.assign({ token }, customField);\n\t\t\tif (!RocketChat.Livechat.setCustomFields(data)) {\n\t\t\t\treturn RocketChat.API.v1.failure();\n\t\t\t}\n\n\t\t\treturn { Key: customField.key, value: customField.value, overwrite: customField.overwrite };\n\t\t});\n\n\t\treturn RocketChat.API.v1.success({ fields });\n\t},\n});\n\n","import LivechatVisitors from '../../../server/models/LivechatVisitors';\nimport { findGuest, findRoom } from '../lib/livechat';\n\nRocketChat.API.v1.addRoute('livechat/message', {\n\tpost() {\n\t\ttry {\n\t\t\tcheck(this.bodyParams, {\n\t\t\t\t_id: Match.Maybe(String),\n\t\t\t\ttoken: String,\n\t\t\t\trid: String,\n\t\t\t\tmsg: String,\n\t\t\t\tagent: Match.Maybe({\n\t\t\t\t\tagentId: String,\n\t\t\t\t\tusername: String,\n\t\t\t\t}),\n\t\t\t});\n\n\t\t\tconst { token, rid, agent, msg } = this.bodyParams;\n\n\t\t\tconst guest = findGuest(token);\n\t\t\tif (!guest) {\n\t\t\t\tthrow new Meteor.Error('invalid-token');\n\t\t\t}\n\n\t\t\tconst room = findRoom(token, rid);\n\t\t\tif (!room) {\n\t\t\t\tthrow new Meteor.Error('invalid-room');\n\t\t\t}\n\n\t\t\tconst _id = this.bodyParams._id || Random.id();\n\n\t\t\tconst sendMessage = {\n\t\t\t\tguest,\n\t\t\t\tmessage: {\n\t\t\t\t\t_id,\n\t\t\t\t\trid,\n\t\t\t\t\tmsg,\n\t\t\t\t\ttoken,\n\t\t\t\t},\n\t\t\t\tagent,\n\t\t\t};\n\n\t\t\tconst result = RocketChat.Livechat.sendMessage(sendMessage);\n\t\t\tif (result) {\n\t\t\t\tconst message = { _id: result._id, msg: result.msg, u: result.u, ts: result.ts };\n\t\t\t\treturn RocketChat.API.v1.success({ message });\n\t\t\t}\n\n\t\t\treturn RocketChat.API.v1.failure();\n\t\t} catch (e) {\n\t\t\treturn RocketChat.API.v1.failure(e);\n\t\t}\n\t},\n});\n\nRocketChat.API.v1.addRoute('livechat/message/:_id', {\n\tput() {\n\t\ttry {\n\t\t\tcheck(this.urlParams, {\n\t\t\t\t_id: String,\n\t\t\t});\n\n\t\t\tcheck(this.bodyParams, {\n\t\t\t\ttoken: String,\n\t\t\t\trid: String,\n\t\t\t\tmsg: String,\n\t\t\t});\n\n\t\t\tconst { token, rid } = this.bodyParams;\n\t\t\tconst { _id } = this.urlParams;\n\n\t\t\tconst guest = findGuest(token);\n\t\t\tif (!guest) {\n\t\t\t\tthrow new Meteor.Error('invalid-token');\n\t\t\t}\n\n\t\t\tconst room = findRoom(token, rid);\n\t\t\tif (!room) {\n\t\t\t\tthrow new Meteor.Error('invalid-room');\n\t\t\t}\n\n\t\t\tconst msg = RocketChat.models.Messages.findOneById(_id);\n\t\t\tif (!msg) {\n\t\t\t\tthrow new Meteor.Error('invalid-message');\n\t\t\t}\n\n\t\t\tconst message = { _id: msg._id, msg: this.bodyParams.msg };\n\n\t\t\tconst result = RocketChat.Livechat.updateMessage({ guest, message });\n\t\t\tif (result) {\n\t\t\t\tconst data = RocketChat.models.Messages.findOneById(_id);\n\t\t\t\treturn RocketChat.API.v1.success({\n\t\t\t\t\tmessage: { _id: data._id, msg: data.msg, u: data.u, ts: data.ts },\n\t\t\t\t});\n\t\t\t}\n\n\t\t\treturn RocketChat.API.v1.failure();\n\t\t} catch (e) {\n\t\t\treturn RocketChat.API.v1.failure(e.error);\n\t\t}\n\t},\n\tdelete() {\n\t\ttry {\n\t\t\tcheck(this.urlParams, {\n\t\t\t\t_id: String,\n\t\t\t});\n\n\t\t\tcheck(this.bodyParams, {\n\t\t\t\ttoken: String,\n\t\t\t\trid: String,\n\t\t\t});\n\n\t\t\tconst { token, rid } = this.bodyParams;\n\t\t\tconst { _id } = this.urlParams;\n\n\t\t\tconst guest = findGuest(token);\n\t\t\tif (!guest) {\n\t\t\t\tthrow new Meteor.Error('invalid-token');\n\t\t\t}\n\n\t\t\tconst room = findRoom(token, rid);\n\t\t\tif (!room) {\n\t\t\t\tthrow new Meteor.Error('invalid-room');\n\t\t\t}\n\n\t\t\tconst message = RocketChat.models.Messages.findOneById(_id);\n\t\t\tif (!message) {\n\t\t\t\tthrow new Meteor.Error('invalid-message');\n\t\t\t}\n\n\t\t\tconst result = RocketChat.Livechat.deleteMessage({ guest, message });\n\t\t\tif (result) {\n\t\t\t\treturn RocketChat.API.v1.success({\n\t\t\t\t\tmessage: {\n\t\t\t\t\t\t_id,\n\t\t\t\t\t\tts: new Date().toISOString(),\n\t\t\t\t\t},\n\t\t\t\t});\n\t\t\t}\n\n\t\t\treturn RocketChat.API.v1.failure();\n\t\t} catch (e) {\n\t\t\treturn RocketChat.API.v1.failure(e.error);\n\t\t}\n\t},\n});\n\nRocketChat.API.v1.addRoute('livechat/messages.history/:rid', {\n\tget() {\n\t\ttry {\n\t\t\tcheck(this.urlParams, {\n\t\t\t\trid: String,\n\t\t\t});\n\n\t\t\tconst { rid } = this.urlParams;\n\t\t\tconst { token } = this.queryParams;\n\n\t\t\tif (!token) {\n\t\t\t\tthrow new Meteor.Error('error-token-param-not-provided', 'The required \"token\" query param is missing.');\n\t\t\t}\n\n\t\t\tconst guest = findGuest(token);\n\t\t\tif (!guest) {\n\t\t\t\tthrow new Meteor.Error('invalid-token');\n\t\t\t}\n\n\t\t\tconst room = findRoom(token, rid);\n\t\t\tif (!room) {\n\t\t\t\tthrow new Meteor.Error('invalid-room');\n\t\t\t}\n\n\t\t\tlet ls = undefined;\n\t\t\tif (this.queryParams.ls) {\n\t\t\t\tls = new Date(this.queryParams.ls);\n\t\t\t}\n\n\t\t\tlet end = undefined;\n\t\t\tif (this.queryParams.end) {\n\t\t\t\tend = new Date(this.queryParams.end);\n\t\t\t}\n\n\t\t\tlet limit = 20;\n\t\t\tif (this.queryParams.limit) {\n\t\t\t\tlimit = parseInt(this.queryParams.limit);\n\t\t\t}\n\n\t\t\tconst messages = RocketChat.loadMessageHistory({ userId: guest._id, rid, end, limit, ls });\n\t\t\treturn RocketChat.API.v1.success(messages);\n\t\t} catch (e) {\n\t\t\treturn RocketChat.API.v1.failure(e.error);\n\t\t}\n\t},\n});\n\nRocketChat.API.v1.addRoute('livechat/messages', { authRequired: true }, {\n\tpost() {\n\t\tif (!RocketChat.authz.hasPermission(this.userId, 'view-livechat-manager')) {\n\t\t\treturn RocketChat.API.v1.unauthorized();\n\t\t}\n\n\t\tif (!this.bodyParams.visitor) {\n\t\t\treturn RocketChat.API.v1.failure('Body param \"visitor\" is required');\n\t\t}\n\t\tif (!this.bodyParams.visitor.token) {\n\t\t\treturn RocketChat.API.v1.failure('Body param \"visitor.token\" is required');\n\t\t}\n\t\tif (!this.bodyParams.messages) {\n\t\t\treturn RocketChat.API.v1.failure('Body param \"messages\" is required');\n\t\t}\n\t\tif (!(this.bodyParams.messages instanceof Array)) {\n\t\t\treturn RocketChat.API.v1.failure('Body param \"messages\" is not an array');\n\t\t}\n\t\tif (this.bodyParams.messages.length === 0) {\n\t\t\treturn RocketChat.API.v1.failure('Body param \"messages\" is empty');\n\t\t}\n\n\t\tconst visitorToken = this.bodyParams.visitor.token;\n\n\t\tlet visitor = LivechatVisitors.getVisitorByToken(visitorToken);\n\t\tlet rid;\n\t\tif (visitor) {\n\t\t\tconst rooms = RocketChat.models.Rooms.findOpenByVisitorToken(visitorToken).fetch();\n\t\t\tif (rooms && rooms.length > 0) {\n\t\t\t\trid = rooms[0]._id;\n\t\t\t} else {\n\t\t\t\trid = Random.id();\n\t\t\t}\n\t\t} else {\n\t\t\trid = Random.id();\n\t\t\tconst visitorId = RocketChat.Livechat.registerGuest(this.bodyParams.visitor);\n\t\t\tvisitor = LivechatVisitors.findOneById(visitorId);\n\t\t}\n\n\t\tconst sentMessages = this.bodyParams.messages.map((message) => {\n\t\t\tconst sendMessage = {\n\t\t\t\tguest: visitor,\n\t\t\t\tmessage: {\n\t\t\t\t\t_id: Random.id(),\n\t\t\t\t\trid,\n\t\t\t\t\ttoken: visitorToken,\n\t\t\t\t\tmsg: message.msg,\n\t\t\t\t},\n\t\t\t};\n\t\t\tconst sentMessage = RocketChat.Livechat.sendMessage(sendMessage);\n\t\t\treturn {\n\t\t\t\tusername: sentMessage.u.username,\n\t\t\t\tmsg: sentMessage.msg,\n\t\t\t\tts: sentMessage.ts,\n\t\t\t};\n\t\t});\n\n\t\treturn RocketChat.API.v1.success({\n\t\t\tmessages: sentMessages,\n\t\t});\n\t},\n});\n","RocketChat.API.v1.addRoute('livechat/offline.message', {\n\tpost() {\n\t\ttry {\n\t\t\tcheck(this.bodyParams, {\n\t\t\t\tname: String,\n\t\t\t\temail: String,\n\t\t\t\tmessage: String,\n\t\t\t});\n\n\t\t\tconst { name, email, message } = this.bodyParams;\n\t\t\tif (!RocketChat.Livechat.sendOfflineMessage({ name, email, message })) {\n\t\t\t\treturn RocketChat.API.v1.failure({ message: TAPi18n.__('Error_sending_livechat_offline_message') });\n\t\t\t}\n\n\t\t\treturn RocketChat.API.v1.success({ message: TAPi18n.__('Livechat_offline_message_sent') });\n\t\t} catch (e) {\n\t\t\treturn RocketChat.API.v1.failure(e);\n\t\t}\n\t},\n});\n","import _ from 'underscore';\nimport { findGuest, findRoom } from '../lib/livechat';\n\nRocketChat.API.v1.addRoute('livechat/page.visited', {\n\tpost() {\n\t\ttry {\n\t\t\tcheck(this.bodyParams, {\n\t\t\t\ttoken: String,\n\t\t\t\trid: String,\n\t\t\t\tpageInfo: Match.ObjectIncluding({\n\t\t\t\t\tchange: String,\n\t\t\t\t\ttitle: String,\n\t\t\t\t\tlocation: Match.ObjectIncluding({\n\t\t\t\t\t\thref: String,\n\t\t\t\t\t}),\n\t\t\t\t}),\n\t\t\t});\n\n\t\t\tconst { token, rid, pageInfo } = this.bodyParams;\n\n\t\t\tconst guest = findGuest(token);\n\t\t\tif (!guest) {\n\t\t\t\tthrow new Meteor.Error('invalid-token');\n\t\t\t}\n\n\t\t\tconst room = findRoom(token, rid);\n\t\t\tif (!room) {\n\t\t\t\tthrow new Meteor.Error('invalid-room');\n\t\t\t}\n\n\t\t\tconst obj = RocketChat.Livechat.savePageHistory(token, rid, pageInfo);\n\t\t\tif (obj) {\n\t\t\t\tconst page = _.pick(obj, 'msg', 'navigation');\n\t\t\t\treturn RocketChat.API.v1.success({ page });\n\t\t\t}\n\n\t\t\treturn RocketChat.API.v1.success();\n\t\t} catch (e) {\n\t\t\treturn RocketChat.API.v1.failure(e);\n\t\t}\n\t},\n});\n","import { findGuest, findRoom, getRoom, settings } from '../lib/livechat';\n\nRocketChat.API.v1.addRoute('livechat/room', {\n\tget() {\n\t\ttry {\n\t\t\tcheck(this.queryParams, {\n\t\t\t\ttoken: String,\n\t\t\t\trid: Match.Maybe(String),\n\t\t\t});\n\n\t\t\tconst { token } = this.queryParams;\n\t\t\tconst guest = findGuest(token);\n\t\t\tif (!guest) {\n\t\t\t\tthrow new Meteor.Error('invalid-token');\n\t\t\t}\n\n\t\t\tconst rid = this.queryParams.rid || Random.id();\n\t\t\tconst room = getRoom(guest, rid);\n\n\t\t\treturn RocketChat.API.v1.success(room);\n\t\t} catch (e) {\n\t\t\treturn RocketChat.API.v1.failure(e);\n\t\t}\n\t},\n});\n\nRocketChat.API.v1.addRoute('livechat/room.close', {\n\tpost() {\n\t\ttry {\n\t\t\tcheck(this.bodyParams, {\n\t\t\t\trid: String,\n\t\t\t\ttoken: String,\n\t\t\t});\n\n\t\t\tconst { rid } = this.bodyParams;\n\t\t\tconst { token } = this.bodyParams;\n\n\t\t\tconst visitor = findGuest(token);\n\t\t\tif (!visitor) {\n\t\t\t\tthrow new Meteor.Error('invalid-token');\n\t\t\t}\n\n\t\t\tconst room = findRoom(token, rid);\n\t\t\tif (!room) {\n\t\t\t\tthrow new Meteor.Error('invalid-room');\n\t\t\t}\n\n\t\t\tif (!room.open) {\n\t\t\t\tthrow new Meteor.Error('room-closed');\n\t\t\t}\n\n\t\t\tconst language = RocketChat.settings.get('language') || 'en';\n\t\t\tconst comment = TAPi18n.__('Closed_by_visitor', { lng: language });\n\n\t\t\tif (!RocketChat.Livechat.closeRoom({ visitor, room, comment })) {\n\t\t\t\treturn RocketChat.API.v1.failure();\n\t\t\t}\n\n\t\t\treturn RocketChat.API.v1.success({ rid, comment });\n\t\t} catch (e) {\n\t\t\treturn RocketChat.API.v1.failure(e);\n\t\t}\n\t},\n});\n\nRocketChat.API.v1.addRoute('livechat/room.transfer', {\n\tpost() {\n\t\ttry {\n\t\t\tcheck(this.bodyParams, {\n\t\t\t\trid: String,\n\t\t\t\ttoken: String,\n\t\t\t\tdepartment: String,\n\t\t\t});\n\n\t\t\tconst { rid } = this.bodyParams;\n\t\t\tconst { token, department } = this.bodyParams;\n\n\t\t\tconst guest = findGuest(token);\n\t\t\tif (!guest) {\n\t\t\t\tthrow new Meteor.Error('invalid-token');\n\t\t\t}\n\n\t\t\tlet room = findRoom(token, rid);\n\t\t\tif (!room) {\n\t\t\t\tthrow new Meteor.Error('invalid-room');\n\t\t\t}\n\n\t\t\t// update visited page history to not expire\n\t\t\tRocketChat.models.Messages.keepHistoryForToken(token);\n\n\t\t\tif (!RocketChat.Livechat.transfer(room, guest, { roomId: rid, departmentId: department })) {\n\t\t\t\treturn RocketChat.API.v1.failure();\n\t\t\t}\n\n\t\t\troom = findRoom(token, rid);\n\t\t\treturn RocketChat.API.v1.success({ room });\n\t\t} catch (e) {\n\t\t\treturn RocketChat.API.v1.failure(e);\n\t\t}\n\t},\n});\n\nRocketChat.API.v1.addRoute('livechat/room.survey', {\n\tpost() {\n\t\ttry {\n\t\t\tcheck(this.bodyParams, {\n\t\t\t\trid: String,\n\t\t\t\ttoken: String,\n\t\t\t\tdata: [Match.ObjectIncluding({\n\t\t\t\t\tname: String,\n\t\t\t\t\tvalue: String,\n\t\t\t\t})],\n\t\t\t});\n\n\t\t\tconst { rid } = this.bodyParams;\n\t\t\tconst { token, data } = this.bodyParams;\n\n\t\t\tconst visitor = findGuest(token);\n\t\t\tif (!visitor) {\n\t\t\t\tthrow new Meteor.Error('invalid-token');\n\t\t\t}\n\n\t\t\tconst room = findRoom(token, rid);\n\t\t\tif (!room) {\n\t\t\t\tthrow new Meteor.Error('invalid-room');\n\t\t\t}\n\n\t\t\tconst config = settings();\n\t\t\tif (!config.survey || !config.survey.items || !config.survey.values) {\n\t\t\t\tthrow new Meteor.Error('invalid-livechat-config');\n\t\t\t}\n\n\t\t\tconst updateData = {};\n\t\t\tfor (const item of data) {\n\t\t\t\tif ((config.survey.items.includes(item.name) && config.survey.values.includes(item.value)) || item.name === 'additionalFeedback') {\n\t\t\t\t\tupdateData[item.name] = item.value;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tif (Object.keys(updateData).length === 0) {\n\t\t\t\tthrow new Meteor.Error('invalid-data');\n\t\t\t}\n\n\t\t\tif (!RocketChat.models.Rooms.updateSurveyFeedbackById(room._id, updateData)) {\n\t\t\t\treturn RocketChat.API.v1.failure();\n\t\t\t}\n\n\t\t\treturn RocketChat.API.v1.success({ rid, data: updateData });\n\t\t} catch (e) {\n\t\t\treturn RocketChat.API.v1.failure(e);\n\t\t}\n\t},\n});\n","RocketChat.API.v1.addRoute('livechat/transcript', {\n\tpost() {\n\t\ttry {\n\t\t\tcheck(this.bodyParams, {\n\t\t\t\ttoken: String,\n\t\t\t\trid: String,\n\t\t\t\temail: String,\n\t\t\t});\n\n\t\t\tconst { token, rid, email } = this.bodyParams;\n\t\t\tif (!RocketChat.Livechat.sendTranscript({ token, rid, email })) {\n\t\t\t\treturn RocketChat.API.v1.failure({ message: TAPi18n.__('Error_sending_livechat_transcript') });\n\t\t\t}\n\n\t\t\treturn RocketChat.API.v1.success({ message: TAPi18n.__('Livechat_transcript_sent') });\n\t\t} catch (e) {\n\t\t\treturn RocketChat.API.v1.failure(e);\n\t\t}\n\t},\n});\n","import { findGuest, getRoom, settings } from '../lib/livechat';\n\nRocketChat.API.v1.addRoute('livechat/video.call/:token', {\n\tget() {\n\t\ttry {\n\t\t\tcheck(this.urlParams, {\n\t\t\t\ttoken: String,\n\t\t\t});\n\n\t\t\tcheck(this.queryParams, {\n\t\t\t\trid: Match.Maybe(String),\n\t\t\t});\n\n\t\t\tconst { token } = this.urlParams;\n\n\t\t\tconst guest = findGuest(token);\n\t\t\tif (!guest) {\n\t\t\t\tthrow new Meteor.Error('invalid-token');\n\t\t\t}\n\n\t\t\tconst rid = this.queryParams.rid || Random.id();\n\t\t\tconst { room } = getRoom(guest, rid, { jitsiTimeout: new Date(Date.now() + 3600 * 1000) });\n\t\t\tconst config = settings();\n\t\t\tif (!config.theme || !config.theme.actionLinks) {\n\t\t\t\tthrow new Meteor.Error('invalid-livechat-config');\n\t\t\t}\n\n\t\t\tRocketChat.models.Messages.createWithTypeRoomIdMessageAndUser('livechat_video_call', room._id, '', guest, {\n\t\t\t\tactionLinks: config.theme.actionLinks,\n\t\t\t});\n\n\t\t\tconst videoCall = {\n\t\t\t\trid,\n\t\t\t\tdomain: RocketChat.settings.get('Jitsi_Domain'),\n\t\t\t\tprovider: 'jitsi',\n\t\t\t\troom: RocketChat.settings.get('Jitsi_URL_Room_Prefix') + RocketChat.settings.get('uniqueID') + rid,\n\t\t\t\ttimeout: new Date(Date.now() + 3600 * 1000),\n\t\t\t};\n\n\t\t\treturn RocketChat.API.v1.success({ videoCall });\n\t\t} catch (e) {\n\t\t\treturn RocketChat.API.v1.failure(e);\n\t\t}\n\t},\n});\n","import LivechatVisitors from '../../../server/models/LivechatVisitors';\n\nRocketChat.API.v1.addRoute('livechat/visitor', {\n\tpost() {\n\t\ttry {\n\t\t\tcheck(this.bodyParams, {\n\t\t\t\tvisitor: Match.ObjectIncluding({\n\t\t\t\t\ttoken: String,\n\t\t\t\t\tname: Match.Maybe(String),\n\t\t\t\t\temail: Match.Maybe(String),\n\t\t\t\t\tdepartment: Match.Maybe(String),\n\t\t\t\t\tphone: Match.Maybe(String),\n\t\t\t\t\tusername: Match.Maybe(String),\n\t\t\t\t\tcustomFields: Match.Maybe([\n\t\t\t\t\t\tMatch.ObjectIncluding({\n\t\t\t\t\t\t\tkey: String,\n\t\t\t\t\t\t\tvalue: String,\n\t\t\t\t\t\t\toverwrite: Boolean,\n\t\t\t\t\t\t}),\n\t\t\t\t\t]),\n\t\t\t\t}),\n\t\t\t});\n\n\t\t\tconst { token, customFields } = this.bodyParams.visitor;\n\t\t\tconst guest = this.bodyParams.visitor;\n\n\t\t\tif (this.bodyParams.visitor.phone) {\n\t\t\t\tguest.phone = { number: this.bodyParams.visitor.phone };\n\t\t\t}\n\n\t\t\tlet visitor = LivechatVisitors.getVisitorByToken(token);\n\t\t\tconst visitorId = RocketChat.Livechat.registerGuest(guest);\n\n\t\t\tif (customFields && customFields instanceof Array) {\n\t\t\t\tcustomFields.forEach((field) => {\n\t\t\t\t\tconst customField = RocketChat.models.LivechatCustomField.findOneById(field.key);\n\t\t\t\t\tif (!customField) {\n\t\t\t\t\t\tthrow new Meteor.Error('invalid-custom-field');\n\t\t\t\t\t}\n\t\t\t\t\tconst { key, value, overwrite } = field;\n\t\t\t\t\tif (customField.scope === 'visitor' && !LivechatVisitors.updateLivechatDataByToken(token, key, value, overwrite)) {\n\t\t\t\t\t\treturn RocketChat.API.v1.failure();\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tvisitor = LivechatVisitors.findOneById(visitorId);\n\t\t\treturn RocketChat.API.v1.success({ visitor });\n\t\t} catch (e) {\n\t\t\treturn RocketChat.API.v1.failure(e);\n\t\t}\n\t},\n});\n\nRocketChat.API.v1.addRoute('livechat/visitor/:token', {\n\tget() {\n\t\ttry {\n\t\t\tcheck(this.urlParams, {\n\t\t\t\ttoken: String,\n\t\t\t});\n\n\t\t\tconst visitor = LivechatVisitors.getVisitorByToken(this.urlParams.token);\n\t\t\treturn RocketChat.API.v1.success({ visitor });\n\t\t} catch (e) {\n\t\t\treturn RocketChat.API.v1.failure(e.error);\n\t\t}\n\t},\n});\n\nRocketChat.API.v1.addRoute('livechat/visitor/:token/room', { authRequired: true }, {\n\tget() {\n\t\tif (!RocketChat.authz.hasPermission(this.userId, 'view-livechat-manager')) {\n\t\t\treturn RocketChat.API.v1.unauthorized();\n\t\t}\n\n\t\tconst rooms = RocketChat.models.Rooms.findOpenByVisitorToken(this.urlParams.token, {\n\t\t\tfields: {\n\t\t\t\tname: 1,\n\t\t\t\tt: 1,\n\t\t\t\tcl: 1,\n\t\t\t\tu: 1,\n\t\t\t\tusernames: 1,\n\t\t\t\tservedBy: 1,\n\t\t\t},\n\t\t}).fetch();\n\t\treturn RocketChat.API.v1.success({ rooms });\n\t},\n});\n","import _ from 'underscore';\n\nMeteor.startup(() => {\n\tconst roles = _.pluck(RocketChat.models.Roles.find().fetch(), 'name');\n\tif (roles.indexOf('livechat-agent') === -1) {\n\t\tRocketChat.models.Roles.createOrUpdate('livechat-agent');\n\t}\n\tif (roles.indexOf('livechat-manager') === -1) {\n\t\tRocketChat.models.Roles.createOrUpdate('livechat-manager');\n\t}\n\tif (roles.indexOf('livechat-guest') === -1) {\n\t\tRocketChat.models.Roles.createOrUpdate('livechat-guest');\n\t}\n\tif (RocketChat.models && RocketChat.models.Permissions) {\n\t\tRocketChat.models.Permissions.createOrUpdate('view-l-room', ['livechat-agent', 'livechat-manager', 'admin']);\n\t\tRocketChat.models.Permissions.createOrUpdate('view-livechat-manager', ['livechat-manager', 'admin']);\n\t\tRocketChat.models.Permissions.createOrUpdate('view-livechat-rooms', ['livechat-manager', 'admin']);\n\t\tRocketChat.models.Permissions.createOrUpdate('close-livechat-room', ['livechat-agent', 'livechat-manager', 'admin']);\n\t\tRocketChat.models.Permissions.createOrUpdate('close-others-livechat-room', ['livechat-manager', 'admin']);\n\t\tRocketChat.models.Permissions.createOrUpdate('save-others-livechat-room-info', ['livechat-manager']);\n\t\tRocketChat.models.Permissions.createOrUpdate('remove-closed-livechat-rooms', ['livechat-manager', 'admin']);\n\t\tRocketChat.models.Permissions.createOrUpdate('view-livechat-analytics', ['livechat-manager', 'admin']);\n\t}\n});\n","RocketChat.MessageTypes.registerType({\n\tid: 'livechat_navigation_history',\n\tsystem: true,\n\tmessage: 'New_visitor_navigation',\n\tdata(message) {\n\t\tif (!message.navigation || !message.navigation.page) {\n\t\t\treturn;\n\t\t}\n\t\treturn {\n\t\t\thistory: `${ (message.navigation.page.title ? `${ message.navigation.page.title } - ` : '') + message.navigation.page.location.href }`,\n\t\t};\n\t},\n});\n\nRocketChat.MessageTypes.registerType({\n\tid: 'livechat_video_call',\n\tsystem: true,\n\tmessage: 'New_videocall_request',\n});\n\nRocketChat.actionLinks.register('createLivechatCall', function(message, params, instance) {\n\tif (Meteor.isClient) {\n\t\tinstance.tabBar.open('video');\n\t}\n});\n\nRocketChat.actionLinks.register('denyLivechatCall', function(message/* , params*/) {\n\tif (Meteor.isServer) {\n\t\tconst user = Meteor.user();\n\n\t\tRocketChat.models.Messages.createWithTypeRoomIdMessageAndUser('command', message.rid, 'endCall', user);\n\t\tRocketChat.Notifications.notifyRoom(message.rid, 'deleteMessage', { _id: message._id });\n\n\t\tconst language = user.language || RocketChat.settings.get('language') || 'en';\n\n\t\tRocketChat.Livechat.closeRoom({\n\t\t\tuser,\n\t\t\troom: RocketChat.models.Rooms.findOneById(message.rid),\n\t\t\tcomment: TAPi18n.__('Videocall_declined', { lng: language }),\n\t\t});\n\t\tMeteor.defer(() => {\n\t\t\tRocketChat.models.Messages.setHiddenById(message._id);\n\t\t});\n\t}\n});\n","Meteor.startup(function() {\n\tRocketChat.settings.addGroup('Livechat');\n\n\tRocketChat.settings.add('Livechat_enabled', false, { type: 'boolean', group: 'Livechat', public: true });\n\n\tRocketChat.settings.add('Livechat_title', 'Rocket.Chat', { type: 'string', group: 'Livechat', public: true });\n\tRocketChat.settings.add('Livechat_title_color', '#C1272D', {\n\t\ttype: 'color',\n\t\teditor: 'color',\n\t\tallowedTypes: ['color', 'expression'],\n\t\tgroup: 'Livechat',\n\t\tpublic: true,\n\t});\n\n\tRocketChat.settings.add('Livechat_display_offline_form', true, {\n\t\ttype: 'boolean',\n\t\tgroup: 'Livechat',\n\t\tpublic: true,\n\t\tsection: 'Offline',\n\t\ti18nLabel: 'Display_offline_form',\n\t});\n\n\tRocketChat.settings.add('Livechat_validate_offline_email', true, {\n\t\ttype: 'boolean',\n\t\tgroup: 'Livechat',\n\t\tpublic: true,\n\t\tsection: 'Offline',\n\t\ti18nLabel: 'Validate_email_address',\n\t});\n\n\tRocketChat.settings.add('Livechat_offline_form_unavailable', '', {\n\t\ttype: 'string',\n\t\tgroup: 'Livechat',\n\t\tpublic: true,\n\t\tsection: 'Offline',\n\t\ti18nLabel: 'Offline_form_unavailable_message',\n\t});\n\n\tRocketChat.settings.add('Livechat_offline_title', 'Leave a message', {\n\t\ttype: 'string',\n\t\tgroup: 'Livechat',\n\t\tpublic: true,\n\t\tsection: 'Offline',\n\t\ti18nLabel: 'Title',\n\t});\n\tRocketChat.settings.add('Livechat_offline_title_color', '#666666', {\n\t\ttype: 'color',\n\t\teditor: 'color',\n\t\tallowedTypes: ['color', 'expression'],\n\t\tgroup: 'Livechat',\n\t\tpublic: true,\n\t\tsection: 'Offline',\n\t\ti18nLabel: 'Color',\n\t});\n\tRocketChat.settings.add('Livechat_offline_message', '', {\n\t\ttype: 'string',\n\t\tgroup: 'Livechat',\n\t\tpublic: true,\n\t\tsection: 'Offline',\n\t\ti18nLabel: 'Instructions',\n\t\ti18nDescription: 'Instructions_to_your_visitor_fill_the_form_to_send_a_message',\n\t});\n\tRocketChat.settings.add('Livechat_offline_email', '', {\n\t\ttype: 'string',\n\t\tgroup: 'Livechat',\n\t\ti18nLabel: 'Email_address_to_send_offline_messages',\n\t\tsection: 'Offline',\n\t});\n\tRocketChat.settings.add('Livechat_offline_success_message', '', {\n\t\ttype: 'string',\n\t\tgroup: 'Livechat',\n\t\tpublic: true,\n\t\tsection: 'Offline',\n\t\ti18nLabel: 'Offline_success_message',\n\t});\n\n\tRocketChat.settings.add('Livechat_allow_switching_departments', true, { type: 'boolean', group: 'Livechat', public: true, i18nLabel: 'Allow_switching_departments' });\n\tRocketChat.settings.add('Livechat_show_agent_email', true, { type: 'boolean', group: 'Livechat', public: true, i18nLabel: 'Show_agent_email' });\n\n\tRocketChat.settings.add('Livechat_conversation_finished_message', '', {\n\t\ttype: 'string',\n\t\tgroup: 'Livechat',\n\t\tpublic: true,\n\t\ti18nLabel: 'Conversation_finished_message',\n\t});\n\n\tRocketChat.settings.add('Livechat_registration_form', true, {\n\t\ttype: 'boolean',\n\t\tgroup: 'Livechat',\n\t\tpublic: true,\n\t\ti18nLabel: 'Show_preregistration_form',\n\t});\n\n\tRocketChat.settings.add('Livechat_name_field_registration_form', true, {\n\t\ttype: 'boolean',\n\t\tgroup: 'Livechat',\n\t\tpublic: true,\n\t\ti18nLabel: 'Show_name_field',\n\t});\n\n\tRocketChat.settings.add('Livechat_email_field_registration_form', true, {\n\t\ttype: 'boolean',\n\t\tgroup: 'Livechat',\n\t\tpublic: true,\n\t\ti18nLabel: 'Show_email_field',\n\t});\n\n\tRocketChat.settings.add('Livechat_guest_count', 1, { type: 'int', group: 'Livechat' });\n\n\tRocketChat.settings.add('Livechat_Room_Count', 1, {\n\t\ttype: 'int',\n\t\tgroup: 'Livechat',\n\t\ti18nLabel: 'Livechat_room_count',\n\t});\n\n\tRocketChat.settings.add('Livechat_agent_leave_action', 'none', {\n\t\ttype: 'select',\n\t\tgroup: 'Livechat',\n\t\tvalues: [\n\t\t\t{ key: 'none', i18nLabel: 'None' },\n\t\t\t{ key: 'forward', i18nLabel: 'Forward' },\n\t\t\t{ key: 'close', i18nLabel: 'Close' },\n\t\t],\n\t\ti18nLabel: 'How_to_handle_open_sessions_when_agent_goes_offline',\n\t});\n\n\tRocketChat.settings.add('Livechat_agent_leave_action_timeout', 60, {\n\t\ttype: 'int',\n\t\tgroup: 'Livechat',\n\t\tenableQuery: { _id: 'Livechat_agent_leave_action', value: { $ne: 'none' } },\n\t\ti18nLabel: 'How_long_to_wait_after_agent_goes_offline',\n\t\ti18nDescription: 'Time_in_seconds',\n\t});\n\n\tRocketChat.settings.add('Livechat_agent_leave_comment', '', {\n\t\ttype: 'string',\n\t\tgroup: 'Livechat',\n\t\tenableQuery: { _id: 'Livechat_agent_leave_action', value: 'close' },\n\t\ti18nLabel: 'Comment_to_leave_on_closing_session',\n\t});\n\n\tRocketChat.settings.add('Livechat_webhookUrl', false, {\n\t\ttype: 'string',\n\t\tgroup: 'Livechat',\n\t\tsection: 'CRM_Integration',\n\t\ti18nLabel: 'Webhook_URL',\n\t});\n\n\tRocketChat.settings.add('Livechat_secret_token', false, {\n\t\ttype: 'string',\n\t\tgroup: 'Livechat',\n\t\tsection: 'CRM_Integration',\n\t\ti18nLabel: 'Secret_token',\n\t});\n\n\tRocketChat.settings.add('Livechat_webhook_on_close', false, {\n\t\ttype: 'boolean',\n\t\tgroup: 'Livechat',\n\t\tsection: 'CRM_Integration',\n\t\ti18nLabel: 'Send_request_on_chat_close',\n\t});\n\n\tRocketChat.settings.add('Livechat_webhook_on_offline_msg', false, {\n\t\ttype: 'boolean',\n\t\tgroup: 'Livechat',\n\t\tsection: 'CRM_Integration',\n\t\ti18nLabel: 'Send_request_on_offline_messages',\n\t});\n\n\tRocketChat.settings.add('Livechat_webhook_on_visitor_message', false, {\n\t\ttype: 'boolean',\n\t\tgroup: 'Livechat',\n\t\tsection: 'CRM_Integration',\n\t\ti18nLabel: 'Send_request_on_visitor_message',\n\t});\n\n\tRocketChat.settings.add('Livechat_webhook_on_agent_message', false, {\n\t\ttype: 'boolean',\n\t\tgroup: 'Livechat',\n\t\tsection: 'CRM_Integration',\n\t\ti18nLabel: 'Send_request_on_agent_message',\n\t});\n\n\tRocketChat.settings.add('Send_visitor_navigation_history_livechat_webhook_request', false, {\n\t\ttype: 'boolean',\n\t\tgroup: 'Livechat',\n\t\tsection: 'CRM_Integration',\n\t\ti18nLabel: 'Send_visitor_navigation_history_on_request',\n\t\ti18nDescription: 'Feature_Depends_on_Livechat_Visitor_navigation_as_a_message_to_be_enabled',\n\t\tenableQuery: { _id: 'Livechat_Visitor_navigation_as_a_message', value: true },\n\t});\n\n\tRocketChat.settings.add('Livechat_webhook_on_capture', false, {\n\t\ttype: 'boolean',\n\t\tgroup: 'Livechat',\n\t\tsection: 'CRM_Integration',\n\t\ti18nLabel: 'Send_request_on_lead_capture',\n\t});\n\n\tRocketChat.settings.add('Livechat_lead_email_regex', '\\\\b[A-Z0-9._%+-]+@(?:[A-Z0-9-]+\\\\.)+[A-Z]{2,4}\\\\b', {\n\t\ttype: 'string',\n\t\tgroup: 'Livechat',\n\t\tsection: 'CRM_Integration',\n\t\ti18nLabel: 'Lead_capture_email_regex',\n\t});\n\n\tRocketChat.settings.add('Livechat_lead_phone_regex', '((?:\\\\([0-9]{1,3}\\\\)|[0-9]{2})[ \\\\-]*?[0-9]{4,5}(?:[\\\\-\\\\s\\\\_]{1,2})?[0-9]{4}(?:(?=[^0-9])|$)|[0-9]{4,5}(?:[\\\\-\\\\s\\\\_]{1,2})?[0-9]{4}(?:(?=[^0-9])|$))', {\n\t\ttype: 'string',\n\t\tgroup: 'Livechat',\n\t\tsection: 'CRM_Integration',\n\t\ti18nLabel: 'Lead_capture_phone_regex',\n\t});\n\n\tRocketChat.settings.add('Livechat_Knowledge_Enabled', false, {\n\t\ttype: 'boolean',\n\t\tgroup: 'Livechat',\n\t\tsection: 'Knowledge_Base',\n\t\tpublic: true,\n\t\ti18nLabel: 'Enabled',\n\t});\n\n\tRocketChat.settings.add('Livechat_Knowledge_Apiai_Key', '', {\n\t\ttype: 'string',\n\t\tgroup: 'Livechat',\n\t\tsection: 'Knowledge_Base',\n\t\tpublic: true,\n\t\ti18nLabel: 'Apiai_Key',\n\t});\n\n\tRocketChat.settings.add('Livechat_Knowledge_Apiai_Language', 'en', {\n\t\ttype: 'string',\n\t\tgroup: 'Livechat',\n\t\tsection: 'Knowledge_Base',\n\t\tpublic: true,\n\t\ti18nLabel: 'Apiai_Language',\n\t});\n\n\tRocketChat.settings.add('Livechat_history_monitor_type', 'url', {\n\t\ttype: 'select',\n\t\tgroup: 'Livechat',\n\t\ti18nLabel: 'Monitor_history_for_changes_on',\n\t\tvalues: [\n\t\t\t{ key: 'url', i18nLabel: 'Page_URL' },\n\t\t\t{ key: 'title', i18nLabel: 'Page_title' },\n\t\t],\n\t});\n\n\tRocketChat.settings.add('Livechat_Visitor_navigation_as_a_message', false, {\n\t\ttype: 'boolean',\n\t\tgroup: 'Livechat',\n\t\tpublic: true,\n\t\ti18nLabel: 'Send_Visitor_navigation_history_as_a_message',\n\t});\n\n\tRocketChat.settings.add('Livechat_enable_office_hours', false, {\n\t\ttype: 'boolean',\n\t\tgroup: 'Livechat',\n\t\tpublic: true,\n\t\ti18nLabel: 'Office_hours_enabled',\n\t});\n\n\tRocketChat.settings.add('Livechat_continuous_sound_notification_new_livechat_room', false, {\n\t\ttype: 'boolean',\n\t\tgroup: 'Livechat',\n\t\tpublic: true,\n\t\ti18nLabel: 'Continuous_sound_notifications_for_new_livechat_room',\n\t});\n\n\tRocketChat.settings.add('Livechat_videocall_enabled', false, {\n\t\ttype: 'boolean',\n\t\tgroup: 'Livechat',\n\t\tpublic: true,\n\t\ti18nLabel: 'Videocall_enabled',\n\t\ti18nDescription: 'Beta_feature_Depends_on_Video_Conference_to_be_enabled',\n\t\tenableQuery: { _id: 'Jitsi_Enabled', value: true },\n\t});\n\n\tRocketChat.settings.add('Livechat_fileupload_enabled', true, {\n\t\ttype: 'boolean',\n\t\tgroup: 'Livechat',\n\t\tpublic: true,\n\t\ti18nLabel: 'FileUpload_Enabled',\n\t\tenableQuery: { _id: 'FileUpload_Enabled', value: true },\n\t});\n\n\tRocketChat.settings.add('Livechat_enable_transcript', false, {\n\t\ttype: 'boolean',\n\t\tgroup: 'Livechat',\n\t\tpublic: true,\n\t\ti18nLabel: 'Transcript_Enabled',\n\t});\n\n\tRocketChat.settings.add('Livechat_transcript_message', '', {\n\t\ttype: 'string',\n\t\tgroup: 'Livechat',\n\t\tpublic: true,\n\t\ti18nLabel: 'Transcript_message',\n\t\tenableQuery: { _id: 'Livechat_enable_transcript', value: true },\n\t});\n\n\tRocketChat.settings.add('Livechat_open_inquiery_show_connecting', false, {\n\t\ttype: 'boolean',\n\t\tgroup: 'Livechat',\n\t\tpublic: true,\n\t\ti18nLabel: 'Livechat_open_inquiery_show_connecting',\n\t\tenableQuery: { _id: 'Livechat_Routing_Method', value: 'Guest_Pool' },\n\t});\n\n\tRocketChat.settings.add('Livechat_AllowedDomainsList', '', {\n\t\ttype: 'string',\n\t\tgroup: 'Livechat',\n\t\tpublic: true,\n\t\ti18nLabel: 'Livechat_AllowedDomainsList',\n\t\ti18nDescription: 'Domains_allowed_to_embed_the_livechat_widget',\n\t});\n\n\tRocketChat.settings.add('Livechat_Facebook_Enabled', false, {\n\t\ttype: 'boolean',\n\t\tgroup: 'Livechat',\n\t\tsection: 'Facebook',\n\t});\n\n\tRocketChat.settings.add('Livechat_Facebook_API_Key', '', {\n\t\ttype: 'string',\n\t\tgroup: 'Livechat',\n\t\tsection: 'Facebook',\n\t\ti18nDescription: 'If_you_dont_have_one_send_an_email_to_omni_rocketchat_to_get_yours',\n\t});\n\n\tRocketChat.settings.add('Livechat_Facebook_API_Secret', '', {\n\t\ttype: 'string',\n\t\tgroup: 'Livechat',\n\t\tsection: 'Facebook',\n\t\ti18nDescription: 'If_you_dont_have_one_send_an_email_to_omni_rocketchat_to_get_yours',\n\t});\n\n\tRocketChat.settings.add('Livechat_RDStation_Token', '', {\n\t\ttype: 'string',\n\t\tgroup: 'Livechat',\n\t\tpublic: false,\n\t\tsection: 'RD Station',\n\t\ti18nLabel: 'RDStation_Token',\n\t});\n\n\tRocketChat.settings.add('Livechat_Routing_Method', 'Least_Amount', {\n\t\ttype: 'select',\n\t\tgroup: 'Livechat',\n\t\tpublic: true,\n\t\tsection: 'Routing',\n\t\tvalues: [\n\t\t\t{ key: 'External', i18nLabel: 'External_Service' },\n\t\t\t{ key: 'Least_Amount', i18nLabel: 'Least_Amount' },\n\t\t\t{ key: 'Guest_Pool', i18nLabel: 'Guest_Pool' },\n\t\t],\n\t});\n\n\tRocketChat.settings.add('Livechat_guest_pool_with_no_agents', false, {\n\t\ttype: 'boolean',\n\t\tgroup: 'Livechat',\n\t\tsection: 'Routing',\n\t\ti18nLabel: 'Accept_with_no_online_agents',\n\t\ti18nDescription: 'Accept_incoming_livechat_requests_even_if_there_are_no_online_agents',\n\t\tenableQuery: { _id: 'Livechat_Routing_Method', value: 'Guest_Pool' },\n\t});\n\n\tRocketChat.settings.add('Livechat_show_queue_list_link', false, {\n\t\ttype: 'boolean',\n\t\tgroup: 'Livechat',\n\t\tpublic: true,\n\t\tsection: 'Routing',\n\t\ti18nLabel: 'Show_queue_list_to_all_agents',\n\t\tenableQuery: { _id: 'Livechat_Routing_Method', value: { $ne: 'External' } },\n\t});\n\n\tRocketChat.settings.add('Livechat_External_Queue_URL', '', {\n\t\ttype: 'string',\n\t\tgroup: 'Livechat',\n\t\tpublic: false,\n\t\tsection: 'Routing',\n\t\ti18nLabel: 'External_Queue_Service_URL',\n\t\ti18nDescription: 'For_more_details_please_check_our_docs',\n\t\tenableQuery: { _id: 'Livechat_Routing_Method', value: 'External' },\n\t});\n\n\tRocketChat.settings.add('Livechat_External_Queue_Token', '', {\n\t\ttype: 'string',\n\t\tgroup: 'Livechat',\n\t\tpublic: false,\n\t\tsection: 'Routing',\n\t\ti18nLabel: 'Secret_token',\n\t\tenableQuery: { _id: 'Livechat_Routing_Method', value: 'External' },\n\t});\n});\n","/* globals openRoom, LivechatInquiry */\nimport { RoomSettingsEnum, RoomTypeConfig, RoomTypeRouteConfig, UiTextContext } from 'meteor/rocketchat:lib';\n\nclass LivechatRoomRoute extends RoomTypeRouteConfig {\n\tconstructor() {\n\t\tsuper({\n\t\t\tname: 'live',\n\t\t\tpath: '/live/:id',\n\t\t});\n\t}\n\n\taction(params) {\n\t\topenRoom('l', params.id);\n\t}\n\n\tlink(sub) {\n\t\treturn {\n\t\t\tid: sub.rid,\n\t\t};\n\t}\n}\n\nexport default class LivechatRoomType extends RoomTypeConfig {\n\tconstructor() {\n\t\tsuper({\n\t\t\tidentifier: 'l',\n\t\t\torder: 5,\n\t\t\ticon: 'livechat',\n\t\t\tlabel: 'Livechat',\n\t\t\troute: new LivechatRoomRoute(),\n\t\t});\n\n\t\tthis.notSubscribedTpl = {\n\t\t\ttemplate: 'livechatNotSubscribed',\n\t\t};\n\t}\n\n\tfindRoom(identifier) {\n\t\treturn ChatRoom.findOne({ _id: identifier });\n\t}\n\n\troomName(roomData) {\n\t\treturn roomData.name || roomData.fname || roomData.label;\n\t}\n\n\tcondition() {\n\t\treturn RocketChat.settings.get('Livechat_enabled') && RocketChat.authz.hasAllPermission('view-l-room');\n\t}\n\n\tcanSendMessage(roomId) {\n\t\tconst room = ChatRoom.findOne({ _id: roomId }, { fields: { open: 1 } });\n\t\treturn room && room.open === true;\n\t}\n\n\tgetUserStatus(roomId) {\n\t\tconst room = Session.get(`roomData${ roomId }`);\n\t\tif (room) {\n\t\t\treturn room.v && room.v.status;\n\t\t}\n\n\t\tconst inquiry = LivechatInquiry.findOne({ rid: roomId });\n\t\treturn inquiry && inquiry.v && inquiry.v.status;\n\t}\n\n\tallowRoomSettingChange(room, setting) {\n\t\tswitch (setting) {\n\t\t\tcase RoomSettingsEnum.JOIN_CODE:\n\t\t\t\treturn false;\n\t\t\tdefault:\n\t\t\t\treturn true;\n\t\t}\n\t}\n\n\tgetUiText(context) {\n\t\tswitch (context) {\n\t\t\tcase UiTextContext.HIDE_WARNING:\n\t\t\t\treturn 'Hide_Livechat_Warning';\n\t\t\tcase UiTextContext.LEAVE_WARNING:\n\t\t\t\treturn 'Hide_Livechat_Warning';\n\t\t\tdefault:\n\t\t\t\treturn '';\n\t\t}\n\t}\n}\n","RocketChat.API.v1.addRoute('livechat/department', { authRequired: true }, {\n\tget() {\n\t\tif (!RocketChat.authz.hasPermission(this.userId, 'view-livechat-manager')) {\n\t\t\treturn RocketChat.API.v1.unauthorized();\n\t\t}\n\n\t\treturn RocketChat.API.v1.success({\n\t\t\tdepartments: RocketChat.models.LivechatDepartment.find().fetch(),\n\t\t});\n\t},\n\tpost() {\n\t\tif (!RocketChat.authz.hasPermission(this.userId, 'view-livechat-manager')) {\n\t\t\treturn RocketChat.API.v1.unauthorized();\n\t\t}\n\n\t\ttry {\n\t\t\tcheck(this.bodyParams, {\n\t\t\t\tdepartment: Object,\n\t\t\t\tagents: Array,\n\t\t\t});\n\n\t\t\tconst department = RocketChat.Livechat.saveDepartment(null, this.bodyParams.department, this.bodyParams.agents);\n\n\t\t\tif (department) {\n\t\t\t\treturn RocketChat.API.v1.success({\n\t\t\t\t\tdepartment,\n\t\t\t\t\tagents: RocketChat.models.LivechatDepartmentAgents.find({ departmentId: department._id }).fetch(),\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tRocketChat.API.v1.failure();\n\t\t} catch (e) {\n\t\t\treturn RocketChat.API.v1.failure(e);\n\t\t}\n\t},\n});\n\nRocketChat.API.v1.addRoute('livechat/department/:_id', { authRequired: true }, {\n\tget() {\n\t\tif (!RocketChat.authz.hasPermission(this.userId, 'view-livechat-manager')) {\n\t\t\treturn RocketChat.API.v1.unauthorized();\n\t\t}\n\n\t\ttry {\n\t\t\tcheck(this.urlParams, {\n\t\t\t\t_id: String,\n\t\t\t});\n\n\t\t\treturn RocketChat.API.v1.success({\n\t\t\t\tdepartment: RocketChat.models.LivechatDepartment.findOneById(this.urlParams._id),\n\t\t\t\tagents: RocketChat.models.LivechatDepartmentAgents.find({ departmentId: this.urlParams._id }).fetch(),\n\t\t\t});\n\t\t} catch (e) {\n\t\t\treturn RocketChat.API.v1.failure(e.error);\n\t\t}\n\t},\n\tput() {\n\t\tif (!RocketChat.authz.hasPermission(this.userId, 'view-livechat-manager')) {\n\t\t\treturn RocketChat.API.v1.unauthorized();\n\t\t}\n\n\t\ttry {\n\t\t\tcheck(this.urlParams, {\n\t\t\t\t_id: String,\n\t\t\t});\n\n\t\t\tcheck(this.bodyParams, {\n\t\t\t\tdepartment: Object,\n\t\t\t\tagents: Array,\n\t\t\t});\n\n\t\t\tif (RocketChat.Livechat.saveDepartment(this.urlParams._id, this.bodyParams.department, this.bodyParams.agents)) {\n\t\t\t\treturn RocketChat.API.v1.success({\n\t\t\t\t\tdepartment: RocketChat.models.LivechatDepartment.findOneById(this.urlParams._id),\n\t\t\t\t\tagents: RocketChat.models.LivechatDepartmentAgents.find({ departmentId: this.urlParams._id }).fetch(),\n\t\t\t\t});\n\t\t\t}\n\n\t\t\treturn RocketChat.API.v1.failure();\n\t\t} catch (e) {\n\t\t\treturn RocketChat.API.v1.failure(e.error);\n\t\t}\n\t},\n\tdelete() {\n\t\tif (!RocketChat.authz.hasPermission(this.userId, 'view-livechat-manager')) {\n\t\t\treturn RocketChat.API.v1.unauthorized();\n\t\t}\n\n\t\ttry {\n\t\t\tcheck(this.urlParams, {\n\t\t\t\t_id: String,\n\t\t\t});\n\n\t\t\tif (RocketChat.Livechat.removeDepartment(this.urlParams._id)) {\n\t\t\t\treturn RocketChat.API.v1.success();\n\t\t\t}\n\n\t\t\treturn RocketChat.API.v1.failure();\n\t\t} catch (e) {\n\t\t\treturn RocketChat.API.v1.failure(e.error);\n\t\t}\n\t},\n});\n","import crypto from 'crypto';\n\nimport LivechatVisitors from '../../../server/models/LivechatVisitors';\n\n/**\n * @api {post} /livechat/facebook Send Facebook message\n * @apiName Facebook\n * @apiGroup Livechat\n *\n * @apiParam {String} mid Facebook message id\n * @apiParam {String} page Facebook pages id\n * @apiParam {String} token Facebook user's token\n * @apiParam {String} first_name Facebook user's first name\n * @apiParam {String} last_name Facebook user's last name\n * @apiParam {String} [text] Facebook message text\n * @apiParam {String} [attachments] Facebook message attachments\n */\nRocketChat.API.v1.addRoute('livechat/facebook', {\n\tpost() {\n\t\tif (!this.bodyParams.text && !this.bodyParams.attachments) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t};\n\t\t}\n\n\t\tif (!this.request.headers['x-hub-signature']) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t};\n\t\t}\n\n\t\tif (!RocketChat.settings.get('Livechat_Facebook_Enabled')) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror: 'Integration disabled',\n\t\t\t};\n\t\t}\n\n\t\t// validate if request come from omni\n\t\tconst signature = crypto.createHmac('sha1', RocketChat.settings.get('Livechat_Facebook_API_Secret')).update(JSON.stringify(this.request.body)).digest('hex');\n\t\tif (this.request.headers['x-hub-signature'] !== `sha1=${ signature }`) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror: 'Invalid signature',\n\t\t\t};\n\t\t}\n\n\t\tconst sendMessage = {\n\t\t\tmessage: {\n\t\t\t\t_id: this.bodyParams.mid,\n\t\t\t},\n\t\t\troomInfo: {\n\t\t\t\tfacebook: {\n\t\t\t\t\tpage: this.bodyParams.page,\n\t\t\t\t},\n\t\t\t},\n\t\t};\n\t\tlet visitor = LivechatVisitors.getVisitorByToken(this.bodyParams.token);\n\t\tif (visitor) {\n\t\t\tconst rooms = RocketChat.models.Rooms.findOpenByVisitorToken(visitor.token).fetch();\n\t\t\tif (rooms && rooms.length > 0) {\n\t\t\t\tsendMessage.message.rid = rooms[0]._id;\n\t\t\t} else {\n\t\t\t\tsendMessage.message.rid = Random.id();\n\t\t\t}\n\t\t\tsendMessage.message.token = visitor.token;\n\t\t} else {\n\t\t\tsendMessage.message.rid = Random.id();\n\t\t\tsendMessage.message.token = this.bodyParams.token;\n\n\t\t\tconst userId = RocketChat.Livechat.registerGuest({\n\t\t\t\ttoken: sendMessage.message.token,\n\t\t\t\tname: `${ this.bodyParams.first_name } ${ this.bodyParams.last_name }`,\n\t\t\t});\n\n\t\t\tvisitor = RocketChat.models.Users.findOneById(userId);\n\t\t}\n\n\t\tsendMessage.message.msg = this.bodyParams.text;\n\t\tsendMessage.guest = visitor;\n\n\t\ttry {\n\t\t\treturn {\n\t\t\t\tsucess: true,\n\t\t\t\tmessage: RocketChat.Livechat.sendMessage(sendMessage),\n\t\t\t};\n\t\t} catch (e) {\n\t\t\tconsole.error('Error using Facebook ->', e);\n\t\t}\n\t},\n});\n","import LivechatVisitors from '../../../server/models/LivechatVisitors';\n\nRocketChat.API.v1.addRoute('livechat/sms-incoming/:service', {\n\tpost() {\n\t\tconst SMSService = RocketChat.SMS.getService(this.urlParams.service);\n\n\t\tconst sms = SMSService.parse(this.bodyParams);\n\n\t\tlet visitor = LivechatVisitors.findOneVisitorByPhone(sms.from);\n\n\t\tconst sendMessage = {\n\t\t\tmessage: {\n\t\t\t\t_id: Random.id(),\n\t\t\t},\n\t\t\troomInfo: {\n\t\t\t\tsms: {\n\t\t\t\t\tfrom: sms.to,\n\t\t\t\t},\n\t\t\t},\n\t\t};\n\n\t\tif (visitor) {\n\t\t\tconst rooms = RocketChat.models.Rooms.findOpenByVisitorToken(visitor.token).fetch();\n\n\t\t\tif (rooms && rooms.length > 0) {\n\t\t\t\tsendMessage.message.rid = rooms[0]._id;\n\t\t\t} else {\n\t\t\t\tsendMessage.message.rid = Random.id();\n\t\t\t}\n\t\t\tsendMessage.message.token = visitor.token;\n\t\t} else {\n\t\t\tsendMessage.message.rid = Random.id();\n\t\t\tsendMessage.message.token = Random.id();\n\n\t\t\tconst visitorId = RocketChat.Livechat.registerGuest({\n\t\t\t\tusername: sms.from.replace(/[^0-9]/g, ''),\n\t\t\t\ttoken: sendMessage.message.token,\n\t\t\t\tphone: {\n\t\t\t\t\tnumber: sms.from,\n\t\t\t\t},\n\t\t\t});\n\n\t\t\tvisitor = LivechatVisitors.findOneById(visitorId);\n\t\t}\n\n\t\tsendMessage.message.msg = sms.body;\n\t\tsendMessage.guest = visitor;\n\n\t\tsendMessage.message.attachments = sms.media.map((curr) => {\n\t\t\tconst attachment = {\n\t\t\t\tmessage_link: curr.url,\n\t\t\t};\n\n\t\t\tconst { contentType } = curr;\n\t\t\tswitch (contentType.substr(0, contentType.indexOf('/'))) {\n\t\t\t\tcase 'image':\n\t\t\t\t\tattachment.image_url = curr.url;\n\t\t\t\t\tbreak;\n\t\t\t\tcase 'video':\n\t\t\t\t\tattachment.video_url = curr.url;\n\t\t\t\t\tbreak;\n\t\t\t\tcase 'audio':\n\t\t\t\t\tattachment.audio_url = curr.url;\n\t\t\t\t\tbreak;\n\t\t\t}\n\n\t\t\treturn attachment;\n\t\t});\n\n\t\ttry {\n\t\t\tconst message = SMSService.response.call(this, RocketChat.Livechat.sendMessage(sendMessage));\n\n\t\t\tMeteor.defer(() => {\n\t\t\t\tif (sms.extra) {\n\t\t\t\t\tif (sms.extra.fromCountry) {\n\t\t\t\t\t\tMeteor.call('livechat:setCustomField', sendMessage.message.token, 'country', sms.extra.fromCountry);\n\t\t\t\t\t}\n\t\t\t\t\tif (sms.extra.fromState) {\n\t\t\t\t\t\tMeteor.call('livechat:setCustomField', sendMessage.message.token, 'state', sms.extra.fromState);\n\t\t\t\t\t}\n\t\t\t\t\tif (sms.extra.fromCity) {\n\t\t\t\t\t\tMeteor.call('livechat:setCustomField', sendMessage.message.token, 'city', sms.extra.fromCity);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t});\n\n\t\t\treturn message;\n\t\t} catch (e) {\n\t\t\treturn SMSService.error.call(this, e);\n\t\t}\n\t},\n});\n","import Busboy from 'busboy';\nimport filesize from 'filesize';\nimport LivechatVisitors from '../../../server/models/LivechatVisitors';\nlet maxFileSize;\nRocketChat.settings.get('FileUpload_MaxFileSize', function(key, value) {\n\ttry {\n\t\tmaxFileSize = parseInt(value);\n\t} catch (e) {\n\t\tmaxFileSize = RocketChat.models.Settings.findOneById('FileUpload_MaxFileSize').packageValue;\n\t}\n});\n\nRocketChat.API.v1.addRoute('livechat/upload/:rid', {\n\tpost() {\n\t\tif (!this.request.headers['x-visitor-token']) {\n\t\t\treturn RocketChat.API.v1.unauthorized();\n\t\t}\n\n\t\tconst visitorToken = this.request.headers['x-visitor-token'];\n\t\tconst visitor = LivechatVisitors.getVisitorByToken(visitorToken);\n\n\t\tif (!visitor) {\n\t\t\treturn RocketChat.API.v1.unauthorized();\n\t\t}\n\n\t\tconst room = RocketChat.models.Rooms.findOneOpenByRoomIdAndVisitorToken(this.urlParams.rid, visitorToken);\n\t\tif (!room) {\n\t\t\treturn RocketChat.API.v1.unauthorized();\n\t\t}\n\n\t\tconst busboy = new Busboy({ headers: this.request.headers });\n\t\tconst files = [];\n\t\tconst fields = {};\n\n\t\tMeteor.wrapAsync((callback) => {\n\t\t\tbusboy.on('file', (fieldname, file, filename, encoding, mimetype) => {\n\t\t\t\tif (fieldname !== 'file') {\n\t\t\t\t\treturn files.push(new Meteor.Error('invalid-field'));\n\t\t\t\t}\n\n\t\t\t\tconst fileDate = [];\n\t\t\t\tfile.on('data', (data) => fileDate.push(data));\n\n\t\t\t\tfile.on('end', () => {\n\t\t\t\t\tfiles.push({ fieldname, file, filename, encoding, mimetype, fileBuffer: Buffer.concat(fileDate) });\n\t\t\t\t});\n\t\t\t});\n\n\t\t\tbusboy.on('field', (fieldname, value) => fields[fieldname] = value);\n\n\t\t\tbusboy.on('finish', Meteor.bindEnvironment(() => callback()));\n\n\t\t\tthis.request.pipe(busboy);\n\t\t})();\n\n\t\tif (files.length === 0) {\n\t\t\treturn RocketChat.API.v1.failure('File required');\n\t\t}\n\n\t\tif (files.length > 1) {\n\t\t\treturn RocketChat.API.v1.failure('Just 1 file is allowed');\n\t\t}\n\n\t\tconst file = files[0];\n\n\t\tif (!RocketChat.fileUploadIsValidContentType(file.mimetype)) {\n\t\t\treturn RocketChat.API.v1.failure({\n\t\t\t\treason: 'error-type-not-allowed',\n\t\t\t});\n\t\t}\n\n\t\t// -1 maxFileSize means there is no limit\n\t\tif (maxFileSize > -1 && file.fileBuffer.length > maxFileSize) {\n\t\t\treturn RocketChat.API.v1.failure({\n\t\t\t\treason: 'error-size-not-allowed',\n\t\t\t\tsizeAllowed: filesize(maxFileSize),\n\t\t\t});\n\t\t}\n\n\t\tconst fileStore = FileUpload.getStore('Uploads');\n\n\t\tconst details = {\n\t\t\tname: file.filename,\n\t\t\tsize: file.fileBuffer.length,\n\t\t\ttype: file.mimetype,\n\t\t\trid: this.urlParams.rid,\n\t\t\tvisitorToken,\n\t\t};\n\n\t\tconst uploadedFile = Meteor.wrapAsync(fileStore.insert.bind(fileStore))(details, file.fileBuffer);\n\n\t\tuploadedFile.description = fields.description;\n\n\t\tdelete fields.description;\n\t\tRocketChat.API.v1.success(Meteor.call('sendFileLivechatMessage', this.urlParams.rid, visitorToken, uploadedFile, fields));\n\t},\n});\n","import _ from 'underscore';\n\nRocketChat.API.v1.addRoute('livechat/users/:type', { authRequired: true }, {\n\tget() {\n\t\tif (!RocketChat.authz.hasPermission(this.userId, 'view-livechat-manager')) {\n\t\t\treturn RocketChat.API.v1.unauthorized();\n\t\t}\n\n\t\ttry {\n\t\t\tcheck(this.urlParams, {\n\t\t\t\ttype: String,\n\t\t\t});\n\n\t\t\tlet role;\n\t\t\tif (this.urlParams.type === 'agent') {\n\t\t\t\trole = 'livechat-agent';\n\t\t\t} else if (this.urlParams.type === 'manager') {\n\t\t\t\trole = 'livechat-manager';\n\t\t\t} else {\n\t\t\t\tthrow 'Invalid type';\n\t\t\t}\n\n\t\t\tconst users = RocketChat.authz.getUsersInRole(role);\n\n\t\t\treturn RocketChat.API.v1.success({\n\t\t\t\tusers: users.fetch().map((user) => _.pick(user, '_id', 'username', 'name', 'status', 'statusLivechat')),\n\t\t\t});\n\t\t} catch (e) {\n\t\t\treturn RocketChat.API.v1.failure(e.error);\n\t\t}\n\t},\n\tpost() {\n\t\tif (!RocketChat.authz.hasPermission(this.userId, 'view-livechat-manager')) {\n\t\t\treturn RocketChat.API.v1.unauthorized();\n\t\t}\n\t\ttry {\n\t\t\tcheck(this.urlParams, {\n\t\t\t\ttype: String,\n\t\t\t});\n\n\t\t\tcheck(this.bodyParams, {\n\t\t\t\tusername: String,\n\t\t\t});\n\n\t\t\tif (this.urlParams.type === 'agent') {\n\t\t\t\tconst user = RocketChat.Livechat.addAgent(this.bodyParams.username);\n\t\t\t\tif (user) {\n\t\t\t\t\treturn RocketChat.API.v1.success({ user });\n\t\t\t\t}\n\t\t\t} else if (this.urlParams.type === 'manager') {\n\t\t\t\tconst user = RocketChat.Livechat.addManager(this.bodyParams.username);\n\t\t\t\tif (user) {\n\t\t\t\t\treturn RocketChat.API.v1.success({ user });\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tthrow 'Invalid type';\n\t\t\t}\n\n\t\t\treturn RocketChat.API.v1.failure();\n\t\t} catch (e) {\n\t\t\treturn RocketChat.API.v1.failure(e.error);\n\t\t}\n\t},\n});\n\nRocketChat.API.v1.addRoute('livechat/users/:type/:_id', { authRequired: true }, {\n\tget() {\n\t\tif (!RocketChat.authz.hasPermission(this.userId, 'view-livechat-manager')) {\n\t\t\treturn RocketChat.API.v1.unauthorized();\n\t\t}\n\n\t\ttry {\n\t\t\tcheck(this.urlParams, {\n\t\t\t\ttype: String,\n\t\t\t\t_id: String,\n\t\t\t});\n\n\t\t\tconst user = RocketChat.models.Users.findOneById(this.urlParams._id);\n\n\t\t\tif (!user) {\n\t\t\t\treturn RocketChat.API.v1.failure('User not found');\n\t\t\t}\n\n\t\t\tlet role;\n\n\t\t\tif (this.urlParams.type === 'agent') {\n\t\t\t\trole = 'livechat-agent';\n\t\t\t} else if (this.urlParams.type === 'manager') {\n\t\t\t\trole = 'livechat-manager';\n\t\t\t} else {\n\t\t\t\tthrow 'Invalid type';\n\t\t\t}\n\n\t\t\tif (user.roles.indexOf(role) !== -1) {\n\t\t\t\treturn RocketChat.API.v1.success({\n\t\t\t\t\tuser: _.pick(user, '_id', 'username'),\n\t\t\t\t});\n\t\t\t}\n\n\t\t\treturn RocketChat.API.v1.success({\n\t\t\t\tuser: null,\n\t\t\t});\n\t\t} catch (e) {\n\t\t\treturn RocketChat.API.v1.failure(e.error);\n\t\t}\n\t},\n\tdelete() {\n\t\tif (!RocketChat.authz.hasPermission(this.userId, 'view-livechat-manager')) {\n\t\t\treturn RocketChat.API.v1.unauthorized();\n\t\t}\n\n\t\ttry {\n\t\t\tcheck(this.urlParams, {\n\t\t\t\ttype: String,\n\t\t\t\t_id: String,\n\t\t\t});\n\n\t\t\tconst user = RocketChat.models.Users.findOneById(this.urlParams._id);\n\n\t\t\tif (!user) {\n\t\t\t\treturn RocketChat.API.v1.failure();\n\t\t\t}\n\n\t\t\tif (this.urlParams.type === 'agent') {\n\t\t\t\tif (RocketChat.Livechat.removeAgent(user.username)) {\n\t\t\t\t\treturn RocketChat.API.v1.success();\n\t\t\t\t}\n\t\t\t} else if (this.urlParams.type === 'manager') {\n\t\t\t\tif (RocketChat.Livechat.removeManager(user.username)) {\n\t\t\t\t\treturn RocketChat.API.v1.success();\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tthrow 'Invalid type';\n\t\t\t}\n\n\t\t\treturn RocketChat.API.v1.failure();\n\t\t} catch (e) {\n\t\t\treturn RocketChat.API.v1.failure(e.error);\n\t\t}\n\t},\n});\n"]}