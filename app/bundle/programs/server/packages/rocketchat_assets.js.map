{"version":3,"sources":["meteor://ðŸ’»app/packages/rocketchat:assets/server/assets.js"],"names":["_","module","watch","require","default","v","sizeOf","mime","crypto","sharp","extensions","RocketChatAssetsInstance","RocketChatFile","GridFS","name","assets","logo","label","defaultUrl","constraints","type","width","undefined","height","wizard","step","order","background","favicon_ico","favicon","favicon_16","favicon_32","favicon_192","favicon_512","touchicon_180","touchicon_180_pre","tile_70","tile_144","tile_150","tile_310_square","tile_310_wide","safari_pinned","RocketChat","Assets","setAsset","binaryContent","contentType","asset","Meteor","Error","function","extension","includes","errorTitle","file","Buffer","dimensions","rs","bufferToStream","deleteFile","ws","createWriteStream","on","bindEnvironment","setTimeout","key","value","url","settings","updateById","processAsset","pipe","unsetAsset","refreshClients","process","emit","refresh","settingKey","settingValue","indexOf","assetKey","replace","assetValue","cache","getFileSync","hash","createHash","update","buffer","digest","split","pop","path","cacheable","sourceMapUrl","where","content","size","length","uploadDate","getURL","assetName","options","cdn","full","get","addGroup","add","group","i18nLabel","addAssetToSetting","fileConstraints","public","currentValue","Object","keys","models","Settings","find","observe","added","record","_id","changed","removed","startup","calculateClientHash","WebAppHashing","manifest","includeFilter","runtimeConfigOverride","WebAppInternals","staticFiles","manifestItem","findWhere","index","push","call","methods","userId","method","hasPermission","authz","action","WebApp","connectHandlers","use","req","res","next","params","decodeURIComponent","format","assetUrl","staticFilesMiddleware","writeHead","end","reqModifiedHeader","headers","toUTCString","setHeader","toFormat","Date"],"mappings":"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","file":"/packages/rocketchat_assets.js","sourcesContent":["/* global WebAppHashing, WebAppInternals */\nimport _ from 'underscore';\n\nimport sizeOf from 'image-size';\nimport mime from 'mime-type/with-db';\nimport crypto from 'crypto';\nimport sharp from 'sharp';\n\nmime.extensions['image/vnd.microsoft.icon'] = ['ico'];\n\nconst RocketChatAssetsInstance = new RocketChatFile.GridFS({\n\tname: 'assets',\n});\n\nthis.RocketChatAssetsInstance = RocketChatAssetsInstance;\n\nconst assets = {\n\tlogo: {\n\t\tlabel: 'logo (svg, png, jpg)',\n\t\tdefaultUrl: 'images/logo/logo.svg',\n\t\tconstraints: {\n\t\t\ttype: 'image',\n\t\t\textensions: ['svg', 'png', 'jpg', 'jpeg'],\n\t\t\twidth: undefined,\n\t\t\theight: undefined,\n\t\t},\n\t\twizard: {\n\t\t\tstep: 3,\n\t\t\torder: 2,\n\t\t},\n\t},\n\tbackground: {\n\t\tlabel: 'login background (svg, png, jpg)',\n\t\tdefaultUrl: undefined,\n\t\tconstraints: {\n\t\t\ttype: 'image',\n\t\t\textensions: ['svg', 'png', 'jpg', 'jpeg'],\n\t\t\twidth: undefined,\n\t\t\theight: undefined,\n\t\t},\n\t},\n\tfavicon_ico: {\n\t\tlabel: 'favicon (ico)',\n\t\tdefaultUrl: 'favicon.ico',\n\t\tconstraints: {\n\t\t\ttype: 'image',\n\t\t\textensions: ['ico'],\n\t\t\twidth: undefined,\n\t\t\theight: undefined,\n\t\t},\n\t},\n\tfavicon: {\n\t\tlabel: 'favicon (svg)',\n\t\tdefaultUrl: 'images/logo/icon.svg',\n\t\tconstraints: {\n\t\t\ttype: 'image',\n\t\t\textensions: ['svg'],\n\t\t\twidth: undefined,\n\t\t\theight: undefined,\n\t\t},\n\t},\n\tfavicon_16: {\n\t\tlabel: 'favicon 16x16 (png)',\n\t\tdefaultUrl: 'images/logo/favicon-16x16.png',\n\t\tconstraints: {\n\t\t\ttype: 'image',\n\t\t\textensions: ['png'],\n\t\t\twidth: 16,\n\t\t\theight: 16,\n\t\t},\n\t},\n\tfavicon_32: {\n\t\tlabel: 'favicon 32x32 (png)',\n\t\tdefaultUrl: 'images/logo/favicon-32x32.png',\n\t\tconstraints: {\n\t\t\ttype: 'image',\n\t\t\textensions: ['png'],\n\t\t\twidth: 32,\n\t\t\theight: 32,\n\t\t},\n\t},\n\tfavicon_192: {\n\t\tlabel: 'android-chrome 192x192 (png)',\n\t\tdefaultUrl: 'images/logo/android-chrome-192x192.png',\n\t\tconstraints: {\n\t\t\ttype: 'image',\n\t\t\textensions: ['png'],\n\t\t\twidth: 192,\n\t\t\theight: 192,\n\t\t},\n\t},\n\tfavicon_512: {\n\t\tlabel: 'android-chrome 512x512 (png)',\n\t\tdefaultUrl: 'images/logo/android-chrome-512x512.png',\n\t\tconstraints: {\n\t\t\ttype: 'image',\n\t\t\textensions: ['png'],\n\t\t\twidth: 512,\n\t\t\theight: 512,\n\t\t},\n\t},\n\ttouchicon_180: {\n\t\tlabel: 'apple-touch-icon 180x180 (png)',\n\t\tdefaultUrl: 'images/logo/apple-touch-icon.png',\n\t\tconstraints: {\n\t\t\ttype: 'image',\n\t\t\textensions: ['png'],\n\t\t\twidth: 180,\n\t\t\theight: 180,\n\t\t},\n\t},\n\ttouchicon_180_pre: {\n\t\tlabel: 'apple-touch-icon-precomposed 180x180 (png)',\n\t\tdefaultUrl: 'images/logo/apple-touch-icon-precomposed.png',\n\t\tconstraints: {\n\t\t\ttype: 'image',\n\t\t\textensions: ['png'],\n\t\t\twidth: 180,\n\t\t\theight: 180,\n\t\t},\n\t},\n\ttile_70: {\n\t\tlabel: 'mstile 70x70 (png)',\n\t\tdefaultUrl: 'images/logo/mstile-70x70.png',\n\t\tconstraints: {\n\t\t\ttype: 'image',\n\t\t\textensions: ['png'],\n\t\t\twidth: 144,\n\t\t\theight: 144,\n\t\t},\n\t},\n\ttile_144: {\n\t\tlabel: 'mstile 144x144 (png)',\n\t\tdefaultUrl: 'images/logo/mstile-144x144.png',\n\t\tconstraints: {\n\t\t\ttype: 'image',\n\t\t\textensions: ['png'],\n\t\t\twidth: 144,\n\t\t\theight: 144,\n\t\t},\n\t},\n\ttile_150: {\n\t\tlabel: 'mstile 150x150 (png)',\n\t\tdefaultUrl: 'images/logo/mstile-150x150.png',\n\t\tconstraints: {\n\t\t\ttype: 'image',\n\t\t\textensions: ['png'],\n\t\t\twidth: 150,\n\t\t\theight: 150,\n\t\t},\n\t},\n\ttile_310_square: {\n\t\tlabel: 'mstile 310x310 (png)',\n\t\tdefaultUrl: 'images/logo/mstile-310x310.png',\n\t\tconstraints: {\n\t\t\ttype: 'image',\n\t\t\textensions: ['png'],\n\t\t\twidth: 310,\n\t\t\theight: 310,\n\t\t},\n\t},\n\ttile_310_wide: {\n\t\tlabel: 'mstile 310x150 (png)',\n\t\tdefaultUrl: 'images/logo/mstile-310x150.png',\n\t\tconstraints: {\n\t\t\ttype: 'image',\n\t\t\textensions: ['png'],\n\t\t\twidth: 310,\n\t\t\theight: 150,\n\t\t},\n\t},\n\tsafari_pinned: {\n\t\tlabel: 'safari pinned tab (svg)',\n\t\tdefaultUrl: 'images/logo/safari-pinned-tab.svg',\n\t\tconstraints: {\n\t\t\ttype: 'image',\n\t\t\textensions: ['svg'],\n\t\t\twidth: undefined,\n\t\t\theight: undefined,\n\t\t},\n\t},\n};\n\nRocketChat.Assets = new (class {\n\tget mime() {\n\t\treturn mime;\n\t}\n\n\tget assets() {\n\t\treturn assets;\n\t}\n\n\tsetAsset(binaryContent, contentType, asset) {\n\t\tif (!assets[asset]) {\n\t\t\tthrow new Meteor.Error('error-invalid-asset', 'Invalid asset', {\n\t\t\t\tfunction: 'RocketChat.Assets.setAsset',\n\t\t\t});\n\t\t}\n\n\t\tconst extension = mime.extension(contentType);\n\t\tif (assets[asset].constraints.extensions.includes(extension) === false) {\n\t\t\tthrow new Meteor.Error(contentType, `Invalid file type: ${ contentType }`, {\n\t\t\t\tfunction: 'RocketChat.Assets.setAsset',\n\t\t\t\terrorTitle: 'error-invalid-file-type',\n\t\t\t});\n\t\t}\n\n\t\tconst file = new Buffer(binaryContent, 'binary');\n\t\tif (assets[asset].constraints.width || assets[asset].constraints.height) {\n\t\t\tconst dimensions = sizeOf(file);\n\t\t\tif (assets[asset].constraints.width && assets[asset].constraints.width !== dimensions.width) {\n\t\t\t\tthrow new Meteor.Error('error-invalid-file-width', 'Invalid file width', {\n\t\t\t\t\tfunction: 'Invalid file width',\n\t\t\t\t});\n\t\t\t}\n\t\t\tif (assets[asset].constraints.height && assets[asset].constraints.height !== dimensions.height) {\n\t\t\t\tthrow new Meteor.Error('error-invalid-file-height');\n\t\t\t}\n\t\t}\n\n\t\tconst rs = RocketChatFile.bufferToStream(file);\n\t\tRocketChatAssetsInstance.deleteFile(asset);\n\n\t\tconst ws = RocketChatAssetsInstance.createWriteStream(asset, contentType);\n\t\tws.on('end', Meteor.bindEnvironment(function() {\n\t\t\treturn Meteor.setTimeout(function() {\n\t\t\t\tconst key = `Assets_${ asset }`;\n\t\t\t\tconst value = {\n\t\t\t\t\turl: `assets/${ asset }.${ extension }`,\n\t\t\t\t\tdefaultUrl: assets[asset].defaultUrl,\n\t\t\t\t};\n\n\t\t\t\tRocketChat.settings.updateById(key, value);\n\t\t\t\treturn RocketChat.Assets.processAsset(key, value);\n\t\t\t}, 200);\n\t\t}));\n\n\t\trs.pipe(ws);\n\t}\n\n\tunsetAsset(asset) {\n\t\tif (!assets[asset]) {\n\t\t\tthrow new Meteor.Error('error-invalid-asset', 'Invalid asset', {\n\t\t\t\tfunction: 'RocketChat.Assets.unsetAsset',\n\t\t\t});\n\t\t}\n\n\t\tRocketChatAssetsInstance.deleteFile(asset);\n\t\tconst key = `Assets_${ asset }`;\n\t\tconst value = {\n\t\t\tdefaultUrl: assets[asset].defaultUrl,\n\t\t};\n\n\t\tRocketChat.settings.updateById(key, value);\n\t\tRocketChat.Assets.processAsset(key, value);\n\t}\n\n\trefreshClients() {\n\t\treturn process.emit('message', {\n\t\t\trefresh: 'client',\n\t\t});\n\t}\n\n\tprocessAsset(settingKey, settingValue) {\n\t\tif (settingKey.indexOf('Assets_') !== 0) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst assetKey = settingKey.replace(/^Assets_/, '');\n\t\tconst assetValue = assets[assetKey];\n\n\t\tif (!assetValue) {\n\t\t\treturn;\n\t\t}\n\n\t\tif (!settingValue || !settingValue.url) {\n\t\t\tassetValue.cache = undefined;\n\t\t\treturn;\n\t\t}\n\n\t\tconst file = RocketChatAssetsInstance.getFileSync(assetKey);\n\t\tif (!file) {\n\t\t\tassetValue.cache = undefined;\n\t\t\treturn;\n\t\t}\n\n\t\tconst hash = crypto.createHash('sha1').update(file.buffer).digest('hex');\n\t\tconst extension = settingValue.url.split('.').pop();\n\n\t\treturn assetValue.cache = {\n\t\t\tpath: `assets/${ assetKey }.${ extension }`,\n\t\t\tcacheable: false,\n\t\t\tsourceMapUrl: undefined,\n\t\t\twhere: 'client',\n\t\t\ttype: 'asset',\n\t\t\tcontent: file.buffer,\n\t\t\textension,\n\t\t\turl: `/assets/${ assetKey }.${ extension }?${ hash }`,\n\t\t\tsize: file.length,\n\t\t\tuploadDate: file.uploadDate,\n\t\t\tcontentType: file.contentType,\n\t\t\thash,\n\t\t};\n\t}\n\n\tgetURL(assetName, options = { cdn: false, full: true }) {\n\t\tconst asset = RocketChat.settings.get(assetName);\n\t\tconst url = asset.url || asset.defaultUrl;\n\n\t\treturn RocketChat.getURL(url, options);\n\t}\n});\n\nRocketChat.settings.addGroup('Assets');\n\nRocketChat.settings.add('Assets_SvgFavicon_Enable', true, {\n\ttype: 'boolean',\n\tgroup: 'Assets',\n\ti18nLabel: 'Enable_Svg_Favicon',\n});\n\nfunction addAssetToSetting(asset, value) {\n\tconst key = `Assets_${ asset }`;\n\n\tRocketChat.settings.add(key, {\n\t\tdefaultUrl: value.defaultUrl,\n\t}, {\n\t\ttype: 'asset',\n\t\tgroup: 'Assets',\n\t\tfileConstraints: value.constraints,\n\t\ti18nLabel: value.label,\n\t\tasset,\n\t\tpublic: true,\n\t\twizard: value.wizard,\n\t});\n\n\tconst currentValue = RocketChat.settings.get(key);\n\n\tif (typeof currentValue === 'object' && currentValue.defaultUrl !== assets[asset].defaultUrl) {\n\t\tcurrentValue.defaultUrl = assets[asset].defaultUrl;\n\t\tRocketChat.settings.updateById(key, currentValue);\n\t}\n}\n\nfor (const key of Object.keys(assets)) {\n\tconst value = assets[key];\n\taddAssetToSetting(key, value);\n}\n\nRocketChat.models.Settings.find().observe({\n\tadded(record) {\n\t\treturn RocketChat.Assets.processAsset(record._id, record.value);\n\t},\n\n\tchanged(record) {\n\t\treturn RocketChat.Assets.processAsset(record._id, record.value);\n\t},\n\n\tremoved(record) {\n\t\treturn RocketChat.Assets.processAsset(record._id, undefined);\n\t},\n});\n\nMeteor.startup(function() {\n\treturn Meteor.setTimeout(function() {\n\t\treturn process.emit('message', {\n\t\t\trefresh: 'client',\n\t\t});\n\t}, 200);\n});\n\nconst { calculateClientHash } = WebAppHashing;\n\nWebAppHashing.calculateClientHash = function(manifest, includeFilter, runtimeConfigOverride) {\n\tfor (const key of Object.keys(assets)) {\n\t\tconst value = assets[key];\n\t\tif (!value.cache && !value.defaultUrl) {\n\t\t\tcontinue;\n\t\t}\n\n\t\tlet cache = {};\n\t\tif (value.cache) {\n\t\t\tcache = {\n\t\t\t\tpath: value.cache.path,\n\t\t\t\tcacheable: value.cache.cacheable,\n\t\t\t\tsourceMapUrl: value.cache.sourceMapUrl,\n\t\t\t\twhere: value.cache.where,\n\t\t\t\ttype: value.cache.type,\n\t\t\t\turl: value.cache.url,\n\t\t\t\tsize: value.cache.size,\n\t\t\t\thash: value.cache.hash,\n\t\t\t};\n\t\t\tWebAppInternals.staticFiles[`/__cordova/assets/${ key }`] = value.cache;\n\t\t\tWebAppInternals.staticFiles[`/__cordova/assets/${ key }.${ value.cache.extension }`] = value.cache;\n\t\t} else {\n\t\t\tconst extension = value.defaultUrl.split('.').pop();\n\t\t\tcache = {\n\t\t\t\tpath: `assets/${ key }.${ extension }`,\n\t\t\t\tcacheable: false,\n\t\t\t\tsourceMapUrl: undefined,\n\t\t\t\twhere: 'client',\n\t\t\t\ttype: 'asset',\n\t\t\t\turl: `/assets/${ key }.${ extension }?v3`,\n\t\t\t\thash: 'v3',\n\t\t\t};\n\n\t\t\tWebAppInternals.staticFiles[`/__cordova/assets/${ key }`] = WebAppInternals.staticFiles[`/__cordova/${ value.defaultUrl }`];\n\t\t\tWebAppInternals.staticFiles[`/__cordova/assets/${ key }.${ extension }`] = WebAppInternals.staticFiles[`/__cordova/${ value.defaultUrl }`];\n\t\t}\n\n\t\tconst manifestItem = _.findWhere(manifest, {\n\t\t\tpath: key,\n\t\t});\n\n\t\tif (manifestItem) {\n\t\t\tconst index = manifest.indexOf(manifestItem);\n\t\t\tmanifest[index] = cache;\n\t\t} else {\n\t\t\tmanifest.push(cache);\n\t\t}\n\t}\n\n\treturn calculateClientHash.call(this, manifest, includeFilter, runtimeConfigOverride);\n};\n\nMeteor.methods({\n\trefreshClients() {\n\t\tif (!Meteor.userId()) {\n\t\t\tthrow new Meteor.Error('error-invalid-user', 'Invalid user', {\n\t\t\t\tmethod: 'refreshClients',\n\t\t\t});\n\t\t}\n\n\t\tconst hasPermission = RocketChat.authz.hasPermission(Meteor.userId(), 'manage-assets');\n\t\tif (!hasPermission) {\n\t\t\tthrow new Meteor.Error('error-action-not-allowed', 'Managing assets not allowed', {\n\t\t\t\tmethod: 'refreshClients',\n\t\t\t\taction: 'Managing_assets',\n\t\t\t});\n\t\t}\n\n\t\treturn RocketChat.Assets.refreshClients();\n\t},\n\n\tunsetAsset(asset) {\n\t\tif (!Meteor.userId()) {\n\t\t\tthrow new Meteor.Error('error-invalid-user', 'Invalid user', {\n\t\t\t\tmethod: 'unsetAsset',\n\t\t\t});\n\t\t}\n\n\t\tconst hasPermission = RocketChat.authz.hasPermission(Meteor.userId(), 'manage-assets');\n\t\tif (!hasPermission) {\n\t\t\tthrow new Meteor.Error('error-action-not-allowed', 'Managing assets not allowed', {\n\t\t\t\tmethod: 'unsetAsset',\n\t\t\t\taction: 'Managing_assets',\n\t\t\t});\n\t\t}\n\n\t\treturn RocketChat.Assets.unsetAsset(asset);\n\t},\n\n\tsetAsset(binaryContent, contentType, asset) {\n\t\tif (!Meteor.userId()) {\n\t\t\tthrow new Meteor.Error('error-invalid-user', 'Invalid user', {\n\t\t\t\tmethod: 'setAsset',\n\t\t\t});\n\t\t}\n\n\t\tconst hasPermission = RocketChat.authz.hasPermission(Meteor.userId(), 'manage-assets');\n\t\tif (!hasPermission) {\n\t\t\tthrow new Meteor.Error('error-action-not-allowed', 'Managing assets not allowed', {\n\t\t\t\tmethod: 'setAsset',\n\t\t\t\taction: 'Managing_assets',\n\t\t\t});\n\t\t}\n\n\t\tRocketChat.Assets.setAsset(binaryContent, contentType, asset);\n\t},\n});\n\nWebApp.connectHandlers.use('/assets/', Meteor.bindEnvironment(function(req, res, next) {\n\tconst params = {\n\t\tasset: decodeURIComponent(req.url.replace(/^\\//, '').replace(/\\?.*$/, '')).replace(/\\.[^.]*$/, ''),\n\t};\n\n\tconst file = assets[params.asset] && assets[params.asset].cache;\n\n\tconst format = req.url.replace(/.*\\.([a-z]+)$/, '$1');\n\n\tif (!file) {\n\t\tconst defaultUrl = assets[params.asset] && assets[params.asset].defaultUrl;\n\t\tif (defaultUrl) {\n\t\t\tconst assetUrl = format && ['png', 'svg'].includes(format) ? defaultUrl.replace(/(svg|png)$/, format) : defaultUrl;\n\t\t\treq.url = `/${ assetUrl }`;\n\t\t\tWebAppInternals.staticFilesMiddleware(WebAppInternals.staticFiles, req, res, next);\n\t\t} else {\n\t\t\tres.writeHead(404);\n\t\t\tres.end();\n\t\t}\n\n\t\treturn;\n\t}\n\n\tconst reqModifiedHeader = req.headers['if-modified-since'];\n\tif (reqModifiedHeader) {\n\t\tif (reqModifiedHeader === (file.uploadDate && file.uploadDate.toUTCString())) {\n\t\t\tres.setHeader('Last-Modified', reqModifiedHeader);\n\t\t\tres.writeHead(304);\n\t\t\tres.end();\n\t\t\treturn;\n\t\t}\n\t}\n\n\tres.setHeader('Cache-Control', 'public, max-age=0');\n\tres.setHeader('Expires', '-1');\n\n\tif (format && format !== file.extension && ['png', 'jpg', 'jpeg'].includes(format)) {\n\t\tres.setHeader('Content-Type', `image/${ format }`);\n\t\tsharp(file.content)\n\t\t\t.toFormat(format)\n\t\t\t.pipe(res);\n\t\treturn;\n\t}\n\n\tres.setHeader('Last-Modified', (file.uploadDate && file.uploadDate.toUTCString()) || new Date().toUTCString());\n\tres.setHeader('Content-Type', file.contentType);\n\tres.setHeader('Content-Length', file.size);\n\tres.writeHead(200);\n\tres.end(file.content);\n}));\n"]}