{"version":3,"sources":["meteor://ðŸ’»app/packages/rocketchat:importer/server/classes/ImporterBase.js","meteor://ðŸ’»app/packages/rocketchat:importer/server/classes/ImporterProgress.js","meteor://ðŸ’»app/packages/rocketchat:importer/server/classes/ImporterSelection.js","meteor://ðŸ’»app/packages/rocketchat:importer/server/classes/ImporterSelectionChannel.js","meteor://ðŸ’»app/packages/rocketchat:importer/server/classes/ImporterSelectionUser.js","meteor://ðŸ’»app/packages/rocketchat:importer/server/classes/ImporterWebsocket.js","meteor://ðŸ’»app/packages/rocketchat:importer/server/models/Imports.js","meteor://ðŸ’»app/packages/rocketchat:importer/server/models/RawImports.js","meteor://ðŸ’»app/packages/rocketchat:importer/server/methods/getImportProgress.js","meteor://ðŸ’»app/packages/rocketchat:importer/server/methods/getSelectionData.js","meteor://ðŸ’»app/packages/rocketchat:importer/server/methods/prepareImport.js","meteor://ðŸ’»app/packages/rocketchat:importer/server/methods/restartImport.js","meteor://ðŸ’»app/packages/rocketchat:importer/server/methods/setupImporter.js","meteor://ðŸ’»app/packages/rocketchat:importer/server/methods/startImport.js","meteor://ðŸ’»app/packages/rocketchat:importer/server/startup/setImportsToInvalid.js","meteor://ðŸ’»app/packages/rocketchat:importer/server/index.js","meteor://ðŸ’»app/packages/rocketchat:importer/lib/ImporterInfo.js","meteor://ðŸ’»app/packages/rocketchat:importer/lib/ImporterProgressStep.js","meteor://ðŸ’»app/packages/rocketchat:importer/lib/Importers.js"],"names":["module","export","Base","Progress","watch","require","v","ProgressStep","Selection","Imports","ImporterInfo","RawImports","ImporterWebsocket","http","default","https","AdmZip","getFileType","getBSONSize","item","BSON","bson","calculateObjectSize","getMaxBSONSize","getBSONSafeArraysFromAnArray","theArray","BSONSize","maxSize","Math","floor","length","ceil","safeArrays","i","push","slice","constructor","info","Error","prepare","bind","startImport","getSelection","getProgress","updateProgress","addCountToTotal","addCountCompleted","updateRecord","uploadFile","logger","Logger","name","progress","key","collection","importId","insert","type","ts","Date","now","status","step","valid","user","Meteor","_id","importRecord","findOne","users","channels","messages","oldSettings","debug","dataURI","sentContentType","fileName","skipTypeCheck","fileType","Buffer","split","mimeType","mime","warn","ERROR","PREPARING_STARTED","file","importSelection","undefined","IMPORTING_STARTED","Accounts_AllowedDomainsList","RocketChat","models","Settings","findOneById","value","updateValueById","Accounts_AllowUsernameChange","FileUpload_MaxFileSize","DONE","progressUpdated","count","total","completed","fields","update","$set","details","fileUrl","room","timeStamp","requestModule","test","fileStore","FileUpload","getStore","get","bindEnvironment","res","contentType","headers","rawData","on","chunk","concat","err","url","replace","absoluteUrl","attachment","title","title_link","image_url","image_type","image_size","size","image_dimensions","identify","audio_url","audio_type","audio_size","video_url","video_type","video_size","msg","rid","groupable","attachments","message_id","sendMessage","NEW","message_count","SelectionChannel","channel_id","is_archived","do_import","is_private","SelectionUser","user_id","username","email","is_deleted","is_bot","ImporterWebsocketDef","streamer","Streamer","retransmit","allowRead","allowEmit","allowWrite","emit","ImportsModel","_Base","RawImportsModel","Importers","methods","getImportProgress","userId","method","authz","hasPermission","importer","instance","getSelectionData","USER_SELECTION","prepareImport","check","String","results","Promise","catch","e","restartImport","CANCELLED","setupImporter","console","input","usersSelection","map","channelsSelection","channel","selection","startup","$ne","multi","model","rawCollection","drop","log","warnings","Object","freeze","PREPARING_USERS","PREPARING_CHANNELS","PREPARING_MESSAGES","IMPORTING_USERS","IMPORTING_CHANNELS","IMPORTING_MESSAGES","FINISHING","ImportersContainer","importers","Map","add","set","getAll","Array","from","values"],"mappings":"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","file":"/packages/rocketchat_importer.js","sourcesContent":["import { Progress } from './ImporterProgress';\nimport { ProgressStep } from '../../lib/ImporterProgressStep';\nimport { Selection } from './ImporterSelection';\nimport { Imports } from '../models/Imports';\nimport { ImporterInfo } from '../../lib/ImporterInfo';\nimport { RawImports } from '../models/RawImports';\nimport { ImporterWebsocket } from './ImporterWebsocket';\n\nimport http from 'http';\nimport https from 'https';\nimport AdmZip from 'adm-zip';\nimport getFileType from 'file-type';\n\n/**\n * Base class for all of the importers.\n */\nexport class Base {\n\t/**\n\t * The max BSON object size we can store in MongoDB is 16777216 bytes\n\t * but for some reason the mongo instanace which comes with Meteor\n\t * errors out for anything close to that size. So, we are rounding it\n\t * down to 8000000 bytes.\n\t *\n\t * @param {any} item The item to calculate the BSON size of.\n\t * @returns {number} The size of the item passed in.\n\t * @static\n\t */\n\tstatic getBSONSize(item) {\n\t\tconst { BSON } = require('bson');\n\t\tconst bson = new BSON();\n\t\treturn bson.calculateObjectSize(item);\n\t}\n\n\t/**\n\t * The max BSON object size we can store in MongoDB is 16777216 bytes\n\t * but for some reason the mongo instanace which comes with Meteor\n\t * errors out for anything close to that size. So, we are rounding it\n\t * down to 8000000 bytes.\n\t *\n\t * @returns {number} 8000000 bytes.\n\t */\n\tstatic getMaxBSONSize() {\n\t\treturn 8000000;\n\t}\n\n\t/**\n\t * Splits the passed in array to at least one array which has a size that\n\t * is safe to store in the database.\n\t *\n\t * @param {any[]} theArray The array to split out\n\t * @returns {any[][]} The safe sized arrays\n\t * @static\n\t */\n\tstatic getBSONSafeArraysFromAnArray(theArray) {\n\t\tconst BSONSize = Base.getBSONSize(theArray);\n\t\tconst maxSize = Math.floor(theArray.length / (Math.ceil(BSONSize / Base.getMaxBSONSize())));\n\t\tconst safeArrays = [];\n\t\tlet i = 0;\n\t\twhile (i < theArray.length) {\n\t\t\tsafeArrays.push(theArray.slice(i, (i += maxSize)));\n\t\t}\n\t\treturn safeArrays;\n\t}\n\n\t/**\n\t * Constructs a new importer, adding an empty collection, AdmZip property, and empty users & channels\n\t *\n\t * @param {string} name The importer's name.\n\t * @param {string} description The i18n string which describes the importer\n\t * @param {string} mimeType The expected file type.\n\t */\n\tconstructor(info) {\n\t\tif (!(info instanceof ImporterInfo)) {\n\t\t\tthrow new Error('Information passed in must be a valid ImporterInfo instance.');\n\t\t}\n\n\t\tthis.http = http;\n\t\tthis.https = https;\n\t\tthis.AdmZip = AdmZip;\n\t\tthis.getFileType = getFileType;\n\n\t\tthis.prepare = this.prepare.bind(this);\n\t\tthis.startImport = this.startImport.bind(this);\n\t\tthis.getSelection = this.getSelection.bind(this);\n\t\tthis.getProgress = this.getProgress.bind(this);\n\t\tthis.updateProgress = this.updateProgress.bind(this);\n\t\tthis.addCountToTotal = this.addCountToTotal.bind(this);\n\t\tthis.addCountCompleted = this.addCountCompleted.bind(this);\n\t\tthis.updateRecord = this.updateRecord.bind(this);\n\t\tthis.uploadFile = this.uploadFile.bind(this);\n\n\t\tthis.info = info;\n\n\t\tthis.logger = new Logger(`${ this.info.name } Importer`, {});\n\t\tthis.progress = new Progress(this.info.key, this.info.name);\n\t\tthis.collection = RawImports;\n\n\t\tconst importId = Imports.insert({ type: this.info.name, ts: Date.now(), status: this.progress.step, valid: true, user: Meteor.user()._id });\n\t\tthis.importRecord = Imports.findOne(importId);\n\n\t\tthis.users = {};\n\t\tthis.channels = {};\n\t\tthis.messages = {};\n\t\tthis.oldSettings = {};\n\n\t\tthis.logger.debug(`Constructed a new ${ info.name } Importer.`);\n\t}\n\n\t/**\n\t * Takes the uploaded file and extracts the users, channels, and messages from it.\n\t *\n\t * @param {string} dataURI Base64 string of the uploaded file\n\t * @param {string} sentContentType The sent file type.\n\t * @param {string} fileName The name of the uploaded file.\n\t * @param {boolean} skipTypeCheck Optional property that says to not check the type provided.\n\t * @returns {Progress} The progress record of the import.\n\t */\n\tprepare(dataURI, sentContentType, fileName, skipTypeCheck) {\n\t\tif (!skipTypeCheck) {\n\t\t\tconst fileType = this.getFileType(new Buffer(dataURI.split(',')[1], 'base64'));\n\t\t\tthis.logger.debug('Uploaded file information is:', fileType);\n\t\t\tthis.logger.debug('Expected file type is:', this.info.mimeType);\n\n\t\t\tif (!fileType || (fileType.mime !== this.info.mimeType)) {\n\t\t\t\tthis.logger.warn(`Invalid file uploaded for the ${ this.info.name } importer.`);\n\t\t\t\tthis.updateProgress(ProgressStep.ERROR);\n\t\t\t\tthrow new Meteor.Error('error-invalid-file-uploaded', `Invalid file uploaded to import ${ this.info.name } data from.`, { step: 'prepare' });\n\t\t\t}\n\t\t}\n\n\t\tthis.updateProgress(ProgressStep.PREPARING_STARTED);\n\t\treturn this.updateRecord({ file: fileName });\n\t}\n\n\t/**\n\t * Starts the import process. The implementing method should defer\n\t * as soon as the selection is set, so the user who started the process\n\t * doesn't end up with a \"locked\" UI while Meteor waits for a response.\n\t * The returned object should be the progress.\n\t *\n\t * @param {Selection} importSelection The selection data.\n\t * @returns {Progress} The progress record of the import.\n\t */\n\tstartImport(importSelection) {\n\t\tif (!(importSelection instanceof Selection)) {\n\t\t\tthrow new Error(`Invalid Selection data provided to the ${ this.info.name } importer.`);\n\t\t} else if (importSelection.users === undefined) {\n\t\t\tthrow new Error(`Users in the selected data wasn't found, it must but at least an empty array for the ${ this.info.name } importer.`);\n\t\t} else if (importSelection.channels === undefined) {\n\t\t\tthrow new Error(`Channels in the selected data wasn't found, it must but at least an empty array for the ${ this.info.name } importer.`);\n\t\t}\n\n\t\treturn this.updateProgress(ProgressStep.IMPORTING_STARTED);\n\t}\n\n\t/**\n\t * Gets the Selection object for the import.\n\t *\n\t * @returns {Selection} The users and channels selection\n\t */\n\tgetSelection() {\n\t\tthrow new Error(`Invalid 'getSelection' called on ${ this.info.name }, it must be overridden and super can not be called.`);\n\t}\n\n\t/**\n\t * Gets the progress of this import.\n\t *\n\t * @returns {Progress} The progress record of the import.\n\t */\n\tgetProgress() {\n\t\treturn this.progress;\n\t}\n\n\t/**\n\t * Updates the progress step of this importer.\n\t * It also changes some internal settings at various stages of the import.\n\t * This way the importer can adjust user/room information at will.\n\t *\n\t * @param {ProgressStep} step The progress step which this import is currently at.\n\t * @returns {Progress} The progress record of the import.\n\t */\n\tupdateProgress(step) {\n\t\tthis.progress.step = step;\n\n\t\tswitch (step) {\n\t\t\tcase ProgressStep.IMPORTING_STARTED:\n\t\t\t\tthis.oldSettings.Accounts_AllowedDomainsList = RocketChat.models.Settings.findOneById('Accounts_AllowedDomainsList').value;\n\t\t\t\tRocketChat.models.Settings.updateValueById('Accounts_AllowedDomainsList', '');\n\n\t\t\t\tthis.oldSettings.Accounts_AllowUsernameChange = RocketChat.models.Settings.findOneById('Accounts_AllowUsernameChange').value;\n\t\t\t\tRocketChat.models.Settings.updateValueById('Accounts_AllowUsernameChange', true);\n\n\t\t\t\tthis.oldSettings.FileUpload_MaxFileSize = RocketChat.models.Settings.findOneById('FileUpload_MaxFileSize').value;\n\t\t\t\tRocketChat.models.Settings.updateValueById('FileUpload_MaxFileSize', -1);\n\t\t\t\tbreak;\n\t\t\tcase ProgressStep.DONE:\n\t\t\tcase ProgressStep.ERROR:\n\t\t\t\tRocketChat.models.Settings.updateValueById('Accounts_AllowedDomainsList', this.oldSettings.Accounts_AllowedDomainsList);\n\t\t\t\tRocketChat.models.Settings.updateValueById('Accounts_AllowUsernameChange', this.oldSettings.Accounts_AllowUsernameChange);\n\t\t\t\tRocketChat.models.Settings.updateValueById('FileUpload_MaxFileSize', this.oldSettings.FileUpload_MaxFileSize);\n\t\t\t\tbreak;\n\t\t}\n\n\t\tthis.logger.debug(`${ this.info.name } is now at ${ step }.`);\n\t\tthis.updateRecord({ status: this.progress.step });\n\n\t\tImporterWebsocket.progressUpdated(this.progress);\n\n\t\treturn this.progress;\n\t}\n\n\t/**\n\t * Adds the passed in value to the total amount of items needed to complete.\n\t *\n\t * @param {number} count The amount to add to the total count of items.\n\t * @returns {Progress} The progress record of the import.\n\t */\n\taddCountToTotal(count) {\n\t\tthis.progress.count.total = this.progress.count.total + count;\n\t\tthis.updateRecord({ 'count.total': this.progress.count.total });\n\n\t\treturn this.progress;\n\t}\n\n\t/**\n\t * Adds the passed in value to the total amount of items completed.\n\t *\n\t * @param {number} count The amount to add to the total count of finished items.\n\t * @returns {Progress} The progress record of the import.\n\t */\n\taddCountCompleted(count) {\n\t\tthis.progress.count.completed = this.progress.count.completed + count;\n\n\t\t// Only update the database every 500 records\n\t\t// Or the completed is greater than or equal to the total amount\n\t\tif (((this.progress.count.completed % 500) === 0) || (this.progress.count.completed >= this.progress.count.total)) {\n\t\t\tthis.updateRecord({ 'count.completed': this.progress.count.completed });\n\t\t}\n\n\t\tImporterWebsocket.progressUpdated(this.progress);\n\n\t\treturn this.progress;\n\t}\n\n\t/**\n\t * Updates the import record with the given fields being `set`.\n\t *\n\t * @param {any} fields The fields to set, it should be an object with key/values.\n\t * @returns {Imports} The import record.\n\t */\n\tupdateRecord(fields) {\n\t\tImports.update({ _id: this.importRecord._id }, { $set: fields });\n\t\tthis.importRecord = Imports.findOne(this.importRecord._id);\n\n\t\treturn this.importRecord;\n\t}\n\n\t/**\n\t * Uploads the file to the storage.\n\t *\n\t * @param {any} details An object with details about the upload: `name`, `size`, `type`, and `rid`.\n\t * @param {string} fileUrl Url of the file to download/import.\n\t * @param {any} user The Rocket.Chat user.\n\t * @param {any} room The Rocket.Chat Room.\n\t * @param {Date} timeStamp The timestamp the file was uploaded\n\t */\n\tuploadFile(details, fileUrl, user, room, timeStamp) {\n\t\tthis.logger.debug(`Uploading the file ${ details.name } from ${ fileUrl }.`);\n\t\tconst requestModule = /https/i.test(fileUrl) ? this.https : this.http;\n\n\t\tconst fileStore = FileUpload.getStore('Uploads');\n\n\t\treturn requestModule.get(fileUrl, Meteor.bindEnvironment(function(res) {\n\t\t\tconst contentType = res.headers['content-type'];\n\t\t\tif (!details.type && contentType) {\n\t\t\t\tdetails.type = contentType;\n\t\t\t}\n\n\t\t\tconst rawData = [];\n\t\t\tres.on('data', (chunk) => rawData.push(chunk));\n\t\t\tres.on('end', Meteor.bindEnvironment(() => {\n\t\t\t\tfileStore.insert(details, Buffer.concat(rawData), function(err, file) {\n\t\t\t\t\tif (err) {\n\t\t\t\t\t\tthrow new Error(err);\n\t\t\t\t\t} else {\n\t\t\t\t\t\tconst url = file.url.replace(Meteor.absoluteUrl(), '/');\n\n\t\t\t\t\t\tconst attachment = {\n\t\t\t\t\t\t\ttitle: file.name,\n\t\t\t\t\t\t\ttitle_link: url,\n\t\t\t\t\t\t};\n\n\t\t\t\t\t\tif (/^image\\/.+/.test(file.type)) {\n\t\t\t\t\t\t\tattachment.image_url = url;\n\t\t\t\t\t\t\tattachment.image_type = file.type;\n\t\t\t\t\t\t\tattachment.image_size = file.size;\n\t\t\t\t\t\t\tattachment.image_dimensions = file.identify != null ? file.identify.size : undefined;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tif (/^audio\\/.+/.test(file.type)) {\n\t\t\t\t\t\t\tattachment.audio_url = url;\n\t\t\t\t\t\t\tattachment.audio_type = file.type;\n\t\t\t\t\t\t\tattachment.audio_size = file.size;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tif (/^video\\/.+/.test(file.type)) {\n\t\t\t\t\t\t\tattachment.video_url = url;\n\t\t\t\t\t\t\tattachment.video_type = file.type;\n\t\t\t\t\t\t\tattachment.video_size = file.size;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tconst msg = {\n\t\t\t\t\t\t\trid: details.rid,\n\t\t\t\t\t\t\tts: timeStamp,\n\t\t\t\t\t\t\tmsg: '',\n\t\t\t\t\t\t\tfile: {\n\t\t\t\t\t\t\t\t_id: file._id,\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\tgroupable: false,\n\t\t\t\t\t\t\tattachments: [attachment],\n\t\t\t\t\t\t};\n\n\t\t\t\t\t\tif ((details.message_id != null) && (typeof details.message_id === 'string')) {\n\t\t\t\t\t\t\tmsg._id = details.message_id;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\treturn RocketChat.sendMessage(user, msg, room, true);\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t}));\n\t\t}));\n\t}\n}\n","import { ProgressStep } from '../../lib/ImporterProgressStep';\n\nexport class Progress {\n\t/**\n\t * Creates a new progress container for the importer.\n\t *\n\t * @param {string} key The unique key of the importer.\n\t * @param {string} name The name of the importer.\n\t */\n\tconstructor(key, name) {\n\t\tthis.key = key;\n\t\tthis.name = name;\n\t\tthis.step = ProgressStep.NEW;\n\t\tthis.count = { completed: 0, total: 0 };\n\t}\n}\n","export class Selection {\n\t/**\n\t * Constructs a new importer selection object.\n\t *\n\t * @param {string} name the name of the importer\n\t * @param {SelectionUser[]} users the users which can be selected\n\t * @param {SelectionChannel[]} channels the channels which can be selected\n\t * @param {number} message_count the number of messages\n\t */\n\tconstructor(name, users, channels, message_count) {\n\t\tthis.name = name;\n\t\tthis.users = users;\n\t\tthis.channels = channels;\n\t\tthis.message_count = message_count;\n\t}\n}\n","export class SelectionChannel {\n\t/**\n\t * Constructs a new selection channel.\n\t *\n\t * @param {string} channel_id the unique identifier of the channel\n\t * @param {string} name the name of the channel\n\t * @param {boolean} is_archived whether the channel was archived or not\n\t * @param {boolean} do_import whether we will be importing the channel or not\n\t * @param {boolean} is_private whether the channel is private or public\n\t */\n\tconstructor(channel_id, name, is_archived, do_import, is_private) {\n\t\tthis.channel_id = channel_id;\n\t\tthis.name = name;\n\t\tthis.is_archived = is_archived;\n\t\tthis.do_import = do_import;\n\t\tthis.is_private = is_private;\n\t}\n}\n","export class SelectionUser {\n\t/**\n\t * Constructs a new selection user.\n\t *\n\t * @param {string} user_id the unique user identifier\n\t * @param {string} username the user's username\n\t * @param {string} email the user's email\n\t * @param {boolean} is_deleted whether the user was deleted or not\n\t * @param {boolean} is_bot whether the user is a bot or not\n\t * @param {boolean} do_import whether we are going to import this user or not\n\t */\n\tconstructor(user_id, username, email, is_deleted, is_bot, do_import) {\n\t\tthis.user_id = user_id;\n\t\tthis.username = username;\n\t\tthis.email = email;\n\t\tthis.is_deleted = is_deleted;\n\t\tthis.is_bot = is_bot;\n\t\tthis.do_import = do_import;\n\t}\n}\n","class ImporterWebsocketDef {\n\tconstructor() {\n\t\tthis.streamer = new Meteor.Streamer('importers', { retransmit: false });\n\t\tthis.streamer.allowRead('all');\n\t\tthis.streamer.allowEmit('all');\n\t\tthis.streamer.allowWrite('none');\n\t}\n\n\t/**\n\t * Called when the progress is updated.\n\t *\n\t * @param {Progress} progress The progress of the import.\n\t */\n\tprogressUpdated(progress) {\n\t\tthis.streamer.emit('progress', progress);\n\t}\n}\n\nexport const ImporterWebsocket = new ImporterWebsocketDef();\n","class ImportsModel extends RocketChat.models._Base {\n\tconstructor() {\n\t\tsuper('import');\n\t}\n}\n\nexport const Imports = new ImportsModel();\n","class RawImportsModel extends RocketChat.models._Base {\n\tconstructor() {\n\t\tsuper('raw_imports');\n\t}\n}\n\nexport const RawImports = new RawImportsModel();\n","import { Importers } from 'meteor/rocketchat:importer';\n\nMeteor.methods({\n\tgetImportProgress(key) {\n\t\tif (!Meteor.userId()) {\n\t\t\tthrow new Meteor.Error('error-invalid-user', 'Invalid user', { method: 'getImportProgress' });\n\t\t}\n\n\t\tif (!RocketChat.authz.hasPermission(Meteor.userId(), 'run-import')) {\n\t\t\tthrow new Meteor.Error('error-action-not-allowed', 'Importing is not allowed', { method: 'setupImporter' });\n\t\t}\n\n\t\tconst importer = Importers.get(key);\n\n\t\tif (!importer) {\n\t\t\tthrow new Meteor.Error('error-importer-not-defined', `The importer (${ key }) has no import class defined.`, { method: 'getImportProgress' });\n\t\t}\n\n\t\tif (!importer.instance) {\n\t\t\treturn undefined;\n\t\t}\n\n\t\treturn importer.instance.getProgress();\n\t},\n});\n","import {\n\tImporters,\n\tProgressStep,\n} from 'meteor/rocketchat:importer';\n\nMeteor.methods({\n\tgetSelectionData(key) {\n\t\tif (!Meteor.userId()) {\n\t\t\tthrow new Meteor.Error('error-invalid-user', 'Invalid user', { method: 'getSelectionData' });\n\t\t}\n\n\t\tif (!RocketChat.authz.hasPermission(Meteor.userId(), 'run-import')) {\n\t\t\tthrow new Meteor.Error('error-action-not-allowed', 'Importing is not allowed', { method: 'setupImporter' });\n\t\t}\n\n\t\tconst importer = Importers.get(key);\n\n\t\tif (!importer || !importer.instance) {\n\t\t\tthrow new Meteor.Error('error-importer-not-defined', `The importer (${ key }) has no import class defined.`, { method: 'getSelectionData' });\n\t\t}\n\n\t\tconst progress = importer.instance.getProgress();\n\n\t\tswitch (progress.step) {\n\t\t\tcase ProgressStep.USER_SELECTION:\n\t\t\t\treturn importer.instance.getSelection();\n\t\t\tdefault:\n\t\t\t\treturn undefined;\n\t\t}\n\t},\n});\n","import { Importers } from 'meteor/rocketchat:importer';\n\nMeteor.methods({\n\tprepareImport(key, dataURI, contentType, fileName) {\n\t\tif (!Meteor.userId()) {\n\t\t\tthrow new Meteor.Error('error-invalid-user', 'Invalid user', { method: 'prepareImport' });\n\t\t}\n\n\t\tif (!RocketChat.authz.hasPermission(Meteor.userId(), 'run-import')) {\n\t\t\tthrow new Meteor.Error('error-action-not-allowed', 'Importing is not allowed', { method: 'setupImporter' });\n\t\t}\n\n\t\tcheck(key, String);\n\t\tcheck(dataURI, String);\n\t\tcheck(fileName, String);\n\n\t\tconst importer = Importers.get(key);\n\n\t\tif (!importer) {\n\t\t\tthrow new Meteor.Error('error-importer-not-defined', `The importer (${ key }) has no import class defined.`, { method: 'prepareImport' });\n\t\t}\n\n\t\tconst results = importer.instance.prepare(dataURI, contentType, fileName);\n\n\t\tif (results instanceof Promise) {\n\t\t\treturn results.catch((e) => { throw new Meteor.Error(e); });\n\t\t} else {\n\t\t\treturn results;\n\t\t}\n\t},\n});\n","import {\n\tImporters,\n\tProgressStep,\n} from 'meteor/rocketchat:importer';\n\nMeteor.methods({\n\trestartImport(key) {\n\t\tif (!Meteor.userId()) {\n\t\t\tthrow new Meteor.Error('error-invalid-user', 'Invalid user', { method: 'restartImport' });\n\t\t}\n\n\t\tif (!RocketChat.authz.hasPermission(Meteor.userId(), 'run-import')) {\n\t\t\tthrow new Meteor.Error('error-action-not-allowed', 'Importing is not allowed', { method: 'setupImporter' });\n\t\t}\n\n\t\tconst importer = Importers.get(key);\n\n\t\tif (!importer) {\n\t\t\tthrow new Meteor.Error('error-importer-not-defined', `The importer (${ key }) has no import class defined.`, { method: 'restartImport' });\n\t\t}\n\n\t\tif (importer.instance) {\n\t\t\timporter.instance.updateProgress(ProgressStep.CANCELLED);\n\t\t\timporter.instance.updateRecord({ valid: false });\n\t\t\timporter.instance = undefined;\n\t\t}\n\n\t\timporter.instance = new importer.importer(importer); // eslint-disable-line new-cap\n\t\treturn importer.instance.getProgress();\n\t},\n});\n","import { Importers } from 'meteor/rocketchat:importer';\n\nMeteor.methods({\n\tsetupImporter(key) {\n\t\tif (!Meteor.userId()) {\n\t\t\tthrow new Meteor.Error('error-invalid-user', 'Invalid user', { method: 'setupImporter' });\n\t\t}\n\n\t\tif (!RocketChat.authz.hasPermission(Meteor.userId(), 'run-import')) {\n\t\t\tthrow new Meteor.Error('error-action-not-allowed', 'Importing is not allowed', { method: 'setupImporter' });\n\t\t}\n\n\t\tconst importer = Importers.get(key);\n\n\t\tif (!importer) {\n\t\t\tconsole.warn(`Tried to setup ${ name } as an importer.`);\n\t\t\tthrow new Meteor.Error('error-importer-not-defined', 'The importer was not defined correctly, it is missing the Import class.', { method: 'setupImporter' });\n\t\t}\n\n\t\tif (importer.instance) {\n\t\t\treturn importer.instance.getProgress();\n\t\t}\n\n\t\timporter.instance = new importer.importer(importer); // eslint-disable-line new-cap\n\t\treturn importer.instance.getProgress();\n\t},\n});\n","import {\n\tImporters,\n\tSelection,\n\tSelectionChannel,\n\tSelectionUser,\n} from 'meteor/rocketchat:importer';\n\nMeteor.methods({\n\tstartImport(key, input) {\n\t\t// Takes name and object with users / channels selected to import\n\t\tif (!Meteor.userId()) {\n\t\t\tthrow new Meteor.Error('error-invalid-user', 'Invalid user', { method: 'startImport' });\n\t\t}\n\n\t\tif (!RocketChat.authz.hasPermission(Meteor.userId(), 'run-import')) {\n\t\t\tthrow new Meteor.Error('error-action-not-allowed', 'Importing is not allowed', { method: 'startImport' });\n\t\t}\n\n\t\tif (!key) {\n\t\t\tthrow new Meteor.Error('error-invalid-importer', `No defined importer by: \"${ key }\"`, { method: 'startImport' });\n\t\t}\n\n\t\tconst importer = Importers.get(key);\n\n\t\tif (!importer || !importer.instance) {\n\t\t\tthrow new Meteor.Error('error-importer-not-defined', `The importer (${ key }) has no import class defined.`, { method: 'startImport' });\n\t\t}\n\n\t\tconst usersSelection = input.users.map((user) => new SelectionUser(user.user_id, user.username, user.email, user.is_deleted, user.is_bot, user.do_import));\n\t\tconst channelsSelection = input.channels.map((channel) => new SelectionChannel(channel.channel_id, channel.name, channel.is_archived, channel.do_import));\n\n\t\tconst selection = new Selection(importer.name, usersSelection, channelsSelection);\n\t\treturn importer.instance.startImport(selection);\n\t},\n});\n","import { Imports } from '../models/Imports';\nimport { RawImports } from '../models/RawImports';\n\nMeteor.startup(function() {\n\t// Make sure all imports are marked as invalid, data clean up since you can't\n\t// restart an import at the moment.\n\tImports.update({ valid: { $ne: false } }, { $set: { valid: false } }, { multi: true });\n\n\t// Clean up all the raw import data, since you can't restart an import at the moment\n\ttry {\n\t\tRawImports.model.rawCollection().drop();\n\t} catch (e) {\n\t\tconsole.log('errror', e); // TODO: Remove\n\t\t// ignored\n\t}\n});\n","import { Base } from './classes/ImporterBase';\nimport { Imports } from './models/Imports';\nimport { Importers } from '../lib/Importers';\nimport { ImporterInfo } from '../lib/ImporterInfo';\nimport { ImporterWebsocket } from './classes/ImporterWebsocket';\nimport { Progress } from './classes/ImporterProgress';\nimport { ProgressStep } from '../lib/ImporterProgressStep';\nimport { RawImports } from './models/RawImports';\nimport { Selection } from './classes/ImporterSelection';\nimport { SelectionChannel } from './classes/ImporterSelectionChannel';\nimport { SelectionUser } from './classes/ImporterSelectionUser';\n\nexport {\n\tBase,\n\tImports,\n\tImporters,\n\tImporterInfo,\n\tImporterWebsocket,\n\tProgress,\n\tProgressStep,\n\tRawImports,\n\tSelection,\n\tSelectionChannel,\n\tSelectionUser,\n};\n","export class ImporterInfo {\n\t/**\n\t * Creates a new class which contains information about the importer.\n\t *\n\t * @param {string} key The unique key of this importer.\n\t * @param {string} name The i18n name.\n\t * @param {string} mimeType The type of file it expects.\n\t * @param {{ href: string, text: string }[]} warnings An array of warning objects. `{ href, text }`\n\t */\n\tconstructor(key, name = '', mimeType = '', warnings = []) {\n\t\tthis.key = key;\n\t\tthis.name = name;\n\t\tthis.mimeType = mimeType;\n\t\tthis.warnings = warnings;\n\n\t\tthis.importer = undefined;\n\t\tthis.instance = undefined;\n\t}\n}\n","/** The progress step that an importer is at. */\nexport const ProgressStep = Object.freeze({\n\tNEW: 'importer_new',\n\tPREPARING_STARTED: 'importer_preparing_started',\n\tPREPARING_USERS: 'importer_preparing_users',\n\tPREPARING_CHANNELS: 'importer_preparing_channels',\n\tPREPARING_MESSAGES: 'importer_preparing_messages',\n\tUSER_SELECTION: 'importer_user_selection',\n\tIMPORTING_STARTED: 'importer_importing_started',\n\tIMPORTING_USERS: 'importer_importing_users',\n\tIMPORTING_CHANNELS: 'importer_importing_channels',\n\tIMPORTING_MESSAGES: 'importer_importing_messages',\n\tFINISHING: 'importer_finishing',\n\tDONE: 'importer_done',\n\tERROR: 'importer_import_failed',\n\tCANCELLED: 'importer_import_cancelled',\n});\n","import { ImporterInfo } from './ImporterInfo';\n\n/** Container class which holds all of the importer details. */\nclass ImportersContainer {\n\tconstructor() {\n\t\tthis.importers = new Map();\n\t}\n\n\t/**\n\t * Adds an importer to the import collection. Adding it more than once will\n\t * overwrite the previous one.\n\t *\n\t * @param {ImporterInfo} info The information related to the importer.\n\t * @param {*} importer The class for the importer, will be undefined on the client.\n\t */\n\tadd(info, importer) {\n\t\tif (!(info instanceof ImporterInfo)) {\n\t\t\tthrow new Error('The importer must be a valid ImporterInfo instance.');\n\t\t}\n\n\t\tinfo.importer = importer;\n\n\t\tthis.importers.set(info.key, info);\n\n\t\treturn this.importers.get(info.key);\n\t}\n\n\t/**\n\t * Gets the importer information that is stored.\n\t *\n\t * @param {string} key The key of the importer.\n\t */\n\tget(key) {\n\t\treturn this.importers.get(key);\n\t}\n\n\t/**\n\t * Gets all of the importers in array format.\n\t *\n\t * @returns {ImporterInfo[]} The array of importer information.\n\t */\n\tgetAll() {\n\t\treturn Array.from(this.importers.values());\n\t}\n}\n\nexport const Importers = new ImportersContainer();\n"]}