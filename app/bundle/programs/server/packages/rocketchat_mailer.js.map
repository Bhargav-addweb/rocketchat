{"version":3,"sources":["meteor://ðŸ’»app/packages/rocketchat:mailer/server/api.js"],"names":["module","export","replacekey","translate","replace","replaceEscaped","wrap","inlinecss","getTemplate","getTemplateWrapped","setSettings","rfcMailPatternWithName","checkAddressFormat","sendNoWrap","send","checkAddressFormatAndThrow","getHeader","getFooter","_","watch","require","default","v","s","juice","contentHeader","contentFooter","body","Settings","get","str","key","value","RegExp","match","TAPi18n","__","data","options","Site_Name","Site_URL","Site_URL_Slash","name","fname","strLeft","lname","strRightBack","Object","entries","reduce","ret","escapeHTML","RocketChat","settings","Site_Url","html","inlineContent","template","fn","escape","wrapInlineCSS","debounce","from","test","to","subject","Meteor","defer","Email","func","Error","function"],"mappings":"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","file":"/packages/rocketchat_mailer.js","sourcesContent":["import _ from 'underscore';\nimport s from 'underscore.string';\nimport juice from 'juice';\nlet contentHeader;\nlet contentFooter;\n\nlet body;\nlet Settings = {\n\tget: () => {},\n};\n\nexport const replacekey = (str, key, value = '') => str.replace(new RegExp(`(\\\\[${ key }\\\\]|__${ key }__)`, 'igm'), value);\n\nexport const translate = (str) => str.replace(/\\{ ?([^\\} ]+)(( ([^\\}]+))+)? ?\\}/gmi, (match, key) => TAPi18n.__(key));\nexport const replace = function replace(str, data = {}) {\n\tif (!str) {\n\t\treturn '';\n\t}\n\tconst options = {\n\t\tSite_Name: Settings.get('Site_Name'),\n\t\tSite_URL: Settings.get('Site_Url'),\n\t\tSite_URL_Slash: Settings.get('Site_Url').replace(/\\/?$/, '/'),\n\t\t...(data.name && {\n\t\t\tfname: s.strLeft(data.name, ' '),\n\t\t\tlname: s.strRightBack(data.name, ' '),\n\t\t}),\n\t\t...data,\n\t};\n\treturn Object.entries(options).reduce((ret, [key, value]) => replacekey(ret, key, value), translate(str));\n};\n\nexport const replaceEscaped = (str, data = {}) => replace(str, {\n\tSite_Name: s.escapeHTML(RocketChat.settings.get('Site_Name')),\n\tSite_Url: s.escapeHTML(RocketChat.settings.get('Site_Url')),\n\t...Object.entries(data).reduce((ret, [key, value]) => {\n\t\tret[key] = s.escapeHTML(value);\n\t\treturn ret;\n\t}, {}),\n});\nexport const wrap = (html, data = {}) => replaceEscaped(body.replace('{{body}}', html), data);\nexport const inlinecss = (html) => juice.inlineContent(html, Settings.get('email_style'));\nexport const getTemplate = (template, fn, escape = true) => {\n\tlet html = '';\n\tSettings.get(template, (key, value) => {\n\t\thtml = value || '';\n\t\tfn(escape ? inlinecss(html) : html);\n\t});\n\tSettings.get('email_style', () => {\n\t\tfn(escape ? inlinecss(html) : html);\n\t});\n};\nexport const getTemplateWrapped = (template, fn) => {\n\tlet html = '';\n\tconst wrapInlineCSS = _.debounce(() => fn(wrap(inlinecss(html))), 100);\n\n\tSettings.get('Email_Header', () => html && wrapInlineCSS());\n\tSettings.get('Email_Footer', () => html && wrapInlineCSS());\n\tSettings.get('email_style', () => html && wrapInlineCSS());\n\tSettings.get(template, (key, value) => {\n\t\thtml = value || '';\n\t\treturn html && wrapInlineCSS();\n\t});\n};\nexport const setSettings = (s) => {\n\tSettings = s;\n\n\tgetTemplate('Email_Header', (value) => {\n\t\tcontentHeader = replace(value || '');\n\t\tbody = inlinecss(`${ contentHeader } {{body}} ${ contentFooter }`);\n\t}, false);\n\n\tgetTemplate('Email_Footer', (value) => {\n\t\tcontentFooter = replace(value || '');\n\t\tbody = inlinecss(`${ contentHeader } {{body}} ${ contentFooter }`);\n\t}, false);\n\n\tbody = inlinecss(`${ contentHeader } {{body}} ${ contentFooter }`);\n};\n\nexport const rfcMailPatternWithName = /^(?:.*<)?([a-zA-Z0-9.!#$%&'*+\\/=?^_`{|}~-]+@[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(?:\\.[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)*)(?:>?)$/;\n\nexport const checkAddressFormat = (from) => rfcMailPatternWithName.test(from);\n\nexport const sendNoWrap = ({ to, from, subject, html }) => {\n\tif (!checkAddressFormat(to)) {\n\t\treturn;\n\t}\n\tMeteor.defer(() => Email.send({ to, from, subject, html }));\n};\n\nexport const send = ({ to, from, subject, html, data }) => sendNoWrap({ to, from, subject: replace(subject, data), html: wrap(html, data) });\n\nexport const checkAddressFormatAndThrow = (from, func) => {\n\tif (checkAddressFormat(from)) {\n\t\treturn true;\n\t}\n\tthrow new Meteor.Error('error-invalid-from-address', 'Invalid from address', {\n\t\tfunction: func,\n\t});\n};\n\nexport const getHeader = () => contentHeader;\n\nexport const getFooter = () => contentFooter;\n"]}